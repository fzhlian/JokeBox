"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.commonPlugin=void 0;const path_1=__importDefault(require("path")),hvigor_arkts_base_1=require("@ohos/hvigor-arkts-base"),fs_extra_1=__importDefault(require("fs-extra")),compile_event_factory_js_1=require("../analyzer/compile-event-factory.js"),compose_error_js_1=require("../data/compose-error.js"),constants_js_1=require("../util/constants.js"),utils_js_1=require("../util/utils.js"),import_resolver_js_1=require("./node-resolve/import-resolver.js"),DEP_INFO_CACHE_FILE="dep_info.json",LOGGER=hvigor_arkts_base_1.ArktsBaseLogger.getLogger("commonPlugin");function commonPlugin(e,o){let r=!0,t=!1;return{name:"commonPlugin",options(){this.share.projectConfig=e,this.share.getLogger=hvigor_arkts_base_1.ArktsBaseLogger.getPluginLogger,this.share.getHvigorConsoleLogger=hvigor_arkts_base_1.ArktsBaseLogger.getHvigorConsoleLogger,this.share.throwArkTsCompilerError=compose_error_js_1.throwArkTsCompilerError,this.share.getHookEventFactory=e.perf===constants_js_1.AnalyzeMode.VERBOSE||e.perf===constants_js_1.AnalyzeMode.TRACE?compile_event_factory_js_1.CompileEventFactory.getHookEventFactory:getBogusHookEventFactory,this.share.getSourceFiles=loadSdkGetModuleSourceFilesFunc(e.etsLoaderPath),this.share.importResolver=new import_resolver_js_1.ImportResolver(e.depName2DepInfo,!!e.caseSensitiveCheck).resolve,t=!!e.needCoverageInsert,this.share.getHashByFilePath=e=>(0,hvigor_arkts_base_1.getHashByFilePath)(e),this.share.setHashValueByFilePath=(e,o)=>(0,hvigor_arkts_base_1.setHashValueByFilePath)(e,o),(0,utils_js_1.isLinux)()||e.runtimeOS===constants_js_1.OPEN_HARMONY||e.isFaMode||(e.apiVersion>=constants_js_1.API_VERSION_11&&(this.share.cacheStoreManager=o,this.share.cache=e.compileEnv?o?.mount(e.compileEnv):void 0),this.share.commonCache=o?.mount(constants_js_1.TSC_COMMON_CACHE_KEY,!0),this.share.recordErrorFileId=e=>{hvigor_arkts_base_1.ArktsBaseLogger.recordErrorFileId(e)})},beforeBuild(){(!r||e.isPreview&&!fs_extra_1.default.existsSync(e.buildDir))&&(r=!1,(0,compose_error_js_1.throwArkTsCompilerError)("Please restart previewer."));const{resolveConflictMode:o,depName2RootPath:t,depName2DepInfo:s}=readDepInfoCache(this);this.share.depInfo=getDepInfo(e.resolveConflictMode,o,e.depName2RootPath,t,e.depName2DepInfo,s),writeDepInfoCache(e.resolveConflictMode,e.depName2RootPath,e.depName2DepInfo,e.cachePath,this)},beforeBuildEnd:{order:"post",async handler(){throwErrorIfHasErrorInfo(e.watchMode)}},transform(r,s){s.endsWith("?commonjs-entry")?this.share.projectConfig.needCoverageInsert=!1:this.share.projectConfig.needCoverageInsert=t,hvigor_arkts_base_1.rollupCacheService.deleteModuleCache(s,e.cachePath,o,e.compileEnv)}}}function readDepInfoCache(e){const o={resolveConflictMode:void 0,depName2RootPath:void 0,depName2DepInfo:void 0},r=e.cache.get(DEP_INFO_CACHE_FILE);if(!r)return o;let t,s;return r?.depName2RootPath&&(t=new Map,Object.keys(r.depName2RootPath).forEach((e=>t?.set(e,r.depName2RootPath[e])))),r?.depName2DepInfo&&(s=new Map,Object.keys(r.depName2DepInfo).forEach((e=>s?.set(e,r.depName2DepInfo[e])))),{resolveConflictMode:r?.resolveConflictMode,depName2RootPath:t,depName2DepInfo:s}}function writeDepInfoCache(e,o,r,t,s){const a={resolveConflictMode:e,depName2RootPath:o?.size?{}:void 0,depName2DepInfo:r?.size?{}:void 0};if(o.forEach(((e,o)=>a.depName2RootPath[o]=e)),r.forEach(((e,o)=>a.depName2DepInfo[o]=e)),s.cache.set(DEP_INFO_CACHE_FILE,a),!t)return;const n=path_1.default.resolve(t,DEP_INFO_CACHE_FILE);fs_extra_1.default.ensureFileSync(n),fs_extra_1.default.writeJSONSync(n,a)}function getDepInfo(e,o,r,t,s,a){if(void 0===o)return{enableIncre:!1,changedDeps:[]};if(e&&o){const e=[];return r.forEach(((o,r)=>{t?.get(r)&&t?.get(r)!==o&&e.push({name:r,lastRootPath:t?.get(r)})})),s.forEach(((o,r)=>{const t=a?.get(r);t&&o.pkgName===t.pkgName&&o.pkgVersion!==t.pkgVersion&&e.push({name:r,lastRootPath:t.pkgRootPath})})),t?.forEach(((o,t)=>{r.has(t)||e.push({name:t,lastRootPath:o})})),{enableIncre:!0,changedDeps:e}}return{enableIncre:!1,changedDeps:[]}}function getBogusHookEventFactory(){const e=()=>{},o=()=>({start:e,stop:e,startAsyncEvent:e,stopAsyncEvent:e,createSubEvent:o});return{createEvent:o}}function throwErrorIfHasErrorInfo(e){hvigor_arkts_base_1.ArktsBaseLogger.checkLoggerHaveErrorInfo()&&"true"!==e&&(0,compose_error_js_1.throwArkTsCompilerError)("ArkTS Compiler Error")}function loadSdkGetModuleSourceFilesFunc(e){const o=path_1.default.join(e,"lib","fast_build","ark_compiler","module","module_source_file.js");if(fs_extra_1.default.existsSync(o))try{return require(o).ModuleSourceFile.getSourceFiles}catch(e){return void LOGGER.debug(`load getSourceFiles failed ${e}.`)}else LOGGER.debug(`${o} not exists.`)}exports.commonPlugin=commonPlugin;