"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.invalidCachePlugin=void 0;const path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_common_1=require("@ohos/hvigor-common"),fs_extra_1=__importDefault(require("fs-extra")),json5_1=__importDefault(require("json5")),arkts_pack_js_1=require("../arkts-pack.js"),constants_js_1=require("../util/constants.js"),utils_js_1=require("../util/utils.js"),module_meta_info_plugin_js_1=require("./module-meta-info-plugin.js");let allPlugins;const OLD_HAR_NAME_OHM_MAP="oldHarNameOhmMap",CUR_HAR_NAME_OHM_MAP="curHarNameOhmMap",PKG_JSON_FILE_HASH="pkgJsonFileHash",NEW_OHM_URL_HASH="newOhmUrlHash",ROUTER_MAP_HASH="routerMapHash",CASE_SENSITIVE_CHECK="caseSensitiveCheck",MODULE_DEPS="moduleDeps",PROJECT_ARK_OPTION="projectArkOption",TS_IMPORT_SENDABLE="tsImportSendable",PROJECT_OH_PACKAGE="projectDevDept",OHOS_UI_TRANSFORM_OPTIMIZATION="ohos.uiTransform.Optimization",BUNDLE_NAME="bundleName",IS_BYTE_CODE_HAR_OPTIMIZE="isByteCodeHarOptimize",PRELOAD_SO_FILE_SET="preloadSoFileSet",depCache=new Map;let inCIEnv=!1,isPreloadSoFileSetChanged=!1;function invalidCachePlugin(){return{name:"invalidCachePlugin",buildStart:buildStart,shouldTransformCachedModule:shouldTransformCachedModule,buildEnd:buildEnd,beforeBuild:beforeBuild,beforeBuildEnd:beforeBuildEnd,cleanUp(){depCache.clear()}}}function comparePreloadFileSet(e){const t=e.share.projectConfig;if(!(0,utils_js_1.allowToPreloadSo)(t))return!1;const o=t?.needPreloadSoFileSet||new Set,a=e.cache.get(PRELOAD_SO_FILE_SET)||[];if(a.length!==o.size)return!0;for(const e of a)if(!o.has(e))return!0;return!1}function setProjectConfigCache(e){const t=e.share?.projectConfig,o=t?.projectArkOption?.tscConfig?.targetESVersion;o&&e.cache.set(PROJECT_ARK_OPTION,o),t?.routerMap&&e.cache.set(ROUTER_MAP_HASH,t?.routerMap),e.cache.set(OLD_HAR_NAME_OHM_MAP,e.cache.get(CUR_HAR_NAME_OHM_MAP)),e.cache.delete(CUR_HAR_NAME_OHM_MAP),e.cache.set(NEW_OHM_URL_HASH,!!t?.useNormalizedOHMUrl),e.cache.set(CASE_SENSITIVE_CHECK,t?.caseSensitiveCheck),e.cache.set(TS_IMPORT_SENDABLE,t?.tsImportSendable),e.cache.set(IS_BYTE_CODE_HAR_OPTIMIZE,t?.isByteCodeHarOptimize??!1)}function buildEnd(){setProjectConfigCache(this);const e=new Map;for(const t of this.getModuleIds()){const o=this.getModuleInfo(t);e.set(t,o?o.importedIds.concat(o.dynamicallyImportedIds):[])}this.cache.set(MODULE_DEPS,e);const t=this.share?.projectConfig,o=t?.mockParams?.mockConfigPath;if(o&&fs_extra_1.default.existsSync(o)){const e=(0,hvigor_common_1.hash)(fs_extra_1.default.readFileSync(o));this.cache.set(o,e)}(0,utils_js_1.allowToPreloadSo)(t)?this.cache.set(PRELOAD_SO_FILE_SET,[...t?.needPreloadSoFileSet||[]]):this.cache.delete(PRELOAD_SO_FILE_SET)}function beforeBuildEnd(){const e=this.share?.projectConfig;e?.pkgJsonFileHash&&this.cache.set(PKG_JSON_FILE_HASH,e?.pkgJsonFileHash),setUserConfigCache(this),this.cache.set(PROJECT_OH_PACKAGE,this.share?.projectDevDept),this.cache.set(OHOS_UI_TRANSFORM_OPTIMIZATION,this.share?.projectConfig?.uiTransformOptimization),this.cache.set(BUNDLE_NAME,this.share?.projectConfig?.bundleName)}function buildStart({plugins:e}){const t=this.share?.projectConfig?.mockParams?.mockConfigPath;if(t&&fs_extra_1.default.existsSync(t)){const e=this.cache?.get(t),o=(0,hvigor_common_1.hash)(fs_extra_1.default.readFileSync(t));this.share.projectConfig.mockParams.isMockConfigChanged=o!==e}else this.share?.projectConfig?.mockParams&&(this.share.projectConfig.mockParams.isMockConfigChanged=!1);inCIEnv=(0,hvigor_common_1.isCI)(),isPreloadSoFileSetChanged=comparePreloadFileSet(this);const o=(0,arkts_pack_js_1.loadAceBuildJson)(this.share?.projectConfig?.aceBuildJson).hspNameOhmMap;this.cache.set(CUR_HAR_NAME_OHM_MAP,o),allPlugins=[],allPlugins.push(...e),allPlugins=allPlugins.filter((e=>"object"==typeof e&&(e.shouldInvalidCache??!1)))}function beforeBuild(){if(this.share?.projectConfig?.projectTopDir){const e=path_1.default.resolve(this.share.projectConfig.projectTopDir,"oh-package.json5"),t=fs_extra_1.default.readFileSync(e,"utf-8");this.share.projectDevDept=json5_1.default.parse(t)?.devDependencies||{}}}function setUserConfigCache(e){e.share?.projectConfig?.userProjectConfig&&Object.entries(e.share?.projectConfig?.userProjectConfig).forEach((([t,o])=>{e.cache.set(t,o)}))}function preCheckShouldTransform(e){let t;e.share?.projectConfig?.userProjectConfig&&(t=Object.entries(e.share?.projectConfig?.userProjectConfig).some((([t,o])=>!(0,wdk_1.isEqual)(e.cache.get(t),o))));const o=e.share?.projectConfig?.projectArkOption?.tscConfig?.targetESVersion!==e.cache.get(PROJECT_ARK_OPTION),a=e.share?.projectConfig?.tsImportSendable!==!!e.cache.get(TS_IMPORT_SENDABLE);return t||o||a}function isHarNameOhmChanged(e){const t=e.cache.get(OLD_HAR_NAME_OHM_MAP),o=e.cache.get(CUR_HAR_NAME_OHM_MAP);if(t&&o)for(const e of Object.keys(o))if(t[e]&&o[e]!==t[e])return!0;return!1}function isByteCodeHarOptimizeChanged(e){return(e.cache.get(IS_BYTE_CODE_HAR_OPTIMIZE)??!1)!==(e.share?.projectConfig?.isByteCodeHarOptimize??!1)}function isPkgJsonFileChanged(e){return e.share?.projectConfig?.pkgJsonFileHash!==e.cache.get(PKG_JSON_FILE_HASH)}async function isPluginsHasInvalidCache(e,t){const o=await Promise.all(allPlugins.map((o=>o.shouldInvalidCache.apply(e,[t]))));let a=!1;return o.forEach((e=>{e&&"boolean"==typeof e&&(a||(a=e))})),a}async function shouldTransformCachedModule(e){if(localTestHasChangedMockConfig(this))return!0;if(!(0,wdk_1.isEqual)(this.cache?.get(PROJECT_OH_PACKAGE)??{},this.share?.projectDevDept??{}))return!0;if(isPkgJsonFileChanged(this)&&(inCIEnv||!this.share?.projectConfig?.resolveConflictMode))return!0;if(preCheckShouldTransform(this))return!0;if(isHarNameOhmChanged(this))return!0;if(isModulePkgNameChanged(e))return!0;if(bundleNameHasChanged(this))return!0;if(isByteCodeHarOptimizeChanged(this))return!0;if(isPreloadSoFileSetChanged)return!0;return await isPluginsHasInvalidCache(this,e)||hasHookEventChangedDeps(this,e)}function localTestHasChangedMockConfig(e){return!(!e?.share?.projectConfig?.isLocalTest||!e.share.projectConfig.mockParams?.isMockConfigChanged)}function bundleNameHasChanged(e){return e.share?.projectConfig?.uiTransformOptimization!==e.cache.get(OHOS_UI_TRANSFORM_OPTIMIZATION)||!1===e.share?.projectConfig?.uiTransformOptimization&&e.cache.get(BUNDLE_NAME)!==e.share?.projectConfig?.bundleName}function hasHookEventChangedDeps(e,t){const o=e.share.getHookEventFactory("invalidCachePlugin","shouldTransformCachedModule"),a=o.createEvent("hasChangedDeps")?.start(),s=hasChangedDeps(e.cache.get(MODULE_DEPS)?.get(t.id),e.share.depInfo.changedDeps);return a?.stop(),s}function hasChangedDeps(e,t){if(!e)return!1;for(const o of e){if(!depCache.has(o)){const e=depChanged(o,t);depCache.set(o,e)}if(depCache.get(o))return!0}return!1}function depChanged(e,t){let o=!1;for(const{name:a,lastRootPath:s}of t)if(s&&e.startsWith(s)||e===a||e.startsWith(a)){o=!0;break}return o}function isModulePkgNameChanged(e){if(!(e?.meta?.pkgPath&&e?.meta?.pkgName))return!1;const t=(0,module_meta_info_plugin_js_1.getPackageJsonInfo)(path_1.default.resolve(e.meta.pkgPath,constants_js_1.OH_PACKAGE_JSON5));return e.meta.pkgName!==t?.pkgName}exports.invalidCachePlugin=invalidCachePlugin;