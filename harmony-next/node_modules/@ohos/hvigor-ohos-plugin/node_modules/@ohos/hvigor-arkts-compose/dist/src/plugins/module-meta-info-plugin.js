"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,n){void 0===n&&(n=t);var a=Object.getOwnPropertyDescriptor(o,t);a&&!("get"in a?!o.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,n,a)}:function(e,o,t,n){void 0===n&&(n=t),e[n]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.findNodeEntryFiles=exports.getPackageJsonInfo=exports.moduleMetaInfoPlugin=void 0;const path_1=__importDefault(require("path")),hvigor_arkts_base_1=require("@ohos/hvigor-arkts-base"),hvigor_common_1=require("@ohos/hvigor-common"),fs=__importStar(require("fs-extra")),json5_1=__importDefault(require("json5")),constants_js_1=require("../util/constants.js"),utils_js_1=require("../util/utils.js"),LOCAL_MODULE_INFO_CACHE_KEY="localModuleInfoCache",CACHE_KEYS=["allModuleNameHash","pkgJsonFileHash"],OBJECT_ENTRY_KEYS=["import",".","default","require","node"],NODE_ENTRY_FILE_KEYS=["exports","module","jsnext:main","main"],COMMONJS_ES_IMPORT_SUFFIX="?commonjs-es-import",LOGGER=hvigor_arkts_base_1.ArktsBaseLogger.getPluginLogger("ArkTS import check");let packageInfoCache,localModuleInfoCache,packageJsonCache={},dynamicImport=[];const loadMetaInfoSet=new Set;let throwErrorFunction,supportExtensions,projectModel,projectTopDir;function moduleMetaInfoPlugin(e){return supportExtensions=e,{name:"moduleInfoMetaPlugin",beforeBuild:beforeBuild,buildStart:buildStart,load:load,moduleParsed:moduleParsed,beforeBuildEnd:beforeBuildEnd,afterBuildEnd:afterBuildEnd,cleanUp:cleanUp,resolveDynamicImport:resolveDynamicImport,resolveId:resolveId}}function resolveDynamicImport(e,o){dynamicImport.push(e+o)}function resolveId(e,o){if(void 0!==e&&void 0!==o&&!dynamicImport.includes(e+o))try{const t=this.getModuleInfo(o);let n="",a="";t?.meta.belongModulePath&&(n=path_1.default.resolve(t?.meta.belongModulePath,constants_js_1.OH_PACKAGE_JSON5)),t?.meta.belongProjectPath&&(a=path_1.default.resolve(t?.meta.belongProjectPath,constants_js_1.OH_PACKAGE_JSON5));let r={};if(fs.existsSync(n)){if(!packageJsonCache[n]){const e=fs.readFileSync(n,"utf-8");packageJsonCache[n]=json5_1.default.parse(e)}packageJsonCache[n].dynamicDependencies&&(r=packageJsonCache[n].dynamicDependencies)}if(fs.existsSync(a)){if(!packageJsonCache[a]){const e=fs.readFileSync(a,"utf-8");packageJsonCache[a]=json5_1.default.parse(e)}packageJsonCache[a].dynamicDependencies&&(r={...r,...packageJsonCache[a].dynamicDependencies})}Object.keys(r).find((o=>o===e))&&LOGGER.warn(`It is recommended to use dynamic imports for packages listed in dynamicDependencies. Using '${e}' at file: ${o}`)}catch(e){LOGGER.debug("oh-package.json5 parse failed:",e.message)}}function buildStart(){loadMetaInfoSet.clear(),packageInfoCache={},dynamicImport=[],packageJsonCache={};const e=shouldLoadCache(this.share?.projectConfig,this.cache);localModuleInfoCache=e?this.cache.get(LOCAL_MODULE_INFO_CACHE_KEY)??{}:{},throwErrorFunction=this.share?.throwArkTsCompilerError,projectModel=this.share?.projectConfig?.projectModel,projectModel||throwError("parsed module meta info error: current projectModel is undefined"),projectTopDir=this.share?.projectConfig?.projectTopDir,projectTopDir||throwError("parsed module meta info error: projectTopDir is undefined")}function beforeBuild(){this.share?.projectConfig?.sourceMapDir&&("har"===this.share?.projectConfig?.moduleType&&"Release"===this.share?.projectConfig?.buildMode||"har"!==this.share?.projectConfig?.moduleType&&"Debug"===this.share?.projectConfig?.buildMode)&&fs.ensureDirSync(this.share?.projectConfig?.sourceMapDir)}function addModuleInfoData(e,o,t){const n=e.includes(constants_js_1.OH_NODE_MODULES)||e.includes(constants_js_1.NODE_MODULES)?loadRemoteDependencyInfo(e,this.share?.projectConfig?.projectTopDir):loadLocalDependencyInfo(e,o);let a;if(!(0,hvigor_common_1.isSubPath)(e,this.share.projectConfig.modulePath)){const e=this.share?.projectConfig?.localModuleParamMap;a={pkgName:n.pkgName,pkgVersion:e&&e.has(n.pkgPath)?e.get(n.pkgPath):n.pkgVersion}}t.meta?Object.assign(t.meta,n,{dependencyPkgInfo:a}):t.meta={...n,dependencyPkgInfo:a}}function load(e){const o=this.getModuleInfo(e);if(!o)return;const t=o.meta?.isHarDeduplicate&&e.startsWith("\0");if(t&&(e=e.substring(1)),loadMetaInfoSet.has(e))return;let n=!1;(0,utils_js_1.isVirtualFile)(e)&&(n=e.includes(COMMONJS_ES_IMPORT_SUFFIX),!n)||o.isExternal&&!t||(addModuleInfoData.call(this,e,n,o),loadMetaInfoSet.add(e))}function moduleParsed(e){for(const o of e?.importedIds??[])load.call(this,o);for(const o of e?.dynamicallyImportedIds??[])load.call(this,o);e&&dealHostModuleInfo(e.meta.moduleName,e,this.getModuleInfo)}function processNeedPreloadSoTag(e,o,t){const n=e.share?.projectConfig?.needPreloadSoFileSet;if(!n?.size)return;const a=[...n];for(;a.length;){const n=a.pop(),r=e.getModuleInfo(n);!r||r.isExternal||o(r)||(t(r),a.push(...r.importedIds,...r.dynamicallyImportedIds))}}function addNeedPreloadSoTag(e){processNeedPreloadSoTag(e,(e=>!!e.meta?.needPreloadSo),(e=>{e.meta={...e.meta,needPreloadSo:!0}}))}function removeNeedPreloadSoTag(e){processNeedPreloadSoTag(e,(e=>!e.meta?.needPreloadSo),(e=>{e.meta?.needPreloadSo&&delete e.meta.needPreloadSo}))}function beforeBuildEnd(){"true"===this.share?.projectConfig?.watchMode&&loadMetaInfoSet.clear(),this.cache.set(LOCAL_MODULE_INFO_CACHE_KEY,localModuleInfoCache);for(const e of CACHE_KEYS)this.cache.set(e,this.share?.projectConfig[e]);(0,utils_js_1.allowToPreloadSo)(this.share?.projectConfig)&&addNeedPreloadSoTag(this)}function afterBuildEnd(){(0,utils_js_1.allowToPreloadSo)(this.share?.projectConfig)&&removeNeedPreloadSoTag(this)}function cleanUp(){loadMetaInfoSet.clear(),localModuleInfoCache=null,packageInfoCache=null,dynamicImport=[],packageJsonCache={}}function loadRemoteDependencyInfo(e,o){e.startsWith("\0")&&(e=e.substring(1));const t=getPackageJsonInfo(path_1.default.resolve(e,".."));return t?{isLocalDependency:!1,isNodeEntryFile:isNodeEntryFile(e,t.nodeEntryFiles),pkgPath:t.pkgPath,pkgName:t.pkgName,pkgVersion:t.pkgVersion,belongProjectPath:o}:(throwError(`parsed module meta info error: can not parsed remote dependency ${e} package.json info`),{})}function loadLocalDependencyInfo(e,o=!1){let t=e;if(o&&(t=e.substring(1,e.indexOf(COMMONJS_ES_IMPORT_SUFFIX))),localModuleInfoCache[e])return localModuleInfoCache[e];for(const[o,{moduleName:n,modulePkgPath:a,belongProjectPath:r,isBuildCacheDir:s}]of Object.entries(projectModel))if((0,hvigor_common_1.isSubPath)(t,o)){const t=getPackageJsonInfo(a);return localModuleInfoCache[e]={moduleName:n,isLocalDependency:!0,isNodeEntryFile:!!t&&isNodeEntryFile(e,t.nodeEntryFiles),pkgPath:s?o:a,belongProjectPath:s?path_1.default.dirname(o):r},t&&Object.assign(localModuleInfoCache[e],{pkgName:t.pkgName,pkgVersion:t.pkgVersion}),localModuleInfoCache[e]}const n=getPackageJsonInfo(projectTopDir);return localModuleInfoCache[e]={moduleName:path_1.default.basename(projectTopDir),isLocalDependency:!0,isNodeEntryFile:!!n&&isNodeEntryFile(e,n.nodeEntryFiles),pkgPath:projectTopDir},localModuleInfoCache[e]}function shouldLoadCache(e,o){if(!e||!o)return!1;let t=!0;for(const n of CACHE_KEYS){if((e[n]??"")!==(o.get(n)??"")){t=!1;break}}return t}function getPackageJsonInfo(e){if(e===path_1.default.dirname(projectTopDir)||e===path_1.default.dirname(e))return;if(packageInfoCache[e])return packageInfoCache[e];const o=findPackageJsonFile(e);if(o){const t=getNodeEntryFiles(o),n=getJsonObject(o);return packageInfoCache[e]=t?{pkgPath:e,nodeEntryFiles:t,pkgName:n.name,pkgVersion:n.version}:void 0,packageInfoCache[e]}return packageInfoCache[e]=getPackageJsonInfo(path_1.default.dirname(e)),packageInfoCache[e]}function dealHostModuleInfo(e,o,t){if(e)for(const[n,a]of Object.entries(o.importedIdMaps)){const o=t(a);o&&(o.meta.hostModulesInfo||(o.meta.hostModulesInfo=[]),o.meta.hostModulesInfo.push({hostDependencyName:n,hostModuleName:e}))}}function getNodeEntryFiles(e){const o=getJsonObject(e);if(!o)return;return findNodeEntryFiles(o).map((o=>path_1.default.resolve(e,`../${o}`)))}function findNodeEntryFiles(e){const o=[];for(const t of NODE_ENTRY_FILE_KEYS){const n=parseEntryFiles(e[t]);if(n){o.push(...n);break}}return o.push("index.js"),o}function isNodeEntryFile(e,o){if(-1!==o.indexOf(e))return!0;for(const t of supportExtensions)if(o+t===e)return!0;return!1}function parseEntryFiles(e){if(!e)return;if("string"==typeof e)return[e];const o=[];if(Array.isArray(e))for(const t of e){const e=parseEntryFiles(t);e&&o.push(...e)}if(o.length>0)return o;if("object"==typeof e)for(const t of OBJECT_ENTRY_KEYS){const n=parseEntryFiles(e[t]);n&&o.push(...n)}return o}function getJsonObject(e){try{const o=fs.readFileSync(e,"utf-8");return json5_1.default.parse(o)}catch(e){return}}function findPackageJsonFile(e){return findFile((0,utils_js_1.getOhPackageJsonPath)(path_1.default.join(e,constants_js_1.OH_PACKAGE_JSON5)))}function findFile(e){return fs.existsSync(e)?e:void 0}function throwError(e){if(!throwErrorFunction)throw new Error(e);throwErrorFunction(e)}exports.moduleMetaInfoPlugin=moduleMetaInfoPlugin,exports.getPackageJsonInfo=getPackageJsonInfo,exports.findNodeEntryFiles=findNodeEntryFiles;