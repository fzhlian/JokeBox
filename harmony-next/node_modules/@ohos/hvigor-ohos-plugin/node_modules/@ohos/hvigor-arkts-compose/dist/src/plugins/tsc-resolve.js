"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.tscResolve=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),hvigor_arkts_base_1=require("@ohos/hvigor-arkts-base"),json5_1=__importDefault(require("json5")),har_deduplicate_util_js_1=require("./har-deduplicate/har-deduplicate-util.js"),import_check_plugin_js_1=__importDefault(require("./import-check-plugin.js")),node_resolve_1=require("./node-resolve"),isWindows="win32"===process.platform;let tscProgram;const ignoreVirtualFilePrefix="\0hvigor_ignore_",libraryResolvedCache=new Map;let shouldDoCaseSensitiveCheck=!1;const caseErrorSet=new Set;let harDuplicateFileSet;const logger=hvigor_arkts_base_1.ArktsBaseLogger.getLogger("caseSensitiveCheck");function getVirtualFileId(e){return ignoreVirtualFilePrefix+e.replace(/\\/g,"_").replace(/\//g,"_")}function isDeclarationFile(e){return e.endsWith(".d.ts")||e.endsWith(".d.ets")}function isSystemApi(e){const t=path_1.default.basename(e);return t.startsWith("@ohos.")||t.startsWith("@hms.")||t.startsWith("@system.")||t.startsWith("@kit.")}function toUnixPath(e){return isWindows?e.split(path_1.default.sep).join("/"):e}const harExternal=new Map,hspExternal=new Map,harWithBackSlashExternal=new Map,hspWithBackslashExternal=new Map;function tscResolve(e){return{name:"tscResolve",buildStart(){const t=path_1.default.join(this.share.projectConfig.etsLoaderPath,"main.js");fs_1.default.existsSync(t)&&(tscProgram=require(t)?.globalProgram?.program),shouldDoCaseSensitiveCheck=e?.caseSensitiveCheck||!1,(0,node_resolve_1.getExternal)(harExternal,hspExternal,harWithBackSlashExternal,hspWithBackslashExternal,this.share.projectConfig),harDuplicateFileSet=(0,har_deduplicate_util_js_1.getHarDuplicateFileSet)(this.share.projectConfig)},load(e){if(e.startsWith(ignoreVirtualFilePrefix))return"";if((0,har_deduplicate_util_js_1.isHspDeduplicateRealCompile)(this.share.projectConfig)&&e.startsWith("\0")&&harDuplicateFileSet&&harDuplicateFileSet.has(e.substring(1)))return"";if(tscProgram){const t=tscProgram.getSourceFile(e);if(t)return t.text}return null},resolveId:resolveId,beforeBuildEnd(){caseErrorSet.forEach((e=>{logger.error(e)}))},cleanUp(){harExternal.clear(),hspExternal.clear(),harWithBackSlashExternal.clear(),hspWithBackslashExternal.clear(),libraryResolvedCache.clear(),caseErrorSet.clear(),harDuplicateFileSet?.clear(),tscProgram=null}}}function normalizePathOnWindows(e){return isWindows&&(e=e.replace(/\//g,"\\")),e}async function resolveId(e,t,r){if(!t||!tscProgram)return null;const a=tscProgram.getSourceFile(t);if(!a||!a.resolvedModules)return null;const s=a.resolvedModules.get(e);if(!s||!s.resolvedFileName)return null;if(/^lib\S+\.so/.test(e))return shouldDoCaseSensitiveCheck&&await doCaseCheck(e,t,s),{id:getVirtualFileId(e),external:!this.share.projectConfig.isFaMode};if((0,node_resolve_1.isExternal)(harExternal,hspExternal,e,t,this.share?.projectConfig))return shouldDoCaseSensitiveCheck&&await doCaseCheck(e,t,s),{id:e,external:!0};if((0,har_deduplicate_util_js_1.isHspCollectFilesCompile)(this.share.projectConfig)&&(0,node_resolve_1.isBackslashExternal)(harWithBackSlashExternal,hspWithBackslashExternal,e))return{id:e,external:!0};const i=await resolveLikeNode(e,s,!this.share.projectConfig.isFaMode);if(!i)return null;const{finalResolved:l,isResolved2SystemApi:n}=i;if(shouldDoCaseSensitiveCheck&&!n&&await doCaseCheck(e,t,s),l.id&&!l.isVirtualFile){import_check_plugin_js_1.default.resolveId.call(this,e,l.id,t,r),l.id=normalizePathOnWindows(l.id);const a=(0,node_resolve_1.processHarDeduplicate)(this,l.id,!this.share.projectConfig.isFaMode);if(a)return a}return l}async function resolveLikeNode(e,t,r){let a,s=!1;if(isDeclarationFile(t.resolvedFileName))if(t.packageId){const r=await resolveLibrary(e,t,!0);if(!r)return null;a={id:r}}else if("."!==e[0]&&isSystemApi(t.resolvedFileName))s=!0,a={id:getVirtualFileId(t.resolvedFileName),external:r,isVirtualFile:!0};else{const e=maybeRealSourceFile(t.resolvedFileName,[".js"]);a=e?{id:e}:{id:getVirtualFileId(t.resolvedFileName),external:r,isVirtualFile:!0}}else{const r=await resolveLibrary(e,t,!1);if(!r)return null;a={id:r}}return{finalResolved:a,isResolved2SystemApi:s}}function myNormalize(e){return((e=toUnixPath(e)).endsWith(".js")||e.endsWith(".ts")||e.endsWith(".ets")||e.endsWith(".mjs")||e.endsWith(".cjs"))&&(e=e.substring(0,e.length-path_1.default.extname(e).length)).endsWith(".d")&&(e=e.substring(0,e.length-2)),e}async function doCaseCheck(e,t,r){const a=toUnixPath(fs_1.default.realpathSync.native(r.resolvedFileName)),s=toUnixPath(r.resolvedFileName);let i;if(void 0!==r.originalPath||a.toLowerCase()!==s.toLowerCase()){let t=myNormalize(path_1.default.normalize(e));t.startsWith("../")&&(t=t.replace(/\.+\//g,"")),t.endsWith("/")&&(t=t.substring(0,t.length-1)),i=await checkPathCaseSensitivity(t,myNormalize(r.originalPath||r.resolvedFileName))}else i=a===s;if(!i){const r=`ERROR File: ${t} \n        Cannot resolved import statement ${e}. Please check the case.`;caseErrorSet.add(r)}return i}async function checkCaseByReadDirFiles(e,t){const r=await fs_1.default.promises.readdir(e);let a=!1;for(const e of r){if(e===t){a=!0;break}if(path_1.default.extname(e)){const r=path_1.default.basename(e,path_1.default.extname(e));if(r===t||r===`${t}.d`){a=!0;break}}}return a}async function checkPathCaseSensitivity(e,t){const r=e.split("/"),a=t.split("/");let s=r.length-1,i=a.length-1;for(;s>=0;){for(;i>=0&&r[s].toLowerCase()!==a[i].toLowerCase();)i--;if(i<0)return!1;const e=a.slice(0,i+1).join("/"),t=path_1.default.dirname(e),l=r[s];if(!await checkCaseByReadDirFiles(t,l))return!1;s--,i--}return!0}async function readJson5(e){try{const t=await fs_1.default.promises.readFile(e,"utf-8");return json5_1.default.parse(t)}catch(e){return}}function getCacheKey(e){return`${e.resolvedFileName}|${e.packageId?.name}|${e.packageId?.version}`}async function resolveLibrary(e,t,r){if(!t.packageId)return null;const a=libraryResolvedCache.get(getCacheKey(t));if(a)return a;if(e===t.packageId.name||new RegExp(`^${t.packageId.name}\\/+$`).test(e)){const e=t.resolvedFileName.substring(0,t.resolvedFileName.length-t.packageId.subModuleName.length),r=path_1.default.resolve(e,"oh-package.json5");if(fs_1.default.existsSync(r)){const a=await readJson5(r);if(!a)return null;let s;if(a.module?s=path_1.default.resolve(e,a.module):a.main&&(s=path_1.default.resolve(e,a.main)),s)return libraryResolvedCache.set(getCacheKey(t),s),s}}else{if(!r)return t.resolvedFileName;{const e=maybeRealSourceFile(t.resolvedFileName,[".mjs",".js"]);if(e)return libraryResolvedCache.set(getCacheKey(t),e),e}}return null}function maybeRealSourceFile(e,t){const r=e.endsWith(".d.ets")?6:5;for(const a of t){const t=e.substring(0,e.length-r)+a;if(fs_1.default.existsSync(t))return t}return null}exports.tscResolve=tscResolve;