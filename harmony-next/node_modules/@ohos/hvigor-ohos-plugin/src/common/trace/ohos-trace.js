"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ohosTrace=void 0;const hvigor_1=require("@ohos/hvigor"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),inject_util_js_1=require("../../utils/inject-util.js");class OhosTrace{constructor(){this.data=OhosTrace.getDefaultOhosTraceData()}initOhosTrace(){hvigor_1.hvigor.buildFinishedInternal(()=>{exports.ohosTrace.traceModuleIncremental(),exports.ohosTrace.traceFullBuild(),exports.ohosTrace.transmitDataToManager(),this.data=OhosTrace.getDefaultOhosTraceData()})}static getDefaultOhosTraceData(){return{MODULES:[],NATIVE_COMPILER:"Default",IS_FULL_BUILD:!0}}transmitDataToManager(){hvigor_1.TraceManager.trace(OhosTrace.TRACE_KEY,this.data,()=>{var e,t;null===(t=null===(e=this.data)||void 0===e?void 0:e.MODULES)||void 0===t||t.forEach(e=>{delete e.RESTOOL_COMPRESSION,delete e.INCREMENTAL_TASKS})})}traceBuildMode(e){var t,o;const a=null===(t=hvigor_1.globalData.cliEnv.configProps)||void 0===t?void 0:t.get("prop");a&&(this.data.BUILD_MODE=null!==(o=a.get("buildMode"))&&void 0!==o?o:e)}traceNativeCompiler(e){this.data.NATIVE_COMPILER=null!=e?e:"Default"}traceModules(e,t){const o=hvigor_1.TraceManager.anonymize(e),a=this.data.MODULES.filter(e=>e.MODULE_NAME!==o),r=inject_util_js_1.InjectUtil.getEntryModulesName().includes(e);a.push({MODULE_NAME:o,API_TYPE:t,INCLUDE_IN_BUILD:!1,IS_COMMAND_LINE_ENTRY_MODULE:r}),this.data.MODULES=a}traceModuleType(e,t){const o=this.getModule(e);o&&(o.MODULE_TYPE=t)}getModule(e){if(!e)return;const t=hvigor_1.TraceManager.anonymize(e);return this.data.MODULES.find(e=>e.MODULE_NAME===t)}traceRestoolCompression(e,t){const o=this.getModule(e);o&&(o.RESTOOL_COMPRESSION=t)}traceIncrement(e,t,o){var a;const r=this.getModule(e);r&&(r.INCREMENTAL_TASKS=null!==(a=r.INCREMENTAL_TASKS)&&void 0!==a?a:{},r.INCREMENTAL_TASKS[t]=o)}traceIncludeInBuild(e,t){const o=this.getModule(e);o&&(o.INCLUDE_IN_BUILD=t)}traceIsUseCompilePlugin(e){const t=this.getModule(e);t&&(t.IS_USE_COMPILE_PLUGIN=!0)}traceIsUseTransformLib(e){const t=this.getModule(e);t&&(t.IS_USE_TRANSFORMLIB=!0)}traceByteCodeHar(e){const t=this.getModule(e);t&&(t.IS_BYTE_CODE_HAR=!0)}traceUseNormalizedOHMUrl(e){this.data.USE_NORMALIZED_OHMURL=e}traceIsAutoLazyImport(e,t){const o=this.getModule(e);o&&(o.IS_AUTO_LAZY_IMPORT=t)}traceIsUsePacJson(e){const t=this.getModule(e);t&&(t.IS_USE_PAC=!0)}traceModuleIncremental(){for(const e of this.data.MODULES){const t=e.INCREMENTAL_TASKS;if(!e.INCLUDE_IN_BUILD){e.IS_INCREMENTAL_MODULE=!1;continue}if(!t){e.IS_INCREMENTAL_MODULE=!0;continue}let o=!0;Object.keys(t).forEach(e=>{t[e]||(o=!1)}),e.IS_INCREMENTAL_MODULE=o}}traceFullBuild(){this.data.IS_FULL_BUILD=!this.data.MODULES.some(e=>this.isEntryModule(e)&&e.IS_INCREMENTAL_MODULE)}isEntryModule(e){if(e.IS_COMMAND_LINE_ENTRY_MODULE)return!0;if(!e.INCLUDE_IN_BUILD)return!1;const t=new Map([["assembleHap",[module_type_enum_js_1.ModuleType.Entry,module_type_enum_js_1.ModuleType.Feature]],["assembleHsp",[module_type_enum_js_1.ModuleType.Shared]],["assembleHar",[module_type_enum_js_1.ModuleType.Har]],["assembleApp",[module_type_enum_js_1.ModuleType.Entry,module_type_enum_js_1.ModuleType.Feature,module_type_enum_js_1.ModuleType.Shared]]]);for(const[o,a]of t)if(hvigor_1.hvigorCore.isCommandEntryTask(o)&&e.MODULE_TYPE&&a.includes(e.MODULE_TYPE))return!0;return!1}}OhosTrace.TRACE_KEY="HVIGOR_OHOS_PLUGIN",exports.ohosTrace=new OhosTrace;