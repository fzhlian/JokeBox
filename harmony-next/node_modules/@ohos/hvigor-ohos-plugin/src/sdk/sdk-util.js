"use strict";var __importDefault=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.handleSdkException=exports.contains=exports.proxyFun=exports.parseApiVersion=exports.OhosParser=exports.ohosPredict=void 0;const hvigor_1=require("@ohos/hvigor"),sdkmanager_common_1=require("@ohos/sdkmanager-common"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),common_const_js_1=require("../const/common-const.js"),project_build_profile_js_1=require("../options/build/project-build-profile.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js");var ApiValType=project_build_profile_js_1.ProjectBuildProfile.ApiValType;const LOGGER=ohos_logger_js_1.OhosLogger.getLogger("Sdk"),ohosPredict=(o,e,r)=>{const t=new Map,n=path_1.default.resolve(o,e);if(r.filter(o=>!fs_1.default.existsSync(path_1.default.resolve(n,o,common_const_js_1.CommonConst.OHOS_SDK_COMPONENT_DEFINITION))).length>0)return t;const s=new OhosParser(o),i=r.map(o=>path_1.default.resolve(n,o,"oh-uni-package.json"));return s.parse(i).map(o=>[new sdkmanager_common_1.PathAndApiVersion(o.getPath(),o.getFullApiVersion()),o]).forEach(o=>t.set(o[0],o[1])),t};exports.ohosPredict=ohosPredict;class OhosParser extends sdkmanager_common_1.OhLocalComponentLoader{constructor(o){super(o)}parse(o){return this.parseSdks(o)}}function getApiVersion(o,e){const r=e?"HO_API_VERSION_VALIDATE_FAILED":"OH_API_VERSION_VALIDATE_FAILED";try{return new sdkmanager_common_1.ApiVersion(o)}catch(o){LOGGER.printErrorExit(r,void 0,[[path_1.default.resolve(process.cwd(),"build-profile.json5")]])}}exports.OhosParser=OhosParser;const parseApiVersion=(o,e)=>{var r;if("number"==typeof o)return{api:`${o}`,version:o,type:ApiValType.NUM,fullVersion:o.toString(),major:o,minor:0,patch:0};const t=/\s*([1-9].[0-9].[0-9])\s*\(\s*(\d+)\s*\)\s*$/g.exec(o);if(3===(null==t?void 0:t.length))return{api:t[1],version:parseInt(t[2]),type:ApiValType.STRING,fullVersion:t[2],major:parseInt(t[2]),minor:0,patch:0};if(e){const e=/\s*([1-9]\.[0-9]\.[0-9])\s*$/g,t=o.split("(")[0],n=null===(r=o.split("(")[1])||void 0===r?void 0:r.split(")")[0],s=e.exec(t);2!==(null==s?void 0:s.length)&&LOGGER.printErrorExit("HO_API_VERSION_VALIDATE_FAILED",void 0,[[path_1.default.resolve(process.cwd(),"build-profile.json5")]]);const i=getApiVersion(n,!0);return{api:t,version:null==i?void 0:i.getMajor(),type:ApiValType.STRING,fullVersion:n,major:null==i?void 0:i.getMajor(),minor:null==i?void 0:i.getMinor(),patch:null==i?void 0:i.getPatch()}}{const e=getApiVersion(o,!1);return{api:o,version:null==e?void 0:e.getMajor(),type:ApiValType.STRING,fullVersion:o,major:null==e?void 0:e.getMajor(),minor:null==e?void 0:e.getMinor(),patch:null==e?void 0:e.getPatch()}}};exports.parseApiVersion=parseApiVersion;const proxyFun=()=>{var o,e,r;const t=hvigor_1.GlobalParam.getInstance();return{proxy:t.getConfig("proxy"),httpsProxy:t.getConfig("https-proxy"),noProxy:null!==(r=null!==(e=null!==(o=t.getConfig("noproxy"))&&void 0!==o?o:t.getConfig("no-proxy"))&&void 0!==e?e:process.env.NO_PROXY)&&void 0!==r?r:process.env.npm_config_noproxy}};exports.proxyFun=proxyFun;const contains=(o,e)=>{for(const[r,t]of e)if(r===o)return t};exports.contains=contains;const handleSdkException=o=>{if(!(o instanceof sdkmanager_common_1.SdkException))throw o;{const e=o.getErrorTip();LOGGER._buildError(e.getReason())._solution(`${e.getFixSuggestion()}`)._printErrorAndExit()}};exports.handleSdkException=handleSdkException;