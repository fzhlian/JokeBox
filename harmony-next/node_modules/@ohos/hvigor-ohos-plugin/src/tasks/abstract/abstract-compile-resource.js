"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractCompileResource=void 0;const path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),log4js_1=require("log4js"),ohos_trace_js_1=require("../../common/trace/ohos-trace.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),inject_const_js_1=require("../../const/inject-const.js"),compile_resources_util_js_1=require("../../utils/compile-resources-util.js"),file_util_js_1=require("../../utils/file-util.js"),process_utils_js_1=require("../../utils/process-utils.js"),module_task_service_js_1=require("../service/module-task-service.js"),abstract_resource_task_js_1=require("./abstract-resource-task.js"),json_util_js_1=require("../../utils/json-util.js"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),form_util_js_1=require("../../utils/form-util.js");class AbstractCompileResource extends abstract_resource_task_js_1.AbstractResource{constructor(e,t){super(e,t),this.intermediatesResDir=this.pathInfo.getIntermediatesRes(),this.isPreview=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.BUILD_ROOT)===build_directory_const_js_1.BuildDirConst.PREVIEW_BUILD_PATH}getEnabled(){const e=this.node.getTaskContainer().findTask(`${this.targetName}@${this.processProfileTask}`);if(void 0===e)throw new Error(`Resource compile task initialize failed, task ${this.processProfileTask} not found.`);return this.restoolCommandBuilder=e.restoolCommandBuilder,this.restoolConfigBuilder=e.restoolConfigBuilder,super.getEnabled()}getCommand(){return[this.getResToolFile(),"-l",this.resConfigFilePath]}beforeTask(){file_util_js_1.FileUtil.checkDirWithoutDelete(this.intermediatesResDir),file_util_js_1.FileUtil.checkDirWithoutDelete(this.generateSourceRDir)}declareInputs(){const e=new Map;return this.isPreview&&(e.set("PREVIEWER_REPLACE_PAGE",JSON.stringify(hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.PREVIEWER_REPLACE_PAGE))),e.set("PREVIEWER_REPLACE_SRCPATH",JSON.stringify(hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.PREVIEWER_REPLACE_SRC_PATH)))),e.set("TARGET_CONFIG",JSON.stringify(this.targetData.getTargetOpt())),e}declareExecutionTool(){return this.getResToolFile()}declareInputFiles(){return this.restoolConfigBuilder.inputFiles}declareOutputFiles(){return this.restoolConfigBuilder.outputFiles.addEntries([this.intermediatesResDir,this.generateSourceRDir],{isDirectory:!0})}getResToolFile(){return this.sdkInfo.getRestool()}async compilationProcess(e,t){this.precheck(e)&&await this.invokeRestool(t)}precheck(e){var t;return e===compile_resources_util_js_1.CompileResourceBuildCommandType.FILE?this.restoolConfigBuilder.existsResourceDir:!!(null===(t=this.restoolCommandBuilder)||void 0===t?void 0:t.existsResourceDir)}async invokeRestool(e){}async executeCommand(e,t,i=wdk_1.noop,o){var s;let r;r=this.projectModel.isFaMode()?null===(s=this.moduleModel.getJsonObjByTargetName(this.targetData.getTargetName()))||void 0===s?void 0:s.app.bundleName:this.projectModel.getDefaultBundleName(),t._printDebugCommand(this.getResToolFile(),(0,hvigor_1.replaceBundleName)(e,r));const l="execute compile resource command using restool",n=this.durationEvent.createSubEvent(l,"");n.start(),await new process_utils_js_1.ProcessUtils(this.moduleName,this.name).execute(e,o,void 0,(e,i)=>(this.restoolReportHandler(e),this.iconSizeWarningHandler(e,i,t))),n.stop(),n.setLog(l,hvigor_1.MetricLogType.INFO),await i()}iconSizeWarningHandler(e,t,i){var o;if(!((null===(o=e.stderr)||void 0===o?void 0:o.length)>0))return!1;const s=e.stderr;return!(!/Warning: the png width and height not equal/.test(s)&&!/Warning: The width or height of the .+ file referenced by the icon exceeds the limit+./.test(s))&&(JSON.stringify(i.getLevel())===JSON.stringify(log4js_1.levels.DEBUG)&&i.warn(s),!0)}restoolReportHandler(e){var t,i,o,s;const r=(e.stdout+e.stderr).split("\n"),l=r.findIndex(e=>e.startsWith("Processing report:"));if(l>=0&&l+3<r.length){const e=/\d+\\.\d+|\d+/g,n=null===(i=null===(t=r[l+2])||void 0===t?void 0:t.match(e))||void 0===i?void 0:i.map(e=>parseFloat(e)),a=null===(s=null===(o=r[l+3])||void 0===o?void 0:o.match(e))||void 0===s?void 0:s.map(e=>parseFloat(e));if(!Array.isArray(n)||!Array.isArray(a)||0===n[0]||0===a[2])return;const[d,u]=n,[c,_,m,g]=a;ohos_trace_js_1.ohosTrace.traceRestoolCompression(this.moduleModel.getName(),{TIMESTAMP:Date.now(),TRANSCODE_FILES:d,TRANSCODE_SUCCESS_RATE:c/d,TRANSCODE_TOTAL_TIME:u,TRANSCODE_EXPANSION_RATE:g/m})}}async retainDeviceType(e,t,i){var o,s,r,l;const n=e.findRelatedTargetData(t);if((0,module_task_service_js_1.checkHasTargetApplyProduct)(this.targetData.getModuleModel(),this.targetData.getTargetName(),this.targetData.getProduct().name)&&n){const a=n.getTargetDeviceType(),d=e.getTargetDeviceType().filter(e=>(null==a?void 0:a.indexOf(e))>-1),u=path_1.default.resolve(e.getPathInfo().getIntermediatesRes(),t,common_const_js_1.CommonConst.CONFIG_JSON),c=json_util_js_1.JsonUtil.getJson5Obj(u);if(c.module.deviceType=d,this.isFaMode){const e=this.service.getProjectModel(),i=e.getModuleModelByName(t),a=path_1.default.resolve(null!==(o=null==i?void 0:i.getProjectDir())&&void 0!==o?o:path_1.default.resolve(e.getProjectDir(),t),`src/main/${common_const_js_1.CommonConst.CONFIG_JSON}`),d=res_model_loader_js_1.resModelLoader.getConfigJson(a),u=null!==(r=null===(s=n.getTargetOpt().config)||void 0===s?void 0:s.distroFilter)&&void 0!==r?r:null===(l=null==d?void 0:d.module)||void 0===l?void 0:l.distroFilter;u&&(c.module.distroFilter=u)}await fs_extra_1.default.outputJson(u,c,{spaces:"\t"}),0===d.length&&i.warn(`The device types of ${this.moduleModel.getName()} and ${t} are different. Invalid HAP ${this.moduleModel.getName()}.`)}}replaceTargetPages(e,t){var i;const o=null===(i=e.getTargetOpt().source)||void 0===i?void 0:i.pages;void 0!==o&&this.replacePages(t,o)}processFormExtensionAbilities(){this.moduleModel.isFormExtensionModule(this.targetName)?this.recoverFormExtensionModule():this.moduleModel.isFormWidgetModule(this.targetName)&&this.processFormWidgetModule()}recoverFormExtensionModule(){const e=this.targetService.getTargetData().getModuleSourceSetModel().getModuleTargetRes().getModuleJsonOpt();if(!e.module.extensionAbilities)return;const t=path_1.default.resolve(this.intermediatesResDir,common_const_js_1.CommonConst.MODULE_JSON),i=json_util_js_1.JsonUtil.getJson5Obj(t);e.module.extensionAbilities.filter(e=>"form"===e.type).forEach(e=>{i.module.extensionAbilities||(i.module.extensionAbilities=[]),i.module.extensionAbilities.push(e)}),fs_extra_1.default.writeJSONSync(t,i)}processFormWidgetModule(){const e=path_1.default.resolve(this.intermediatesResDir,common_const_js_1.CommonConst.ARK_MODULE_JSON);this.writeFormExtensionAbilities(e)}writeFormExtensionAbilities(e){var t;const i=json_util_js_1.JsonUtil.getJson5Obj(e),o=form_util_js_1.FormUtil.getFormExtensionModuleByTargetName(this.moduleModel,this.targetName).getJsonObjByTargetName(this.targetName);if(!(null===(t=null==o?void 0:o.module)||void 0===t?void 0:t.extensionAbilities))return;const s=o.module.extensionAbilities.filter(e=>"form"===e.type);s.length&&!i.module.extensionAbilities&&(i.module.extensionAbilities=[]),s.forEach(e=>{i.module.extensionAbilities||(i.module.extensionAbilities=[]);const t={name:e.name,type:e.type,metadata:e.metadata};i.module.extensionAbilities.push(t)}),fs_extra_1.default.writeJSONSync(e,i)}processPreviewFormWidgetModule(){const e=path_1.default.resolve(this.intermediatesResDir,common_const_js_1.CommonConst.MODULE_JSON);this.writeFormExtensionAbilities(e)}}exports.AbstractCompileResource=AbstractCompileResource;