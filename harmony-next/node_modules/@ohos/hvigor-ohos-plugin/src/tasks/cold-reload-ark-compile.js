"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,i){void 0===i&&(i=t);var r=Object.getOwnPropertyDescriptor(o,t);r&&!("get"in r?!o.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,i,r)}:function(e,o,t,i){void 0===i&&(i=t),e[i]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ColdReloadArkCompile=void 0;const hvigor_1=require("@ohos/hvigor"),fse=__importStar(require("fs-extra")),json_util_js_1=require("../utils/json-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),math_util_js_1=require("../utils/math-util.js"),run_ark_js_1=require("./worker/run-ark.js"),ark_compile_js_1=require("./ark-compile.js"),common_const_js_1=require("../const/common-const.js"),worker_id_helper_1=require("./worker/worker-id-helper");class ColdReloadArkCompile extends ark_compile_js_1.ArkCompile{constructor(){super(...arguments),this.logger=ohos_logger_js_1.OhosLogger.getLogger(ColdReloadArkCompile.name)}taskShouldDo(){const e=this.pathInfo.getBuildConfigPath();return super.taskShouldDo()&&fse.existsSync(e)}declareInputFiles(){var e;const o=super.declareInputFiles(),t=this.pathInfo.getBuildConfigPath();if(fse.existsSync(t)){const i=json_util_js_1.JsonUtil.getJson5Obj(t),r=null===(e=null==i?void 0:i.patchConfig)||void 0===e?void 0:e.changedFileList;r&&fse.existsSync(r)&&o.addEntry(r)}return o}async doTaskAction(){const e=this.pathInfo.getBuildConfigPath();let o,t;if(fse.existsSync(e)){const i=json_util_js_1.JsonUtil.getJson5Obj(e);o=i.compileConfig,t=i.patchConfig}else this.logger.debug(`Build config file not found: ${e}`);const i={...await this.initDefaultArkCompileConfig(),...null!=o?o:{}};if(i.obfuscationOptions&&delete i.obfuscationOptions,i.aceModuleJsonPath=this.pathInfo.getIntermediatesArkModuleJsonPath(),i.watchMode="false",i.projectPath=i.aceModuleRoot,i.collectImportersConfig&&(i.collectImportersConfig.isReload=!0),fse.ensureDirSync(i.cachePath),fse.ensureDirSync(i.aceModuleBuild),this._log.debug(`coldReload build config: ${i}`),t&&i.aceBuildJson&&fse.existsSync(i.aceBuildJson)){const e=json_util_js_1.JsonUtil.getJson5Obj(i.aceBuildJson);e.patchConfig=t,fse.outputJSONSync(i.aceBuildJson,e)}let r=hvigor_1.coreParameter.properties.ohosArkCompileMaxSize;(void 0===r||r<=0||r>hvigor_1.PoolConstant.MAX_POOL_NUM)&&(r=common_const_js_1.ArkPackConst.MAX_ARK_COMPILE_NUM);const s=this.getWorkerPool().getMaxPoolNum();let l=[...new Array(r).keys()];const n=(0,worker_id_helper_1.getWorkerIdWithModule)(i.modulePath);void 0!==n&&s>0&&(l=[(0,math_util_js_1.mod)(n,Math.min(s,r))]);let a=null;a=await(0,run_ark_js_1.submitArkCompileWork)(this,this.getWorkerPool(),this.logger,i,(e,o)=>{void 0!==o&&(0,worker_id_helper_1.setWorkerIdWithModule)(i.modulePath,o),a&&this.handleCompileEvents(e,this.getSubDurationEvent(a),!0)},l)}allowToPreloadSystemSo(){return!1}initTaskDepends(){this.dependsOnHook("buildHotReloadResource")}}exports.ColdReloadArkCompile=ColdReloadArkCompile;