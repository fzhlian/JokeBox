"use strict";var __decorate=this&&this.__decorate||function(e,t,o,s){var a,r=arguments.length,i=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,o):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,s);else for(var n=e.length-1;n>=0;n--)(a=e[n])&&(i=(r<3?a(i):r>3?a(t,o,i):a(t,o))||i);return r>3&&i&&Object.defineProperty(t,o,i),i},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GeneratePkgModuleJson=void 0;const collect_duplicate_har_dependencies_js_1=require("../har-dedepulicate/collect_duplicate_har_dependencies.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js");var Task=task_names_js_1.TaskNames.Task;const hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../const/common-const.js"),json_util_js_1=require("../utils/json-util.js"),build_directory_const_js_1=require("../const/build-directory-const.js");class GeneratePkgModuleJson extends ohos_hap_task_js_1.OhosHapTask{shouldDeduplicateHar(){return this.targetService.shouldEnableHarDeduplicate()}constructor(e){super(e,Task.GENERATE_PKG_MODULE_JSON);const t=this.targetService.getTargetData().getPathInfo();this.jsonPath=path_1.default.resolve(t.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),this.packageHapJsonPath=path_1.default.resolve(this.pathInfo.getPackageHapProductPath(),common_const_js_1.CommonConst.MODULE_JSON),this.preloadSoJsonPath=this.pathInfo.getPreloadSoFilePath()}ensureAppStartup(e){e.module.appStartup||(e.module.appStartup=`$profile:${build_directory_const_js_1.BuildDirConst.DEFAULT_STARTUP_CONFIG_FILE_NAME}`)}writeDeduplicateHarField(e){if(!this.moduleModel.isHspModule())return;const t=(0,collect_duplicate_har_dependencies_js_1.getHspNeedDeduplicateHarInfoMap)(this.moduleName);e.module.deduplicateHar=!!(this.targetService.shouldDoDeduplicateTask()&&t&&Object.keys(t).length>0)}async doTaskAction(){const e=this.pathInfo.getPackageHapProductPath();if(fs_extra_1.default.existsSync(e)||fs_extra_1.default.ensureDirSync(e),fs_extra_1.default.existsSync(this.jsonPath)){const e=json_util_js_1.JsonUtil.getJson5Obj(this.jsonPath);this.isPreloadSystemSoJsonEffective&&e&&this.ensureAppStartup(e),this.shouldDeduplicateHar()&&e&&this.writeDeduplicateHarField(e),fs_extra_1.default.writeFileSync(this.packageHapJsonPath,JSON.stringify(e))}}initTaskDepends(){}}__decorate([(0,hvigor_1.InputFile)()],GeneratePkgModuleJson.prototype,"jsonPath",void 0),__decorate([(0,hvigor_1.OutputFile)()],GeneratePkgModuleJson.prototype,"packageHapJsonPath",void 0),__decorate([(0,hvigor_1.InputFile)()],GeneratePkgModuleJson.prototype,"preloadSoJsonPath",void 0),__decorate([(0,hvigor_1.Input)()],GeneratePkgModuleJson.prototype,"shouldDeduplicateHar",null),exports.GeneratePkgModuleJson=GeneratePkgModuleJson;