"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,n)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyMergeProfile=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs=__importStar(require("fs-extra")),common_const_js_1=require("../../const/common-const.js"),sdk_const_js_1=require("../../const/sdk-const.js"),merge_type_rule_js_1=require("../../enum/merge-type-rule.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),abstract_merge_profile_js_1=require("../abstract-merge-profile.js"),task_names_js_1=require("../common/task-names.js"),legacy_pre_build_js_1=require("./legacy-pre-build.js");var LegacyFATask=task_names_js_1.TaskNames.LegacyFATask;const device_type_const_1=require("../../const/device-type-const"),har_target_util_js_1=require("../../utils/har-target-util.js"),json_util_js_1=require("../../utils/json-util.js"),JS_SHELL_PACKAGE="com.example.myapplication";class LegacyMergeProfile extends abstract_merge_profile_js_1.AbstractMergeProfile{constructor(e){super(e,LegacyFATask.MERGE_PROFILE),this._log=ohos_logger_js_1.OhosLogger.getLogger(LegacyMergeProfile.name),this._harLibs=this.mergeDependsLibs(common_const_js_1.CommonConst.CONFIG_JSON);const t=this.service.getModuleModel().getSourceSetByTargetName(this._targetName);this._moduleTargetRes=t.getLegacyModuleTargetRes(),this._mergedModuleJson=this._pathInfo.getIntermediatesMergeLegacyProfile()}initTaskDepends(){this.declareDepends(legacy_pre_build_js_1.LegacyPreBuild.name)}initHarModuleDepends(){har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).forEach((e,t)=>this.declareDepends(`${e}@${LegacyFATask.MERGE_PROFILE.name}`,t))}mergeDslConfig(e){var t,r,i;this._bundleName&&(e.app.bundleName=this._bundleName,this._appBundleName=this._bundleName),this._vendor&&(e.app.vendor=this._vendor,this._log.debug(`Change app vendor with '${this._vendor}'.`));const n=this.targetData.getApiMeta(),s=!![n.compileSdkVersion.version,n.compatibleSdkVersion.version,null!==(r=null===(t=n.targetSdkVersion)||void 0===t?void 0:t.version)&&void 0!==r?r:n.compileSdkVersion.version].find(e=>e<=sdk_const_js_1.ApiVersion.API_VERSION_9),o=null!==(i=n.targetSdkVersion)&&void 0!==i?i:n.compileSdkVersion,a=this.targetData.isHarmonyOS()?this.apiTransform(o):o.version,l=this.targetData.isHarmonyOS()?this.apiTransform(n.compatibleSdkVersion):n.compatibleSdkVersion.version,u=this.targetData.isHarmonyOS()?common_const_js_1.CommonConst.HARMONY_OS:common_const_js_1.CommonConst.OPEN_HARMONY,c=this.sdkInfo.getToolchainsComponentVersion();e.app.apiVersion={compileSdkVersion:c,compileSdkType:u,target:s?o.version:a,compatible:s?n.compatibleSdkVersion.version:l,releaseType:this.sdkInfo.getReleaseType()},this._log.debug(`Change app target API version with '${e.app.apiVersion.target}'`),this._log.debug(`Change app minimum API version with '${e.app.apiVersion.compatible}'`),this._log.debug(`Change app releaseType with '${this.sdkInfo.getReleaseType()}'`)}doTaskAction(){const e=(0,wdk_1.cloneDeep)(this._moduleTargetRes.getConfigJsonOpt());this.mergeAsanAndTsan(e),this.mergeAppEnvironmentConfig(e),this._appBundleName=e.app.bundleName;const t=this._harLibs.map(e=>fs.pathExistsSync(e)?json_util_js_1.JsonUtil.getJson5Obj(e):(this._log.warn(`${e} not found, The library will not be merged.\n         Check the configuration of this module.`),null)),r=this.mergeAllConfigOpt(e,t);if(this.mergeDslConfig(r),this.targetService.isDebug()){void 0===r.deviceConfig.default&&(r.deviceConfig.default={}),r.deviceConfig.default.debug=!0}this.supportLiteDeviceModule(r)&&!r.module.package&&(r.module.package=JS_SHELL_PACKAGE),fs.outputJSONSync(this._mergedModuleJson,r,{spaces:"\t"})}mergeAsanAndTsan(e){this.asanEnable&&(e.app.asanEnabled=this.asanEnable),this.tsanEnable&&(e.app.tsanEnabled=this.tsanEnable),this.hwAsanEnable&&(e.app.hwasanEnabled=this.hwAsanEnable),this.ubsanEnable&&(e.app.ubsanEnabled=this.ubsanEnable)}mergeAppEnvironmentConfig(e){var t;const r=this.parseToAppEnvironments(this.appEnvironments);if(void 0!==e.app.appEnvironments&&0!==e.app.appEnvironments.length){this._log.debug("Change app appEnvironment");const i=new Map;r.forEach(e=>{i.set(e.name,e.value)}),null===(t=e.app.appEnvironments)||void 0===t||t.forEach(e=>{i.set(e.name,e.value)}),e.app.appEnvironments=Array.from(i,([e,t])=>({name:e,value:t}))}else this._log.debug("Use cli appEnvironment"),e.app.appEnvironments=r}supportLiteDeviceModule(e){const t=e.module.deviceType;return t&&(t.includes(device_type_const_1.DeviceTypeConst.LITE_WEARABLE)||t.includes(device_type_const_1.DeviceTypeConst.SMART_VISION))}mergeAllConfigOpt(e,t){var r,i,n,s,o;for(let a=0;a<t.length;a++){const l=t[a];null!==l&&((null===(r=l.app.apiVersion)||void 0===r?void 0:r.compatible)&&(null===(i=e.app.apiVersion)||void 0===i?void 0:i.compatible)&&(null===(n=l.app.apiVersion)||void 0===n?void 0:n.compatible)>(null===(s=e.app.apiVersion)||void 0===s?void 0:s.compatible)&&this._log.printErrorExit("COMPATIBLE_VERSION_TOO_LOW",[l.module.name||(null===(o=l.module.distro)||void 0===o?void 0:o.moduleName)||""],[[l.app.apiVersion.compatible]]),e=this.mergeModel(e,l,"config",a===t.length-1))}return e}mergeModel(e,t,r,i){if(LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepHapOptions,r)||void 0===t)return e;if(void 0===e)return t;return(0,wdk_1.union)(Object.keys(e),Object.keys(t)).forEach(n=>{const s=e[n],o=t[n];s&&o&&typeof s!=typeof o&&this._log.printErrorExit("TYPE_OF_VALUE_IN_CONFIG_IS_NOT_SAME",[n,this.moduleName]),this.checkFieldRule(e,t,n,r);switch(void 0===s?typeof o:typeof s){case"boolean":LegacyMergeProfile.handleBooleanMerge(e,s,o,n);break;case"string":case"number":LegacyMergeProfile.handleStringOrNumberMerge(e,s,o,n,r);break;case"object":Array.isArray(s)||Array.isArray(o)?this.handleArrayMerge(e,s,o,n,r,i):LegacyMergeProfile.enumInclude(merge_type_rule_js_1.IsMapFields,n)?this.handleMapMerge(e,s,o,n,r,i):e[n]=this.mergeModel(s,o,n,i);break;default:this._log.error("An unrecognized type!")}}),e}mergeList(e,t,r,i){let n=[];if("skills"===r)return e;switch(0===e.length?typeof t[0]:typeof e[0]){case"string":n=(0,wdk_1.union)(e,t);break;case"object":LegacyMergeProfile.enumInclude(merge_type_rule_js_1.HasPlaceholderOptions,r)&&(e.forEach(e=>this.disposePlaceHolder(e,r)),t.forEach(e=>this.disposePlaceHolder(e,r))),e.forEach(e=>{null===this.findObjectByUniqueKey(t,e,r)&&n.push(e)}),t.forEach(t=>{const s=this.findObjectByUniqueKey(e,t,r);if(null===s)n.push(t);else{const e=this.mergeModel(s,t,r,i);n.push(this.mergeRule(e,s))}});break;default:this._log.error(`Other Type! ${r}`)}if(i)for(const e of n)Object.keys(e).includes("mergeRule")&&(e.mergeRule=void 0);return n}findObjectByUniqueKey(e,t,r){const i=LegacyMergeProfile.getUniqueKey(t,r);for(const n of e){const e=LegacyMergeProfile.getUniqueKey(n,r);if("abilities"===r){const e=t.targetAbility,r=n.targetAbility;!e&&r&&e===i&&this._log.printErrorExit("TARGET_ABILITY_NAME_CONFLICT",[e,this.moduleName])}if(i===e)return n}return null}static getUniqueKey(e,t){var r;if(LegacyMergeProfile.enumInclude(merge_type_rule_js_1.UniqueKeyEqualsName,t))return e.name;switch(t){case"shortcuts":return e.shortcutId;case"abilities":return null!==(r=e.targetAbility)&&void 0!==r?r:e.name;default:return null}}mergeRule(e,t){if(null===t||void 0===t.mergeRule)return e;const r=t.mergeRule;if(r.replace){r.replace.forEach(r=>{e[r]&&(e[r]=t[r])})}if(r.remove){r.remove.forEach(t=>{e[t]&&(e[t]=void 0)})}return e}mergeMap(e,t,r,i,n){if(void 0===e)return e;if(void 0===t)return t;const s=(0,wdk_1.cloneDeep)(e),o=Object.keys(e),a=Object.keys(t),l=(0,wdk_1.difference)(a,o);r&&l.forEach(e=>{s[e]=t[e]});return(0,wdk_1.intersection)(a,o).forEach(r=>{Array.isArray(e[r])?s[r]=(0,wdk_1.union)(e[r],t[r]):"object"==typeof e[r]&&(s[r]=this.mergeModel(e[r],t[r],i,n))}),s}checkFieldRule(e,t,r,i){if(!LegacyMergeProfile.enumInclude(merge_type_rule_js_1.IsNeedMergeRule,i)||LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepAbilityMergeList,i)||"skills"===r)return;const n=e[r],s=t[r];if(void 0!==n&&void 0!==s&&!(0,wdk_1.isEqual)(n,s)){const t=e.mergeRule;if(!(0,wdk_1.union)(t.replace,t.remove).includes(r)){const e=LegacyMergeProfile.getUniqueKey(n,i);this._log.printErrorExit("MERGE_RULE_CONFLICT",[i,e,r,this.moduleName])}}}disposePlaceHolder(e,t){return Object.keys(e).forEach(r=>{!LegacyMergeProfile.enumInclude(merge_type_rule_js_1.NeedDisposePlaceholder,r)||"abilities"===t&&"name"===r||this.replaceAppBundleName(e,r)}),e}replaceAppBundleName(e,t){var r;const i=e[t];if("string"==typeof i)e[t]=i.replace("{bundleName}",this._appBundleName);else if(Array.isArray(i)&&0!==i.length)if("string"==typeof i[0]){const r=[];for(const i of e[t])r.push(i.replace("{bundleName}",this._appBundleName));e[t]=r}else{const i=[];for(const n of e[t])n.name=null===(r=n.name)||void 0===r?void 0:r.replace("{bundleName}",this._appBundleName),i.push(n);e[t]=i}}static enumInclude(e,t){return Object.values(e).includes(t)}static handleBooleanMerge(e,t,r,i){LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepOneOfThem,i)&&(e[i]=void 0===t&&void 0!==r?r:t)}static handleStringOrNumberMerge(e,t,r,i,n){let s=void 0===t&&void 0!==r?r:t;"deviceConfig"!==n&&"module"!==n||(s=t),e[i]=s}handleArrayMerge(e,t,r,i,n,s){const o=Array.isArray(t)?t:[],a=Array.isArray(r)?r:[];let l;l="module"===n&&LegacyMergeProfile.enumInclude(merge_type_rule_js_1.KeepModuleAttr,i)?[...o]:this.mergeList(o,a,i,s),0!==l.length&&(e[i]=l)}handleMapMerge(e,t,r,i,n,s){let o=!0;"config"===n&&(o=!1,void 0===t.default&&void 0!==r.default&&(void 0===r.default.allowComponentsProxy?r.default=void 0:t.default={})),e[i]=this.mergeMap(t,r,o,i,s)}declareInputFiles(){const e=new hvigor_1.FileSet;return e.addEntry(this._moduleTargetRes.getJsonPath()),this._harLibs.forEach(t=>{fs.existsSync(t)&&e.addEntry(t)}),e}declareOutputFiles(){return(new hvigor_1.FileSet).addEntry(this._mergedModuleJson)}}exports.LegacyMergeProfile=LegacyMergeProfile;