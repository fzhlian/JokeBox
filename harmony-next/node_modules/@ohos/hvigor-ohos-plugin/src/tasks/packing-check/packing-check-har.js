"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackingCheckHar=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),common_const_js_1=require("../../const/common-const.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_names_js_1=require("../common/task-names.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),ohos_har_task_js_1=require("../task/ohos-har-task.js");var Task=task_names_js_1.TaskNames.Task;const packing_check_util_js_1=require("../../utils/validate/packing-check-util.js"),hvigor_common_1=require("@ohos/hvigor-common"),hvigor_logger_1=require("@ohos/hvigor-logger");class PackingCheckHar extends ohos_har_task_js_1.OhosHarTask{constructor(e){var t,i;super(e,Task.PACKING_CHECK_HAR),this._log=ohos_logger_js_1.OhosLogger.getLogger(task_names_js_1.TaskNames.Task.PACKING_CHECK_HAR.name);const s=e.getTargetData().getTargetName();this.moduleRoot=this.targetService.getTargetData().getPathInfo().getModulePath(),this.releaseWhiteListTemDir=path_1.default.resolve(this.moduleRoot,common_const_js_1.CommonConst.RELEASE_HAR_WHITE_LIST_DIR_NAME),this.byteCodeHarAbcOutputDir=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),code_type_enum_js_1.CodeType.ETS),this.originalEtsPath=null!==(i=null===(t=this.moduleModel.getSourceSetByTargetName(s).getCodeMap().get(code_type_enum_js_1.CodeType.ETS))||void 0===t?void 0:t.getSrcPath())&&void 0!==i?i:"",this.packageHarTempDir=this.getTaskTempDir(this.targetData,`${this.targetService.getTargetData().getTargetName()}@PackageHar`,!1)}taskShouldDo(){var e,t;const i=this._harExtendInfo.isObfuscatedHar()||this.targetService.isByteCodeHar();return(null===(t=null===(e=this.targetService.getBuildOption().packOptions)||void 0===e?void 0:e.enableSourceCodeCheck)||void 0===t||t)&&i}doTaskAction(){const e=[];e.push(...packing_check_util_js_1.PackingCheckUtil.recoverOriginalPath(packing_check_util_js_1.PackingCheckUtil.collectSourceCodeFiles(this.releaseWhiteListTemDir),this.releaseWhiteListTemDir));const t=[".c",".h",".cpp",".cs",".java",".rs",".py",".go",".ets",".ts"],i=e=>t.some(t=>e.endsWith(t));packing_check_util_js_1.PackingCheckUtil.getResourcePaths(this.targetService).forEach(t=>{const s=path_1.default.resolve(this.packageHarTempDir,path_1.default.relative(this.moduleRoot,t)),o=packing_check_util_js_1.PackingCheckUtil.recoverPackagedFiles(packing_check_util_js_1.PackingCheckUtil.collectSourceCodeFiles(t,i),s);e.push(...packing_check_util_js_1.PackingCheckUtil.recoverOriginalPath(o,t))}),this.targetService.isByteCodeHar()?this.collectSourceCodeFilesForByteCodeHar(e):this._harExtendInfo.isObfuscatedHar()&&this.collectSourceCodeFilesForObfuscatedHar(e);const s=(0,hvigor_common_1.getOsLanguage)(),o=`${(0,hvigor_logger_1.getUrl)(hvigor_logger_1.DEVELOPER_URL)}/consumer/${s}/doc/harmonyos-guides/ide-hvigor-build-profile-app#section03812484215`;0!==e.length&&this._log.warn(`Unexpected source code files packaged in '${this.moduleName}'. Please remove them if not needed. Reference: ${o}\nIf the checking is not needed, you can set buildOption/packOptions/enableSourceCodeCheck to false at file: ${this.projectModel.getProfilePath()}\n${e.join("\n")}`),packing_check_util_js_1.PackingCheckUtil.clearResourceFilesCache()}initTaskDepends(){}collectSourceCodeFilesForByteCodeHar(e){const t=packing_check_util_js_1.PackingCheckUtil.collectSourceCodeFiles(this.byteCodeHarAbcOutputDir);e.push(...packing_check_util_js_1.PackingCheckUtil.recoverOriginalPath(t,this.originalEtsPath))}collectSourceCodeFilesForObfuscatedHar(e){if(!fs_extra_1.default.existsSync(this.pathInfo.getInterMediatesLoaderOutPath()))return;const t=[".c",".h",".cpp",".cs",".java",".rs",".py",".go",".ets"],i=packing_check_util_js_1.PackingCheckUtil.collectSourceCodeFiles(this.pathInfo.getInterMediatesLoaderOutPath(),e=>t.some(t=>e.endsWith(t))&&!e.endsWith(".d.ets"));e.push(...packing_check_util_js_1.PackingCheckUtil.recoverOriginalPath(i,this.originalEtsPath))}}exports.PackingCheckHar=PackingCheckHar;