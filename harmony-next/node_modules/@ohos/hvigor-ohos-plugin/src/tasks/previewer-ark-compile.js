"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreviewerArkCompile=void 0;const path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),json_util_js_1=require("../utils/json-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),ohmurl_utils_js_1=require("../utils/ohmurl-utils.js"),reuse_watch_worker_js_1=require("../utils/previewer/reuse-watch-worker.js"),task_util_js_1=require("../utils/task-util.js"),ark_compile_js_1=require("./ark-compile.js"),task_names_js_1=require("./common/task-names.js"),preview_update_assets_js_1=require("./preview-update-assets.js");var WorkerType,CommonTask=task_names_js_1.TaskNames.CommonTask;!function(e){e[e.INVALID=0]="INVALID",e[e.NORMAL=1]="NORMAL",e[e.WATCH=2]="WATCH"}(WorkerType||(WorkerType={}));class PreviewerArkCompile extends ark_compile_js_1.ArkCompile{constructor(){super(...arguments),this.logger=ohos_logger_js_1.OhosLogger.getLogger(PreviewerArkCompile.name)}declareInputFiles(){return this.moduleModel.isHarModule()?super.declareInputFiles().deleteEntry(this.aceBuildJsonDir):super.declareInputFiles()}async doTaskAction(){const e=hvigor_1.hvigorCore.getExtraConfig().get("pageType"),t=await this.getPreviewCompileConfig(this.logger),r=this.getWorkerType(e);if(r===WorkerType.NORMAL||r===WorkerType.WATCH){const o={modulePath:t.modulePath,pageType:null!=e?e:common_const_js_1.PageType.PAGE,pagesPath:this.getShouldCompilePages(null!=e?e:common_const_js_1.PageType.PAGE)},s=r===WorkerType.NORMAL;if(!await reuse_watch_worker_js_1.ReuseWatchWorkerManager.reuseWatchWorker(o,s,this.getPreviewPagePath())){this.logger.debug("Can not reuse worker, create new worker for preview");const r=await this.generateWorkerConfig(t,e);reuse_watch_worker_js_1.ReuseWatchWorkerManager.createWorker(o,s,()=>this.createPreviewWorker(s,r))}}this.addOhmurlToHarAbility(),(0,task_util_js_1.warnCreateBuildProfileTask)(this.targetData,this.targetService,this._log)}getPreviewPagePath(){const e=this.pathInfo.getBuildConfigPath(!0);if(fs_extra_1.default.existsSync(e)){return fs_extra_1.default.readJsonSync(e).previewPagePath||""}return""}getShouldCompilePages(e){const t=this.pathInfo.getModulePreviewIntermediatesProfilePath(),r=this.moduleModel.getSourceRootByTargetName(this.targetName);if(e===common_const_js_1.PageType.PAGE){const e=path_1.default.resolve(t,build_directory_const_js_1.BuildArtifactConst.MAIN_PAGES_JSON);if(fs_extra_1.default.existsSync(e)){return fs_extra_1.default.readJsonSync(e).src.map(e=>path_1.default.normalize(path_1.default.join(r,common_const_js_1.CommonConst.ETS,`${e}.ets`)))}}else{const e=path_1.default.resolve(t,build_directory_const_js_1.BuildArtifactConst.FORM_CONFIG_JSON);if(fs_extra_1.default.existsSync(e)){return fs_extra_1.default.readJsonSync(e).forms.map(e=>path_1.default.normalize(path_1.default.join(r,e.src)))}}return[]}async generateWorkerConfig(e,t){var r;const o=this.getBlockDependencies().map(e=>e.getDependencyName());return e.pkgNameToPkgBriefInfo=this.pkgNameToPkgBriefInfo,e.otherPaths=this.getTscAddressPaths(e.aceModuleRoot),e.compileBlockPkg=o,t&&t!==common_const_js_1.PageType.PAGE?{...e,widgetCompile:"true",cachePath:path_1.default.resolve(null!==(r=e.cachePath)&&void 0!==r?r:this.getTaskTempDir(this.targetData,"_widget"),"widget"),port:void 0}:e}getWorkerType(e){if(e&&e!==common_const_js_1.PageType.PAGE)return this.needSubmitArkTsWidget&&e===common_const_js_1.PageType.CARD?WorkerType.WATCH:WorkerType.INVALID;{const e="true"===hvigor_1.hvigorCore.getExtraConfig().get("compileHspDependencies"),t=hvigor_1.hvigorCore.getExtraConfig().get("mainModule");return e&&t!==this.moduleName?WorkerType.NORMAL:WorkerType.WATCH}}createPreviewWorker(e,t){const r=e?hvigor_1.normalWorker:hvigor_1.watchWorker,o=path_1.default.resolve(__dirname,"./worker/preview-build.js"),s=r.createWorker(this,o,!0,e=>this.handleCompileEvents(e,this.getSubDurationEvent(s),!0),{workerData:{projectConfig:t,logLevel:this.logger.getLevel().levelStr}});return s}addOhmurlToHarAbility(){var e;const t=json_util_js_1.JsonUtil.getJson5Obj(this.pathInfo.getPreviewIntermediatesResModuleJsonPath()),r=this.moduleModel.getModule().getNodeDir();for(const o of[common_const_js_1.AbilityConst.UI_ABILITY,common_const_js_1.AbilityConst.EXTENSION_ABILITY]){const s=null===(e=null==t?void 0:t.module)||void 0===e?void 0:e[o];if(!(null==s?void 0:s.length))continue;const i=this.getDependencyHarAbility(o);null==s||s.forEach(e=>{if(!e.srcEntry)return;const t=path_1.default.resolve(r,build_directory_const_js_1.BuildDirConst.SRC_MAIN,e.srcEntry);Object.assign(e,{ohmurl:(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(this.targetService.getPkgContextInfo(this.packageJsonObj.name),t.substring(r.length+1))});const o=i.find(t=>t.name===e.name);o&&Object.assign(e,o)}),Object.assign(t.module,{[o]:s})}fs_extra_1.default.writeFileSync(this.pathInfo.getPreviewIntermediatesResModuleJsonPath(),JSON.stringify(t))}getDependencyHarAbility(e){const t=path_1.default.resolve(this.moduleModel.getModule().getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN),r=[];return this.service.getHarDependencies().forEach(o=>{const s=o.getModuleJsonObj(),i=null==s?void 0:s.module[e];(null==i?void 0:i.length)&&i.forEach(e=>{const s=(0,wdk_1.cloneDeep)(e);if(!s.srcEntry)return;const i=path_1.default.resolve(o.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,s.srcEntry);Object.assign(s,{srcEntry:path_1.default.relative(t,i),ohmurl:(0,ohmurl_utils_js_1.generateOhmurlForSrcEntry)(this.targetService,this.moduleName,o,s.srcEntry)}),r.push(s)})}),r}allowToPreloadSystemSo(){return!1}initTaskDepends(){this.declareDepends(preview_update_assets_js_1.PreviewUpdateAssets.name),(0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_9)&&this.declareDepends(CommonTask.CREATE_BUILD_PROFILE.name)}}exports.PreviewerArkCompile=PreviewerArkCompile;