"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SignApp=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),common_const_js_1=require("../const/common-const.js"),sign_type_enum_js_1=require("../enum/sign-type-enum.js"),file_util_js_1=require("../utils/file-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),package_app_js_1=require("./package-app.js"),sign_packages_from_app_js_1=require("./sign-packages-from-app.js"),sign_model_js_1=require("./sign/command-builder-impl/sign-model.js"),sign_util_js_1=require("./sign/sign-util.js"),ohos_app_task_js_1=require("./task/ohos-app-task.js");class SignApp extends ohos_app_task_js_1.OhosAppTask{constructor(t,e){super(t,e,task_names_js_1.TaskNames.CommonTask.SIGN_APP),this.log=ohos_logger_js_1.OhosLogger.getLoggerWithDurationId(SignApp.name,this.durationEvent.getId()),this.pathInfo=this.service.getPathInfo()}get appWithSignedPkg(){var t,e;return null!==(e=null===(t=this.service.getBuildOption().packOptions)||void 0===t?void 0:t.appWithSignedPkg)&&void 0!==e&&e}async beforeAlwaysAction(){var t;this.signUtil=new sign_util_js_1.SignUtil(this.service,sign_type_enum_js_1.SignTypeEnum.APP,this.pathInfo,this.service.getTargetProduct(),this.service.getSdkInfo()),this.signingConfig=this.signUtil._signingConfig,this.log.debug("signingConfigName of signApp is : ",null===(t=this.signUtil._signingConfig)||void 0===t?void 0:t.name),this.log.warn(this.signUtil._signingConfigCheckLogStr)}declareInputs(){return sign_util_js_1.SignUtil.getSigningConfigInputs(this.service.getSdkInfo(),this.signingConfig).set("appWithSignedPkg",this.appWithSignedPkg)}declareInputFiles(){if(this.signUtil){const t=this.signUtil.getSigningConfigInputFiles().addEntry(path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAppOutputFileName()),{isDirectory:!1}),e=path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAllAppOutputFileName());return fs_extra_1.default.existsSync(e)&&t.addEntry(path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAllAppOutputFileName()),{isDirectory:!1}),t}return super.declareInputFiles()}declareOutputFiles(){const t=super.declareOutputFiles(),e=path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAppOutputFileName(!0));if(e&&t.addEntry(e,{isDirectory:!1}),this.appWithSignedPkg){const e=path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAllAppOutputFileName(!0));t.addEntry(e,{isDirectory:!1})}return t}async doTaskAction(){const t=path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAppOutputFileName(!0)),e=path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAllAppOutputFileName(!0)),i=new sign_model_js_1.SignModel(sign_type_enum_js_1.SignTypeEnum.APP,path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAppOutputFileName()),t),s=new sign_model_js_1.SignModel(sign_type_enum_js_1.SignTypeEnum.APP,path_1.default.resolve(this.pathInfo.getProjectOutputPath(),this.service.getAllAppOutputFileName()),e);file_util_js_1.FileUtil.deleteFile(i.getOutPutFilePath()),file_util_js_1.FileUtil.deleteFile(s.getOutPutFilePath()),hvigor_1.hvigorCore.getParameter().getPropertyInternal(common_const_js_1.CommonConst.ENABLE_SIGN_TASK)&&(await this.signUtil.sign(i,this.durationEvent),this.appWithSignedPkg&&await this.signUtil.sign(s,this.durationEvent))}initTaskDepends(){this.dependsOn(package_app_js_1.PackageApp.name),this.dependsOn(sign_packages_from_app_js_1.SignPackagesFromApp.name)}}exports.SignApp=SignApp;