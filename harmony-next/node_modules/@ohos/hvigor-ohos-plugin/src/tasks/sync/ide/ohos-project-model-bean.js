"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhosProjectModelBean=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),hvigor_common_1=require("@ohos/hvigor-common"),project_ohos_config_manager_js_1=require("../../../common/global/project-ohos-config-manager.js"),common_const_js_1=require("../../../const/common-const.js"),ohos_plugin_id_js_1=require("../../../plugin/common/ohos-plugin-id.js"),project_build_profile_loader_js_1=require("../../../utils/loader/file/project-build-profile-loader.js"),path_1=__importDefault(require("path")),global_project_data_service_js_1=require("../../service/global-project-data-service.js"),project_model_impl_js_1=require("../../../model/project/project-model-impl.js");class OhosProjectModelBean{constructor(e){this.modelId="ohos-project",this._project=e;const o=e.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_APP_PLUGIN);this._projectTaskService=o.getTaskService()}computeCommonInfo(e){var o,t,r,i;const s=(0,wdk_1.cloneDeep)(null===(o=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===o?void 0:o.appOpt),c=this._projectTaskService.getTargetProduct(),l=this._projectTaskService.getPathInfo();e.set("SELECT_PRODUCT_NAME",c.name),e.set("MODULE_BUILD_DIR",l.getProjectBuildPath());let _=null!==(t=null==s?void 0:s.bundleName)&&void 0!==t?t:c.bundleName;if(void 0===_&&(_=this._projectTaskService.getProjectModel().getDefaultBundleName()),e.set("BUNDLE_NAME",_),this._projectTaskService.getProjectModel()instanceof project_model_impl_js_1.ProjectModelImpl){let o=null!==(r=null==s?void 0:s.versionCode)&&void 0!==r?r:this._projectTaskService.getProjectModel().getAppRes().getAppResOpt().app.versionCode,t=null!==(i=null==s?void 0:s.versionName)&&void 0!==i?i:this._projectTaskService.getProjectModel().getAppRes().getAppResOpt().app.versionName;o&&e.set("VERSION_CODE",o),t&&e.set("VERSION_NAME",t)}}computePathInfo(e){const o={OUTPUT_PATH:this._projectTaskService.getPathInfo().getProjectOutputPath()};e.set("BUILD_PATH",o)}computeModulesInfo(e){const o=(0,wdk_1.cloneDeep)(project_build_profile_loader_js_1.projectBuildProfileLoader.getBuildProfile().modules);o.forEach(e=>{var o,t,r;e.srcPath=path_1.default.resolve(this._project.getNodeDir(),e.srcPath),e.belongProjectPath=null===(r=null===(t=null===(o=this._projectTaskService.getProjectModel())||void 0===o?void 0:o.getSubModuleModels())||void 0===t?void 0:t.get(e.name))||void 0===r?void 0:r.getBelongProjectPath()}),e.set("MODULES",o)}computeProfileOpt(e){e.set("PROFILE_OPT",this._projectTaskService.getProjectModel().getProfileOpt())}computeConfigProperties(e){e.set("CONFIG_PROPERTIES",hvigor_1.hvigorCore.getParameter().getPropertiesInternal())}computeOverallProjectPaths(e){e.set("OVERALL_PROJECT_PATHS",global_project_data_service_js_1.GlobalProjectDataService.getInstance().getRootPathSet())}computeBuildDirInfo(e){var o;const t=null!==(o=hvigor_1.hvigorCore.getExtraConfig().get(common_const_js_1.CommonConst.BUILD_CACHE_DIR))&&void 0!==o?o:hvigor_1.HvigorConfigLoader.getInstance().getPropertiesConfigValue(common_const_js_1.CommonConst.BUILD_DIR_KEY);e.set("BUILD_CACHE_DIR",t||"")}buildModel(){const e=new Map;return this.computeCommonInfo(e),this.computePathInfo(e),this.computeModulesInfo(e),this.computeProfileOpt(e),this.computeConfigProperties(e),this.computeOverallProjectPaths(e),this.computeBuildDirInfo(e),(0,hvigor_common_1.strMapToObj)(e)}}exports.OhosProjectModelBean=OhosProjectModelBean;