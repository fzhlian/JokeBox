"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LibraryResolver=exports.ArchResolver=exports.PackageResolver=void 0;const fs_extra_1=__importDefault(require("fs-extra")),glob_1=require("glob"),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),common_const_js_1=require("../const/common-const.js"),cpu_abi_enum_js_1=require("../enum/cpu-abi-enum.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),cmake_util_js_1=require("./cmake/cmake-util.js"),hvigor_1=require("@ohos/hvigor"),minimatch_1=require("minimatch"),log=ohos_logger_js_1.OhosLogger.getLogger("ConfigureCmake");class PackageResolver{constructor(e,t,i,s){var a,r,n;this.archs=[],this.linkLibrariesMap=new Map,this.canonicalName=e.getPackageName(),this.name=this.canonicalName.replace(common_const_js_1.NativeConst.PACKAGE_NAME_REGEX,""),this.version=e.getDependencyVersion(),this.abiList=t,this.path=e.getDependencyRootPath(),this.cmakeDir=i,this.service=s,this.headerPath=this.getHeaderPath(e,s),this.libsPath=s?s.getTargetData().getPathInfo().getIntermediatesStrippedLibsDir():path_1.default.resolve(e.getDependencyRootPath(),"libs"),this.matchRule=(null!==(n=null===(r=null===(a=null==s?void 0:s.getBuildOption().nativeLib)||void 0===a?void 0:a.filter)||void 0===r?void 0:r.select)&&void 0!==n?n:[]).find(e=>e.package===this.canonicalName&&e.version===this.version),this.addLibrariesInfo(e.getPackageFilePath(),e.isLocal()),this.archs=this.abiList.map(e=>ArchResolver.getInstance(e,this))}static getInstance(e,t,i,s){return new PackageResolver(e,t,i,s)}async build(){const e=[];for(let t of this.archs)e.push(await t.build());return e}addLibrariesInfo(e,t){var i,s,a;const r=null===(a=null===(s=null===(i=this.service)||void 0===i?void 0:i.getBuildOption())||void 0===s?void 0:s.nativeLib)||void 0===a?void 0:a.librariesInfo;if(r&&r.length>0)for(const e of r)e.linkLibraries&&this.linkLibrariesMap.set(e.name,e.linkLibraries.join(";"));if(t||!fs_extra_1.default.existsSync(e))return;const n=hvigor_1.ParseJsonFile.parseJsonFile(e).nativeComponents;if(n&&n.length>0)for(const e of n)e.name&&e.linkLibraries&&this.linkLibrariesMap.set(e.name,e.linkLibraries.join(";"))}getHeaderPath(e,t){var i;const s=null===(i=null==t?void 0:t.getBuildOption().nativeLib)||void 0===i?void 0:i.headerPath;if(!s)return[path_1.default.resolve(e.getDependencyRootPath(),common_const_js_1.NativeConst.INCLUDE_DIR)];if("string"==typeof s)return path_1.default.isAbsolute(s)?[s]:[path_1.default.resolve(e.getDependencyRootPath(),s)];return s.map(t=>path_1.default.isAbsolute(t)?t:path_1.default.resolve(e.getDependencyRootPath(),t))}}exports.PackageResolver=PackageResolver;class ArchResolver{constructor(e,t){this.libraries=[],this.cmakeText="",this.arch=e,this.pkg=t,this.path=path_1.default.resolve(this.pkg.libsPath,e),this.cmakeFile=path_1.default.resolve(t.cmakeDir,e,"lib",cpu_abi_enum_js_1.CpuAbiEnum.getCpuType(e),"cmake",t.name,`${t.name}Config.cmake`)}static getInstance(e,t){return new ArchResolver(e,t)}async build(){return this.libraries=await this.calLibraries(),this}async calLibraries(){if(!this.pkg.service){if(fs_extra_1.default.existsSync(this.path)){log.debug(`Reading libs dir ${this.path}`);return glob_1.glob.sync(common_const_js_1.NativeConst.LIBRARY_FILE_PATTERN,{cwd:this.path}).filter(e=>path_1.default.basename(e)!==common_const_js_1.NativeConst.SHARED_STL_LIBRARY).map(e=>LibraryResolver.getInstance(path_1.default.basename(e),path_1.default.resolve(this.path,e),this))}return log.debug("No available libraries."),[]}const e=this.pkg.service.getTargetData(),t=e.getPathInfo().getNinjaWorkDir(),i=path_1.default.resolve(t,this.arch);if(log.debug(`Local module ${this.pkg.name}, reading cmake code model in ${i}.`),!fs_extra_1.default.existsSync(i))return log.warn(`not found cmake code model in ${i}`),[];const s=[...cmake_util_js_1.CmakeUtil.parseLibraries(i,e.getTargetName(),this.arch).values()].filter(e=>"STATIC_LIBRARY"===e.getType()||"SHARED_LIBRARY"===e.getType()),a=s.flatMap(e=>{var t;return null!==(t=e.getOutputs())&&void 0!==t?t:[]});return this.pkg.service.getModuleService().getModuleModel().isHspModule()&&a.push(...s.flatMap(e=>{var t;return null!==(t=e.getRuntimeFiles())&&void 0!==t?t:[]})),a.map(e=>path_1.default.isAbsolute(e)?e:path_1.default.resolve(t,this.arch,e)).filter(e=>e.includes(".so")||e.includes(".a")).map(e=>LibraryResolver.getInstance(path_1.default.basename(e),path_1.default.resolve(e),this))}}exports.ArchResolver=ArchResolver;class LibraryResolver{constructor(e,t,i){this.arch=i,this.nameOnDisk=e,this.name=this.tryGetLibraryName(),this.path=t,this.text=this.genPkgText()}static getInstance(e,t,i){return new LibraryResolver(e,t,i)}genPkgText(){const e=this.arch.pkg.matchRule;if(e&&this.isSoExcluded(e))return os_1.default.EOL;const t=`${this.arch.pkg.name}::${this.name}`;let i=`if(NOT TARGET ${t})`;const s=this.nameOnDisk.includes(".a")?"STATIC":"SHARED";i+=`${os_1.default.EOL}    add_library(${t} ${s} IMPORTED)`,i+=`${os_1.default.EOL}    set_target_properties(${t} PROPERTIES`;const a=this.arch.pkg.headerPath.filter(e=>fs_extra_1.default.existsSync(e)&&fs_extra_1.default.readdirSync(e).length>0).map(e=>e.replace(/\\/g,"/"));return a.length>0&&(i+=`${os_1.default.EOL}        INTERFACE_INCLUDE_DIRECTORIES "${a.join(";")}"`),i+=`${os_1.default.EOL}        IMPORTED_LOCATION "${this.path.replace(/\\/g,"/")}"`,this.arch.pkg.linkLibrariesMap.get(this.nameOnDisk)&&(i+=`${os_1.default.EOL}        INTERFACE_LINK_LIBRARIES "${this.arch.pkg.linkLibrariesMap.get(this.nameOnDisk)}"`),i+=`)${os_1.default.EOL}endif()${os_1.default.EOL}`,i}isSoExcluded(e){var t,i;return(null===(t=e.excludePattern)||void 0===t?void 0:t.some(e=>(0,minimatch_1.minimatch)(this.path,e,{dot:!0})))||(null===(i=e.exclude)||void 0===i?void 0:i.includes(this.nameOnDisk))}tryGetLibraryName(){const e=this.nameOnDisk.lastIndexOf(".so")>-1?this.nameOnDisk.lastIndexOf(".so"):this.nameOnDisk.lastIndexOf(".a"),t=this.nameOnDisk.toLowerCase().startsWith("lib")?3:0;return e>-1?this.nameOnDisk.substring(t,e):this.nameOnDisk.substring(t)}}exports.LibraryResolver=LibraryResolver;