"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.transformOhmUrlToPkgName=exports.generateOhmurlForSrcEntry=exports.removeSuffix=exports.generateOldOhmUrlForSo=exports.generateOhmUrlForSo=exports.getOldOhmUrlForSrcEntry=exports.generateOhmUrlForSourceFile=exports.generateOhmUrl=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),log=ohos_logger_js_1.OhosLogger.getLogger("ohmurl-utils"),SEPARATOR_BITWISE_AND="&",SEPARATOR_AT="@",SEPARATOR_SLASH="/";function generateOhmUrl(e){return`@normalized:${e.isSO?"Y":"N"}&${e.moduleName}&${e.bundleName}&${e.entryPath?`${e.packageName}/${removeSuffix(e.entryPath)}`:""}&${e.version}`}function generateOhmUrlForSourceFile(e,r){return`@normalized:${e.isSO?"Y":"N"}&${e.moduleName}&${e.bundleName}&${r?`${e.packageName}/${removeSuffix(r)}`:""}&${e.version}`}function getOldOhmUrlForSrcEntry(e,r,t){var o;const n=e.getModuleService().getProjectModel();return`@bundle:${null!==(o=e.getTargetData().getProduct().bundleName)&&void 0!==o?o:n.getDefaultBundleName()}/${t}/${removeSuffix(r.replace(/^\.\//,""))}`}function generateOhmUrlForSo(e,r){return`@normalized:${e.isSO?"Y":"N"}&${e.moduleName}&${e.bundleName}&${r?path_1.default.basename(r):""}&${e.version}`}function generateOldOhmUrlForSo(e,r,t){var o;const n=e.getModuleService().getProjectModel(),l=path_1.default.basename(r).replace(/^lib/,"");return`@app:${null!==(o=e.getTargetData().getProduct().bundleName)&&void 0!==o?o:n.getDefaultBundleName()}/${t}/${removeSuffix(l)}`}function removeSuffix(e){const r=e.split(path_1.default.sep).join("/"),t=[".d.ets",".d.ts",".d.mjs",".d.cjs",".d.js",".ets",".ts",".mjs",".cjs",".js",".so"].find(e=>r.endsWith(e)),o=t?r.substring(0,r.lastIndexOf(t)):r;return path_1.default.posix.normalize(o)}function generateOhmurlForSrcEntry(e,r,t,o){var n,l,a;let d,i;const s=e.getAbsoluteSrcEntryPath(o,t.getDependencyRootPath());if(!t.isByteCodeHarDependency()&&!fs_extra_1.default.existsSync(s))return log.debug("Failed to generate the ohmurl corresponding to the srcEntry that depends on the ability module. The srcEntry path for obtaining the ability of the module on which the module depends is incorrect or the corresponding file does not exist."),"";const u=e.getModuleService().getProjectModel(),g=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(t,u);if(t.isLocal()){if(!g)return log.debug("Failed to generate the ohmurl corresponding to the srcEntry that depends on the ability module. Failed to obtain the corresponding module model through the local dependency of the module."),"";i=s.substring(g.getModule().getNodeDir().length+1)}else i=s.substring(t.getDependencyRootPath().length+1);if(null===(l=null===(n=e.getBuildOption())||void 0===n?void 0:n.strictMode)||void 0===l?void 0:l.useNormalizedOHMUrl)d=generateOhmUrlForSourceFile(e.getPkgContextInfo(t.getDependencyName()),i);else{const n=null!==(a=e.getTargetData().getProduct().bundleName)&&void 0!==a?a:u.getDefaultBundleName(),l=removeSuffix(o.replace(/^\.\//,""));d=t.isLocal()?`@bundle:${n}/${r}@${g.getModule().getName()}/${l}`:`@bundle:${n}/${r}@${t.getDependencyName()}/${l}`}return d}function transformOhmUrlToPkgName(e){const r=e.split("&");if(r.length<4)throw new Error(`invalid ohmulr ${e}`);const t=r[3],o=t.split("/");return t.startsWith("@")?o.slice(0,2).join("/"):o[0]}exports.generateOhmUrl=generateOhmUrl,exports.generateOhmUrlForSourceFile=generateOhmUrlForSourceFile,exports.getOldOhmUrlForSrcEntry=getOldOhmUrlForSrcEntry,exports.generateOhmUrlForSo=generateOhmUrlForSo,exports.generateOldOhmUrlForSo=generateOldOhmUrlForSo,exports.removeSuffix=removeSuffix,exports.generateOhmurlForSrcEntry=generateOhmurlForSrcEntry,exports.transformOhmUrlToPkgName=transformOhmUrlToPkgName;