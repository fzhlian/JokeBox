"use strict";var __decorate=this&&this.__decorate||function(o,e,r,t){var i,s=arguments.length,n=s<3?e:null===t?t=Object.getOwnPropertyDescriptor(e,r):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(o,e,r,t);else for(var _=o.length-1;_>=0;_--)(i=o[_])&&(n=(s<3?i(n):s>3?i(e,r,n):i(e,r))||n);return s>3&&n&&Object.defineProperty(e,r,n),n},__importDefault=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.hvigorConfigInit=exports.hvigorConfig=exports.HvigorConfig=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),node_config_path_info_js_1=require("../../../common/node-config-path-info.js"),common_const_js_1=require("../../common/options/common-const.js"),hvigor_trace_factory_js_1=require("../../common/trace/hvigor-trace-factory.js"),hvigor_log_js_1=require("../../log/hvigor-log.js"),json5_reader_js_1=require("../../util/json5-reader.js"),validate_util_js_1=require("../../util/validate-util.js"),hvigor_node_descriptor_impl_js_1=require("../../vigor/plugin/impl/hvigor-node-descriptor-impl.js"),log=hvigor_log_js_1.HvigorLogger.getLogger("hvigor-config");class HvigorConfig{constructor(o){const e=path_1.default.resolve(o.getNodeDir(),common_const_js_1.HvigorCommonConst.BUILD_PROFILE_FILE),r=json5_reader_js_1.Json5Reader.getJson5Obj(e).modules;checkProjectConfigFile(o,r),this.allChildrenNodeDescriptor=[],r.forEach(o=>{validate_util_js_1.ValidateUtil.validateModule(o);const e=new hvigor_node_descriptor_impl_js_1.HvigorNodeDescriptorImpl(o.name,o.srcPath,void 0,this.rootNodeDescriptor);this.allChildrenNodeDescriptor.push(e)}),this.rootNodeDescriptor=new hvigor_node_descriptor_impl_js_1.HvigorNodeDescriptorImpl(o.getName(),o.getNodeDir(),this.allChildrenNodeDescriptor,void 0)}includeNode(o,e,r){this._includeNode(o,e,r)}includeNodeInternal(o,e,r){this._includeNode(o,e,r)}_includeNode(o,e,r){fs_1.default.existsSync(e)||log.printErrorExit("SOME_PATH_NOT_FOUND",[e],[[e]]),path_1.default.isAbsolute(e)&&log.printErrorExit("THE_SRCPATH_IS_NOT_A_RELATIVE_PATH",[e]);const t=new hvigor_node_descriptor_impl_js_1.HvigorNodeDescriptorImpl(o,e,void 0,this.rootNodeDescriptor);for(const o in r)Object.prototype.hasOwnProperty.call(r,o)&&t.extraOptions.set(o,r[o]);node_config_path_info_js_1.nodeConfigPathInfo.addModuleConfigPath(o,this.rootNodeDescriptor.srcPath),this.allChildrenNodeDescriptor.push(t),this.rootNodeDescriptor.setChildNode(this.allChildrenNodeDescriptor)}excludeNodeByName(o){this._excludeNodeByName(o)}excludeNodeByNameInternal(o){this._excludeNodeByName(o)}_excludeNodeByName(o){this.allChildrenNodeDescriptor.find(e=>e.name===o)||log.warn(`The Node to exclude '${o}' was not found.`),this.allChildrenNodeDescriptor=this.allChildrenNodeDescriptor.filter(e=>e.name!==o),this.rootNodeDescriptor.setChildNode(this.allChildrenNodeDescriptor),node_config_path_info_js_1.nodeConfigPathInfo.deleteModuleConfigPath(o)}getAllNodeDescriptor(){return this._getAllNodeDescriptor()}getAllNodeDescriptorInternal(){return this._getAllNodeDescriptor()}_getAllNodeDescriptor(){return this.allChildrenNodeDescriptor}getRootNodeDescriptor(){return this._getRootNodeDescriptor()}getRootNodeDescriptorInternal(){return this._getRootNodeDescriptor()}_getRootNodeDescriptor(){return this.rootNodeDescriptor}getNodeDescriptorByName(o){return this._getNodeDescriptorByName(o)}getNodeDescriptorByNameInternal(o){return this._getNodeDescriptorByName(o)}_getNodeDescriptorByName(o){return this.allChildrenNodeDescriptor.find(e=>e.name===o)}}function checkProjectConfigFile(o,e){Array.isArray(e)||log.printErrorExit("CHECK_PROJECT_CONFIG_ERROR",[common_const_js_1.HvigorCommonConst.BUILD_PROFILE_FILE,path_1.default.resolve(o.getNodeDir(),common_const_js_1.HvigorCommonConst.BUILD_PROFILE_FILE)]),e&&0!==e.length||log.printErrorExit("HVIGOR_CONFIG_NO_MODULES_FOUND",[path_1.default.resolve(o.getBuildProfilePath())],[[common_const_js_1.HvigorCommonConst.BUILD_PROFILE_FILE]])}function hvigorConfigInit(o){exports.hvigorConfig=new HvigorConfig(o)}__decorate([hvigor_trace_factory_js_1.TrackAPI],HvigorConfig.prototype,"includeNode",null),__decorate([hvigor_trace_factory_js_1.TrackAPI],HvigorConfig.prototype,"excludeNodeByName",null),__decorate([hvigor_trace_factory_js_1.TrackAPI],HvigorConfig.prototype,"getAllNodeDescriptor",null),__decorate([hvigor_trace_factory_js_1.TrackAPI],HvigorConfig.prototype,"getRootNodeDescriptor",null),__decorate([hvigor_trace_factory_js_1.TrackAPI],HvigorConfig.prototype,"getNodeDescriptorByName",null),exports.HvigorConfig=HvigorConfig,exports.hvigorConfigInit=hvigorConfigInit;