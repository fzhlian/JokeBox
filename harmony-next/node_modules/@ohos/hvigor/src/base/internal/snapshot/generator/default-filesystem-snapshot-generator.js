"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DefaultFilesystemSnapshotGenerator=void 0;const hvigor_common_1=require("@ohos/hvigor-common"),directory_snapshot_js_1=require("../core/directory-snapshot.js"),file_snapshot_js_1=require("../core/file-snapshot.js"),file_hasher_js_1=require("../util/file-hasher.js"),file_metadata_js_1=require("../util/file-metadata.js"),file_tree_js_1=require("../util/file-tree.js"),file_type_js_1=require("../util/file-type.js");class FileVisitorImpl{constructor(e){this.rootSnapShot=void 0,this.stack=[],this.fileHasher=e}preVisitDirectory(e){const t=new directory_snapshot_js_1.DirectorySnapshot(e.name,e.path,e.type,e.isSymbolicLink);if(void 0===this.rootSnapShot&&(this.rootSnapShot=t),this.stack.length>0){this.stack[this.stack.length-1].children.push(t)}this.stack.push(t)}visitFile(e){const t=new file_metadata_js_1.FileMetaData(e.size,e.lastModifiedTime),s=new file_snapshot_js_1.FileSnapshot(e.name,e.path,e.type,e.isSymbolicLink,t);if(s.hashValue=this.fileHasher.hash(e.path,t),void 0===this.rootSnapShot&&(this.rootSnapShot=s),this.stack.length>0){this.stack[this.stack.length-1].children.push(s)}}postVisitDirectory(e){const t=this.stack.pop();if(t&&t.children.length>0){t.children.sort((e,t)=>e.name.localeCompare(t.name));let e="";t.children.forEach(t=>{e+=t.name+t.hashValue}),t.hashValue=(0,hvigor_common_1.hash)(e)}}visitFileFailed(e,t){}}class DefaultFilesystemSnapshotGenerator{constructor(e=new file_hasher_js_1.FileMetaHasher){this.fileHasher=e}parseFileSystemSnapshot(e){var t,s,i,o,a,r,l;const n=e.type,h=null!==(t=e.hashValue)&&void 0!==t?t:"",p=null!==(s=e.name)&&void 0!==s?s:"",c=null!==(i=e.path)&&void 0!==i?i:"",_=null!==(o=e.isSymbolicLink)&&void 0!==o?o:"";if(n===file_type_js_1.FileType.FILE.toString()){const t=new file_metadata_js_1.FileMetaData,s=e.fileMetaData;if(s){const e=null!==(a=s.size)&&void 0!==a?a:0,i=null!==(r=s.lastModifiedTime)&&void 0!==r?r:0;t.size=e,t.lastModifiedTime=i}const i=new file_snapshot_js_1.FileSnapshot(p,c,file_type_js_1.FileType.FILE,_,t);return i.hashValue=h,i}if(n===file_type_js_1.FileType.DIRECTORY.toString()){const t=new directory_snapshot_js_1.DirectorySnapshot(p,c,file_type_js_1.FileType.DIRECTORY,_);t.hashValue=h;const s=null!==(l=e.children)&&void 0!==l?l:[];for(const e of s){const s=this.parseFileSystemSnapshot(e);void 0!==s&&t.children.push(s)}return t}}snapshot(e,t){var s;const i=new FileVisitorImpl(this.fileHasher),o={};return t&&t.test&&(o.filter=t.test),(0,file_tree_js_1.walkFileTree)(e,i,o),null!==(s=i.rootSnapShot)&&void 0!==s?s:new directory_snapshot_js_1.DirectorySnapshot("emptyroot","",file_type_js_1.FileType.UNKNOWN,!1)}loadSnapshotFromJson(e){let t;try{t=JSON.parse(e)}catch(e){return}return this.parseFileSystemSnapshot(t)}loadSnapshotCacheFromJson(e){let t;try{t=JSON.parse(e)}catch(e){return}const s=new Map;return Object.keys(t).forEach(e=>{const i=this.parseFileSystemSnapshot(t[e]);void 0!==i&&s.set(e,i)}),s}serializeSnapshotToJson(e){let t="{";return e.forEach((e,s)=>{t+=JSON.stringify(s)+":"+JSON.stringify(e)+","}),t.length>1&&(t=t.slice(0,t.length-1)),t+="}",t}}exports.DefaultFilesystemSnapshotGenerator=DefaultFilesystemSnapshotGenerator;