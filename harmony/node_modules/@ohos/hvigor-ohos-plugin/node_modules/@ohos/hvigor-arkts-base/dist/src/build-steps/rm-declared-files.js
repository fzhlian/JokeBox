"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,a)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeRedundantDeclaredFiles=exports.getModuleLastCachedSourceFiles=void 0;const path_1=__importDefault(require("path")),fse=__importStar(require("fs-extra"));function getModuleLastCachedSourceFiles(e){if(!e.declaredFilesPath||!e.cache||!e.modulePath)return[];const t=e.startEvent("get module last cached source files"),r=collectFilesByModulePath(e.cache,e.modulePath);return e.endEvent(t.getId()),r}async function removeRedundantDeclaredFiles(e,t,r,n,a){if(!(r&&n&&a&&t.length))return;const o=e.startEvent("remove redundant declared files"),i=difference(t,collectFilesByModulePath(a,n));if(!i.length)return void e.endEvent(o.getId());const l=new Set;for(const e of i){const t=getDeclaredFilePath(r,e,n);fse.existsSync(t)&&fse.realpathSync.native(t)===t&&(await fse.remove(t),l.add(path_1.default.dirname(t)))}for(const e of l)fse.existsSync(e)&&await removeEmptyDir(e,r);e.endEvent(o.getId())}function collectFilesByModulePath(e,t){if(!e.modules?.length)return[];const r=/(\.e?ts)$/;return e.modules.filter(e=>e.meta?.belongModulePath===t&&r.test(e.id)).map(e=>e.id)}function difference(e,t){const r=new Set(t);return e.filter(e=>!r.has(e))}function getDeclaredFilePath(e,t,r){const n=path_1.default.resolve(e,path_1.default.relative(r,t));return/(\.d\.e?ts)$/.test(n)?n:n.replace(/(\.e?ts)$/,".d$1")}async function removeEmptyDir(e,t){const r=path_1.default.relative(t,e);if(!r)return;const n=r.split(path_1.default.sep);for(;n.length;){const e=path_1.default.resolve(t,...n);if(!fse.existsSync(e))return;if((await fse.readdir(e)).length)return;await fse.remove(e),n.pop()}}exports.getModuleLastCachedSourceFiles=getModuleLastCachedSourceFiles,exports.removeRedundantDeclaredFiles=removeRedundantDeclaredFiles;