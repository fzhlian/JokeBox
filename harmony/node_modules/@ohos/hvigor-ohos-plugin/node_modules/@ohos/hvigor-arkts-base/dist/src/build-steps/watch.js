"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a);var r=Object.getOwnPropertyDescriptor(t,a);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,s,r)}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.writeWatchCache=exports.startWatch=void 0;const fs_1=__importDefault(require("fs")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),process_1=__importDefault(require("process")),fse=__importStar(require("fs-extra")),rollup_1=require("rollup"),rollup_cache_service_js_1=require("../cache/rollup/rollup-cache-service.js"),arkts_base_log_js_1=require("../log/arkts-base-log.js"),build_event_js_1=require("../util/build-event.js"),constants_js_1=require("../util/constants.js"),logger=arkts_base_log_js_1.ArktsBaseLogger.getLogger("build"),extensionSet=new Set([".ets",".ts","js",".mjs",".cjs"]);let triggerTsWatch,watchParentPort,watchCache,watchEnableFileSystemCache,watchCacheDirectory,lastWatchRes,tsWatchEnd=!1,rollupWatchEnd=!1,isWatchFirst=!0,pausePrintError=!1;const lastReUsedFiles=new Set;function handleWatchCompileFailed(e){if(isWatchFirst&&arkts_base_log_js_1.ArktsBaseLogger.checkLoggerHaveErrorInfo()){e(arkts_base_log_js_1.ArktsBaseLogger.getLogEvents().filter(e=>"error"===e.level).map(e=>e.msg).join(""))}}function handleWatchCompileSucceed(e,t){"BUNDLE_END"===e.code&&t(e?.result?.getTimings?{timing:e.result.getTimings()}:{})}async function startWatch(e,t,a,s,r,c,o,i,n,l){arkts_base_log_js_1.ArktsBaseLogger.addLastLogEvents(readWatchLogs(i)),arkts_base_log_js_1.ArktsBaseLogger.setLogCallback(a,processTsWatchEnd),watchParentPort=s;const h=new Set;return new Promise((a,s)=>{const _=(0,rollup_1.watch)(e);c(_),watchParentPort.on("message",e=>{"HOT_COMPILE"===e.event&&_.emit("event",{code:"HOT_COMPILE"}),"PAUSE_PRINT_ERR"===e.event&&(pausePrintError=e.data)}),_.on("event",e=>{switch(e.code){case"BUNDLE_START":watchParentPort?.postMessage({type:build_event_js_1.WatchEvent.WATCH_START}),validateUnsupportedChangedFiles(e.lastChangedFiles,n),updateTriggerTsWatchWithLastChangedFiles(e.lastChangedFiles);break;case"STOP_HOT_COMPILE":break;case"BUNDLE_END":const c=!!e.hotCompile;handleWatchCompileFailed(s),r(),updateCache(o,e.result.cache,i),hotReload(t,e.result.watchFiles,h),handleWatchCompileSucceed(e,a),updateLastReUsedFiles(e.lastReUsedFiles),processRollupWatchEnd(c);break;case"ERROR":s("Compilation failed"),arkts_base_log_js_1.ArktsBaseLogger.addLogEvent({time:new Date,category:"watch",level:"error",msg:e.error.message,type:constants_js_1.PLUGIN_LOG_TYPE}),!pausePrintError&&l&&l(e.error),processRollupWatchEnd()}})})}async function writeWatchCache(e){if(lastWatchRes){if(watchCacheDirectory&&fs_1.default.existsSync(watchCacheDirectory)){await rollup_cache_service_js_1.rollupCacheService.writeCache({enableFileSystemCache:watchEnableFileSystemCache,cache:watchCache,cacheDirectory:watchCacheDirectory,pkgName2SourceRoots:e,useTempFile:!1,usePathPlaceholder:!1});const t={close:()=>Promise.resolve(),cache:watchCache};await rollup_cache_service_js_1.rollupCacheService.onBuildEnd(watchCacheDirectory,t,void 0,lastWatchRes,e,void 0)}writeWatchLogs()}else rollup_cache_service_js_1.rollupCacheService.deleteCache(watchCacheDirectory),removeWatchLogs();watchCache=void 0,watchEnableFileSystemCache=void 0,watchCacheDirectory=void 0}function readWatchLogs(e){let t=[];const a=path_1.default.resolve(e??"",constants_js_1.DEFAULT_WATCH_LOGS_FILE);if(fs_1.default.existsSync(a))try{t=JSON.parse(fs_1.default.readFileSync(a).toString())}catch(e){logger.debug(`read watch logs failed ${e.message}`)}return t}function writeWatchLogs(){const e=path_1.default.resolve(watchCacheDirectory??"",constants_js_1.DEFAULT_WATCH_LOGS_FILE);try{fse.ensureFileSync(e),fs_1.default.writeFileSync(e,JSON.stringify(arkts_base_log_js_1.ArktsBaseLogger.getLastLogEvents()))}catch(e){logger.debug(`write watch logs failed ${e.message}`)}}function removeWatchLogs(){const e=path_1.default.resolve(watchCacheDirectory??"",constants_js_1.DEFAULT_WATCH_LOGS_FILE);fs_1.default.rmSync(e,{force:!0})}function clearWatchData(){triggerTsWatch=!1,tsWatchEnd=!1,rollupWatchEnd=!1,arkts_base_log_js_1.ArktsBaseLogger.clearLogEvents(),lastReUsedFiles.clear()}function sendWatchResult(e=!1){isWatchFirst=!1,arkts_base_log_js_1.ArktsBaseLogger.sendLastLogEvents(lastReUsedFiles),lastWatchRes=!arkts_base_log_js_1.ArktsBaseLogger.checkLoggerHaveErrorInfo();const t=e?{type:build_event_js_1.WatchEvent.WATCH_RESULT,content:lastWatchRes,hotCompile:"hotCompile"}:{type:build_event_js_1.WatchEvent.WATCH_RESULT,content:lastWatchRes};watchParentPort?.postMessage(t),clearWatchData()}function processTsWatchEnd(){tsWatchEnd=!0,rollupWatchEnd&&sendWatchResult()}function processRollupWatchEnd(e){rollupWatchEnd=!0,!tsWatchEnd&&triggerTsWatch||sendWatchResult(e)}function updateLastReUsedFiles(e){e.forEach(e=>lastReUsedFiles.add("Windows_NT"===os_1.default.type()?path_1.default.posix.join(...e.split(path_1.default.sep)):e))}function hotReload(e,t,a){e||(isWatchFirst?(t.forEach(e=>a.add(e)),sendHotReloadWatchFileList(t)):validateWatchScope(t,a))}function validateUnsupportedChangedFiles(e,t){for(const a of t)if(e.has(a))throw arkts_base_log_js_1.ArktsBaseLogger.addLogEvent({time:new Date,category:"watch",level:"error",msg:`${a} has been changed, which is not supported in watch mode. Please rebuild this module manually.`,type:constants_js_1.PLUGIN_LOG_TYPE}),new Error("Unsupported file changed in watch mode.")}function validateWatchScope(e,t){const a=(e="new files")=>{arkts_base_log_js_1.ArktsBaseLogger.addLogEvent({time:new Date,category:"watch",level:"error",msg:`Importing ${e} is not supported in hot reload mode. Please rebuild this module manually.`,type:constants_js_1.PLUGIN_LOG_TYPE})};if(e.length>t.size)a();else for(const s of e)if(!t.has(s))return void a(s)}function updateTriggerTsWatchWithLastChangedFiles(e){for(const t of e.keys())if(willTriggerTsWatch(t)){triggerTsWatch=!0;break}triggerTsWatch=void 0===triggerTsWatch||triggerTsWatch,process_1.default.env.triggerTsWatch=String(triggerTsWatch)}function updateCache(e,t,a){watchEnableFileSystemCache=e,watchCache=t,watchCacheDirectory=a}function willTriggerTsWatch(e){return extensionSet.has(path_1.default.extname(e))}function sendHotReloadWatchFileList(e){e&&watchParentPort?.postMessage({type:build_event_js_1.WatchEvent.WATCH_RESULT,content:JSON.stringify({isSuccess:!arkts_base_log_js_1.ArktsBaseLogger.checkLoggerHaveErrorInfo(),watchFiles:e})})}exports.startWatch=startWatch,exports.writeWatchCache=writeWatchCache;