"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.build=void 0;const rollup_1=require("rollup"),clean_ets_for_tgz_js_1=require("./build-steps/clean-ets-for-tgz.js"),process_importee_js_1=require("./build-steps/process-importee.js"),rm_declared_files_js_1=require("./build-steps/rm-declared-files.js"),rm_error_files_cache_js_1=require("./build-steps/rm-error-files-cache.js"),watch_js_1=require("./build-steps/watch.js"),rollup_cache_service_js_1=require("./cache/rollup/rollup-cache-service.js"),arkts_base_log_js_1=require("./log/arkts-base-log.js"),constants_js_1=require("./util/constants.js");async function build(e,t,r,s,a,c,l){(0,clean_ets_for_tgz_js_1.cleanEtsForTgz)(e,t),readCacheWithEvent(e,l);const o=(0,rm_declared_files_js_1.getModuleLastCachedSourceFiles)(e);rollup_cache_service_js_1.rollupCacheService.removeUncacheableModules(e);const i=e.compileEnv,n=e.writeRollupCache,d=!!e.disableGenerateBundle,u=void 0===e.writeBundle||e.writeBundle,_=e.watchMode??"false",h=e.unsupportedChangedFiles??[],{enableFileSystemCache:p,cacheDirectory:g,isPreview:m,pkgName2SourceRoots:v,isByteCodeHar:j,modulePath:C,declaredFilesPath:b,bundledDependencies:w,shouldCollectDirectImportees:f}=e;deleteOptions(e);const E=e.startEvent(constants_js_1.ROLLUP_EVENT_NAME);if("true"===_){const l=e=>{t.error(e)},o=await(0,watch_js_1.startWatch)(e,m??!1,r,s,a,c,p,g,h,l);return e.endEvent(E.getId()),o}const y=await(0,rollup_1.rollup)(e);if(e.endEvent(E.getId()),!d)for(const t of e.output)u?await y.write(t):await y.generate(t);await(0,process_importee_js_1.processImportees)(e,{isByteCodeHar:j,bundledDependencies:w,shouldCollectDirectImportees:f},C,g,y.cache),await(0,rm_declared_files_js_1.removeRedundantDeclaredFiles)(e,o,b,C,y.cache),await(0,rm_error_files_cache_js_1.removeCompileFailedFilesFromCache)(e,g,l,i,y.cache);const P=e.startEvent("write build package cache");n&&await rollup_cache_service_js_1.rollupCacheService.writeCache({enableFileSystemCache:p,cache:y.cache,cacheDirectory:g,pkgName2SourceRoots:v,cacheKey:i,cacheStoreManager:l,parentEvent:P,changedModules:y.changedModules,usePathPlaceholder:!0===e.usePathPlaceholder}),e.endEvent(P.getId());const F=e.startEvent("wait for plug-in registration asynchronous task to complete");return await y.triggerBundleEnd(),e.endEvent(F.getId()),arkts_base_log_js_1.ArktsBaseLogger.reset(),{timing:y.getTimings&&y.getTimings(),callback:async e=>{g&&await rollup_cache_service_js_1.rollupCacheService.onBuildEnd(g,y,i,e,v,l)}}}function deleteOptions(e){["disableGenerateBundle","writeBundle","enableFileSystemCache","cacheDirectory","watchMode","unsupportedChangedFiles","isPreview","compileEnv","extensions","pkgName2SourceRoots","resolveConflictMode","depName2RootPath","modulePath","isByteCodeHar","declaredFilesPath","bundledDependencies","shouldCollectDirectImportees","arkCompileCachePath","buildMode","writeRollupCache"].forEach(t=>{Reflect.deleteProperty(e,t)})}function readCacheWithEvent(e,t){const r=e.startEvent("read build package cache");rollup_cache_service_js_1.rollupCacheService.readCache(e,t),e.endEvent(r.getId())}exports.build=build;