"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var c=Object.getOwnPropertyDescriptor(t,a);c&&!("get"in c?!t.__esModule:c.writable||c.configurable)||(c={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,c)}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractFileCacheHandler=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),hvigor_common_1=require("@ohos/hvigor-common"),fse=__importStar(require("fs-extra")),arkts_base_log_js_1=require("../../../log/arkts-base-log.js"),pack_js_1=require("../../../util/msgpack/pack.js"),project_config_path_js_1=require("../../../util/project-config-path.js"),abstract_cache_handler_js_1=require("./abstract-cache-handler.js"),logger=arkts_base_log_js_1.ArktsBaseLogger.getLogger("AbstractFileCacheHandler"),FILE_NAME_MAX_LENGTH=241;class AbstractFileCacheHandler extends abstract_cache_handler_js_1.AbstractCacheHandler{constructor(e,t){super(e),this.cacheStoreManager=t}processCacheDir(e,t){fs_1.default.readdirSync(e).forEach(a=>{const r=path_1.default.join(e,a),c=(new pack_js_1.Packr).unpack(fs_1.default.readFileSync(r));(0,pack_js_1.resetPack)(),void 0!==t.cache&&!1!==t.cache&&this.handlerReadResult(t.cache,c,r)})}readCache(e){if(this.cacheStoreManager){if(this.cacheStoreManager.mount(e.compileEnv).getCache(path_1.default.dirname(this.getCacheAbsolutePath())))return void this.next?.readCache(e)}const t=this.getCacheAbsolutePath();try{fse.existsSync(t)&&fse.statSync(t).isDirectory()&&this.processCacheDir(t,e)}catch(e){logger.warn(`read cache file failed ${e.message}`)}(0,pack_js_1.resetPack)(),this.next?.readCache(e)}writeCache(e){const{cache:t,allModules:a,writePrm:r,packCacheEvent:c,changedModules:s,usePathPlaceholder:i}=e;this.writeFileCache(t,a,r,i,c,s),this.next?.writeCache(e)}getHashName(e){return`${`${path_1.default.basename(e)}-${(0,hvigor_common_1.hash)(project_config_path_js_1.projectConfigPath.projectTopPath?path_1.default.relative(project_config_path_js_1.projectConfigPath.projectTopPath,e):e)}`.slice(-241)}.msgpack`}}exports.AbstractFileCacheHandler=AbstractFileCacheHandler;