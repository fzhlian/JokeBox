"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.projectConfigPath=void 0;const fs_extra_1=__importDefault(require("fs-extra")),node_path_1=__importDefault(require("node:path")),PROJECT_PATH_PLACEHOLDER="%project_path%",SDK_UNDERLINE_PATH_PLACEHOLDER="%sdk_underline_path%",SDK_NATIVE_UNDERLINE_PATH_PLACEHOLDER="%sdk_native_underline_path%";class ProjectConfigPath{init(e,t){this.projectTopPath=e,this.sdkPath=t,this.sdkUnderlinePath=this.sdkPath?.replace(/\\/g,"_").replace(/\//g,"_"),this.sdkNativePath=fs_extra_1.default.realpathSync.native(this.sdkPath),this.sdkNativeUnderlinePath=this.sdkNativePath?.replace(/\\/g,"_").replace(/\//g,"_")}replacePluginsCachePath(e,t){t?this.handlePluginsCache(e,this.replaceToPlaceholder):this.handlePluginsCache(e,this.replaceToNativePath)}replaceModuleCachePath(e,t){if((e.id.includes("%project_path%")||t)&&void 0!==this.projectTopPath&&(t?this.handleModuleCache(e,this.replaceToPlaceholder):this.handleModuleCache(e,this.replaceToNativePath),e.meta.tsProgram&&e.meta.tsProgram.sourceFileToPackageName&&e.meta.tsProgram.sourceFileToPackageName instanceof Map)){const a=e.meta.tsProgram.sourceFileToPackageName,r=new Map;for(let e of a.keys())t?r.set(e.replace(this.projectTopPath.toLowerCase().replace(/\\/g,"/"),"%project_lower_path%"),a.get(e)??""):r.set(e.replace("%project_lower_path%",this.projectTopPath.toLowerCase()).replace(/\\/g,"/"),a.get(e)??"");e.meta.tsProgram.sourceFileToPackageName=r}}handlePluginsCache(e,t){for(let a in e)for(let r in e[a]){const o=t(r);o!==r&&(e[a][o]=e[a][r],delete e[a][r]),e[a][o].forEach((r,c)=>{"string"==typeof r?e[a][o][c]=t(r):"object"==typeof r?(this.replaceStringProperties(r,t),e[a][o][c]=r):e[a][o][c]=r})}}handleModuleCache(e,t){if(this.projectTopPath){e.id=t(e.id);const a=[];e.dependencies?.forEach(e=>{a.push(t(e))}),e.dependencies=a,e.meta.pkgPath=t(e.meta.pkgPath),e.meta.belongProjectPath=t(e.meta.belongProjectPath),e.meta.belongModulePath=t(e.meta.belongModulePath);const r=Object.keys(e.resolvedIds);for(const a of r){let r=t(a);if(a!==r){let t=e.resolvedIds[a];delete e.resolvedIds[a],e.resolvedIds[r]=t}e.resolvedIds[r].id=t(e.resolvedIds[r].id)}e.transformFiles?.forEach(e=>{"chunk"===e.type&&(e.id=t(e.id))});const o=[];e.transformDependencies.forEach(e=>{o.push(t(e))}),e.transformDependencies=o;const c=[];e.originalSourcemap?.sources.forEach(e=>{c.push(t(e))}),e.originalSourcemap?.sources&&(e.originalSourcemap.sources=c)}e.meta.commonjs&&this.replaceStringProperties(e.meta.commonjs,t),this.replaceImportCache(e,t),this.replaceExportAllDeclarationCache(e,t)}replaceExportAllDeclarationCache(e,t){e.cacheAst?.exportAllDeclarationCache&&(e.cacheAst.exportAllDeclarationCache.forEach(e=>{e.source&&(e.source.raw=e.source.raw.replace(/\\\\/g,"\\"))}),this.replaceStringProperties(e.cacheAst?.exportAllDeclarationCache,t),e.cacheAst.exportAllDeclarationCache.forEach(e=>{e.source&&(e.source.raw=e.source.raw.replace(/\\/g,"\\\\").replace("\\\\","\\"))}))}replaceImportCache(e,t){e.cacheAst?.importCache&&(e.cacheAst.importCache.forEach(e=>{e.source&&(e.source.raw=e.source.raw.replace(/\\\\/g,"\\"))}),this.replaceStringProperties(e.cacheAst?.importCache,t),e.cacheAst.importCache.forEach(e=>{e.source&&(e.source.raw=e.source.raw.replace(/\\/g,"\\\\").replace("\\\\","\\"))}))}replaceStringProperties(e,t){if("object"==typeof e&&null!==e)if(Array.isArray(e))e.forEach((a,r)=>{"string"==typeof a?e[r]=t(e[r]):"object"==typeof a&&null!==a&&this.replaceStringProperties(a,t)});else if(e instanceof Map)e.forEach((a,r)=>{const o=t(r);o!==r&&(e.set(o,a),e.delete(r)),"string"==typeof a?e.set(o,t(a)):"object"==typeof a&&null!==a&&this.replaceStringProperties(a,t)});else for(const a of Object.keys(e)){const r=t(a);if(r!==a&&(e[r]=e[a],delete e[a]),Object.prototype.hasOwnProperty.call(e,r)){const a=e[r];"string"==typeof a?e[r]=t(e[r]):"object"==typeof a&&null!==a&&this.replaceStringProperties(a,t)}}}replaceToNativePath(e){if(!e)return e;let t=exports.projectConfigPath.projectTopPath?e.replace("%project_path%",exports.projectConfigPath.projectTopPath):e;return t=exports.projectConfigPath.sdkUnderlinePath?t.replace("%sdk_underline_path%",exports.projectConfigPath.sdkUnderlinePath):t,t=exports.projectConfigPath.sdkNativeUnderlinePath?t.replace("%sdk_native_underline_path%",exports.projectConfigPath.sdkNativeUnderlinePath):t,t=exports.projectConfigPath.sdkPath?t.replace("%sdk_path%",exports.projectConfigPath.sdkPath.replace(/\\/g,node_path_1.default.sep).replace(new RegExp("/","g"),node_path_1.default.sep)):t,t}replaceToPlaceholder(e){if(!e)return e;let t=exports.projectConfigPath.projectTopPath?e.replace(exports.projectConfigPath.projectTopPath,"%project_path%"):e;return t=exports.projectConfigPath.sdkUnderlinePath?t.replace(exports.projectConfigPath.sdkUnderlinePath,"%sdk_underline_path%"):t,t=exports.projectConfigPath.sdkNativeUnderlinePath?t.replace(exports.projectConfigPath.sdkNativeUnderlinePath,"%sdk_native_underline_path%"):t,t=exports.projectConfigPath.sdkPath?t.replace(exports.projectConfigPath.sdkPath.replace(/\\/g,node_path_1.default.sep).replace(new RegExp("/","g"),node_path_1.default.sep),"%sdk_path%"):t,t}}exports.projectConfigPath=new ProjectConfigPath;