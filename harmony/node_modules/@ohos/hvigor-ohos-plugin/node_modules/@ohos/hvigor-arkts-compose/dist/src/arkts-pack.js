"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.watch=exports.compileCodeSnippet=exports.loadAceBuildJson=exports.getResolveModules=exports.runArkPack=void 0;const fs_1=__importDefault(require("fs")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),hvigor_arkts_base_1=require("@ohos/hvigor-arkts-base"),hvigor_logger_1=require("@ohos/hvigor-logger"),plugin_commonjs_1=__importDefault(require("@rollup/plugin-commonjs")),plugin_json_1=__importDefault(require("@rollup/plugin-json")),plugin_node_resolve_1=__importDefault(require("@rollup/plugin-node-resolve")),index_js_1=__importDefault(require("../src/plugins/node-resolve/index.js")),compile_event_factory_js_1=require("./analyzer/compile-event-factory.js"),compile_perf_js_1=require("./analyzer/compile-perf.js"),compose_error_js_1=require("./data/compose-error.js"),check_duplicate_filenames_plugin_js_1=require("./plugins/check-duplicate-filenames-plugin.js"),collect_importers_plugin_js_1=require("./plugins/collect-importers-plugin.js"),common_plugin_js_1=require("./plugins/common-plugin.js"),copy_plugin_js_1=__importDefault(require("./plugins/copy-plugin.js")),delete_plugin_js_1=__importDefault(require("./plugins/delete-plugin.js")),gc_plugin_js_1=require("./plugins/gc-plugin.js"),hsp_collect_har_files_js_1=require("./plugins/har-deduplicate/hsp-collect-har-files.js"),invalid_cache_plugin_js_1=require("./plugins/invalid-cache-plugin.js"),module_meta_info_plugin_js_1=require("./plugins/module-meta-info-plugin.js"),preview_resource_watcher_plugin_js_1=require("./plugins/preview-resource-watcher-plugin.js"),router_map_plugin_js_1=require("./plugins/router-map-plugin.js"),tsc_resolve_js_1=require("./plugins/tsc-resolve.js"),use_new_ohm_url_plugin_js_1=require("./plugins/use-new-ohm-url-plugin.js"),use_sensitive_check_plugin_js_1=require("./plugins/use-sensitive-check-plugin.js"),wait_async_plugin_js_1=require("./plugins/wait-async-plugin.js"),wrapper_chunk_plugin_js_1=require("./plugins/wrapper-chunk-plugin.js"),constants_js_1=require("./util/constants.js"),copy_resources_js_1=require("./util/copy-resources.js"),load_sdk_functions_js_1=require("./util/load-sdk-functions.js"),rust_support_platform_util_js_1=require("./util/rust-support-platform-util.js"),utils_js_1=require("./util/utils.js"),compile_code_snippet_js_1=require("./work-scripts/compile-code-snippet.js"),PROCESS_UN_HANDLED_REJECTION="unhandledRejection",PROCESS_UN_CAUGHT_EXCEPTION="uncaughtException",logger=hvigor_arkts_base_1.ArktsBaseLogger.getLogger("arkts-pack"),defaultProjectConfig={watchMode:"false",isPreview:!1,buildMode:constants_js_1.RELEASE,compileMode:constants_js_1.JSBUNDLE},getMergedConfig=e=>{const t={...defaultProjectConfig},s=new Set([...Object.keys(defaultProjectConfig),...Object.keys(e)]);for(const o of s)void 0!==e[o]&&(t[o]=e[o]);return t.arkTSVersion=e.arkTSVersion,t};function addCompilerLogMsg(e){let t=`${e}${os_1.default.EOL}`,s=1,o=0,r=0,n="",i="",a="";const l="[31m",u="[39m";return hvigor_arkts_base_1.ArktsBaseLogger.getLogEvents().forEach((e=>{if("error"===e.level){const t=hvigor_logger_1.ErrorUtil.getFirstErrorAdaptorMessage(new hvigor_logger_1.ArkTsErrorAdaptor(String(e.msg)).getErrorMessage());t.solutions?n+=hvigor_logger_1.ErrorUtil.combinePhase({code:t.code,description:"",cause:`${l}${s} ERROR: ${t.message}`,position:"",solutions:t.solutions,moreInfo:t.moreInfo}):n+=`${l}${s} ERROR: ${t.message}`,n+=`${os_1.default.EOL}${u}${os_1.default.EOL}`,s++}"warn"===e.level&&(o++,i+=`${os_1.default.EOL}[33m${o} WARN: ${e.msg}${u}`),"info"===e.level&&(r++,a+=`${os_1.default.EOL}[34m${r} INFO: ${e.msg}${u}`)})),t=`${t}${n}${l}COMPILE RESULT:FAIL {ERROR:${s}`+(0===o?"":` WARN:${o}`)+`${0===r?"":` INFO:${r}`}}${u}`,{infoMsg:""===a?void 0:a,warnMsg:""===i?void 0:i,errorMsg:t}}let watcher,isWatchFirst=!0;const setWatcher=e=>{watcher=e};function registerCatchUnhandleError(e,t,s){process.on(PROCESS_UN_HANDLED_REJECTION,(e=>{throw e})),process.on(PROCESS_UN_CAUGHT_EXCEPTION,(o=>{if("true"===e.watchMode)return watcher?.resolveDonePromise(),s?.error(o),void t?.postMessage(isWatchFirst?{event:hvigor_arkts_base_1.WatchEvent.WATCH_WORK_ERROR}:{type:hvigor_arkts_base_1.WatchEvent.WATCH_RESULT,content:!1});if(o.name===compose_error_js_1.ARKTS_COMPILER_ERROR_NAME){const e=o,t=addCompilerLogMsg(o.message),s=new compose_error_js_1.ExtendedErrorInfo(t.errorMsg,{infoMsg:t.infoMsg,warnMsg:t.warnMsg});throw e.stack&&s.stack&&(s.stack=s.stack.concat(os_1.default.EOL).concat(e.stack)),s}throw o}))}function getRollupErrorMessage(e){return e.loc&&e.loc.file?`${e.message+os_1.default.EOL+e.loc.file}:${e.loc.line}`:e.message}function noop(){}async function runArkPack(e,t,s,o,r){e.startEvent=e=>compile_event_factory_js_1.CompileEventFactory.createEvent(e,0,0).start(),e.endEvent=e=>compile_event_factory_js_1.CompileEventFactory.getEventById(e)?.stop();const n=new compile_perf_js_1.CompilePerf(e.perf).clear();let i;hvigor_arkts_base_1.ArktsBaseLogger.clearLogEvents(),isWatchFirst=!0,registerCatchUnhandleError(e,o,t);let a=noop;try{a=await collectCompilePerf(e,t,n,s,o,r)}catch(e){if(e instanceof Error){const t="RollupError"===e.name?getRollupErrorMessage(e):e.message;i=new compose_error_js_1.ArkTsCompilerError(t,e.stack)}else i="string"==typeof e?new Error(e):e}if(isWatchFirst=!1,hvigor_arkts_base_1.ArktsBaseLogger.checkLoggerHaveErrorInfo()&&"true"!==e.watchMode&&!i&&(i=new compose_error_js_1.ArkTsCompilerError("ArkTS Compiler Error")),"true"!==e.watchMode&&clearWorkerProcessContext(),i){if(i.name===compose_error_js_1.ARKTS_COMPILER_ERROR_NAME){const e=addCompilerLogMsg(i.message),t=new compose_error_js_1.ExtendedErrorInfo(e.errorMsg,{infoMsg:e.infoMsg,warnMsg:e.warnMsg});i.stack&&t.stack&&(t.stack=t.stack.concat(os_1.default.EOL).concat(i.stack)),i=t}return await a(!1),{compileLogEvents:[],compileEvents:[],isSuccess:!1,error:i}}return await a(!0),{compileLogEvents:hvigor_arkts_base_1.ArktsBaseLogger.getLogEvents(),compileEvents:updateEventNames(Array.from(n.transform())),isSuccess:!0}}async function collectCompilePerf(e,t,s,o,r,n){hvigor_arkts_base_1.projectConfigPath.init(e.projectTopDir,e.sdkPath);const i=e.startEvent("generate configuration information"),a=generateConfig(e,t,n);if(validComposedOhPackagePathMap(e),checkRustResolver(e,t),e.endEvent(i.getId()),a.input&&Object.keys(a.input).length>0){const i=()=>e.isPreview&&r&&(0,compile_code_snippet_js_1.initServer)(e.cachePath,e.aceModuleBuild,e.etsLoaderPath,r),l=await(0,hvigor_arkts_base_1.runHvigorCompile)(a,t,o,r,i,setWatcher,n);return collectTimers(l.timing,s),l.callback??noop}return logger.debug(`Empty input received at runArkPack. BuildStart and corresponding clean will not be executed.\n     Current module path: ${e.projectPath}.`),noop}function checkRustResolver(e,t){e.useNativeResolver&&!(0,rust_support_platform_util_js_1.isSupportedPlatform)()&&t?.warn("ohos.nativeResolver not supported on the current operating system.")}function collectTimers(e,t){if(e)for(const[s,[o,r,n,i,a,l,u]]of Object.entries(e))t.collect({name:s,time:o,startTime:r,endTime:n,frequency:i,memory:a,totalMemory:u,startMemory:l})}function clearProcessListeners(){process.removeAllListeners(PROCESS_UN_CAUGHT_EXCEPTION),process.removeAllListeners(PROCESS_UN_HANDLED_REJECTION)}function clearWorkerProcessContext(){(0,load_sdk_functions_js_1.clearSdkContext)(),clearProcessListeners()}function getResolveModules(e){const t=e.packageManagerType===constants_js_1.OHPM?constants_js_1.OH_NODE_MODULES:constants_js_1.NODE_MODULES,s=path_1.default.resolve(e.projectTopDir),o=path_1.default.resolve(e.modulePath),r=e.buildGeneratedProfilePath;return e.resolveModulePaths=[path_1.default.resolve(o,"src/main"),r,path_1.default.resolve(o,t),path_1.default.resolve(s,t)],e.resolveModulePaths}function loadAceBuildJson(e){if(e&&fs_1.default.existsSync(e))try{return JSON.parse(fs_1.default.readFileSync(e).toString())}catch(e){logger.error(`parse loader.json failed: ${e.message}`)}return{}}function getPlugins(e,t,s){const o=[...getBuiltInPlugins(e,s)],r=loadCustomCompilePlugins(e.hvigorPluginFile,t);e.compilePluginPath&&r.push(...loadCustomCompilePlugins(e.compilePluginPath,t)),r.forEach((s=>{const r=s.order??"last";if("first"===r&&o.unshift(doWrapper(s,e)),"last"===r&&o.push(doWrapper(s,e)),"function"!=typeof r)return;const n={};o.forEach(((e,t)=>{let s=e.name,o=1;for(;n[s];)s=`${s}_${o}`,o++;n[s]=t}));const i=r(n);("number"!=typeof i||Number.isNaN(i))&&t?.printErrorExit("INVALID_PLUGIN_EXPORT",[e.hvigorPluginFile,s.name,i],[[e.hvigorPluginFile]]),o.splice(i<0?0:i,0,doWrapper(s,e))})),e.useTscResolve&&o.push((0,tsc_resolve_js_1.tscResolve)({caseSensitiveCheck:e.caseSensitiveCheck}));const n=checkPluginDuplicateName(o);return n&&t?.printErrorExit("DUPLICATED_PLUGIN_NAME_IN_ROLLUP",[e.compilePluginPath,n],[[e.compilePluginPath,n]]),o}function checkPluginDuplicateName(e){const t=e.map((e=>e.name)),s=new Set;for(const e of t){if(s.has(e))return e;s.add(e)}}function getSupportExtensions(){return[...new Set(constants_js_1.SUPPORT_EXTENSIONS.concat(load_sdk_functions_js_1.sdkSupportExtensions))]}function getBuiltInPlugins(e,t){if(e.isHarDeduplicateArkCompile)return getHarDeduplicateBuiltInPlugins(e,t);const s=getSupportExtensions();return[e.isPreview&&e.appResource&&(0,preview_resource_watcher_plugin_js_1.previewResourceWatcherPlugin)(generatePreviewResourceFiles(e)),(e.isFaMode||"true"===e.watchMode)&&(0,copy_plugin_js_1.default)({targets:(0,copy_resources_js_1.getCopyPluginConfig)(e,e.appResource)}),(0,common_plugin_js_1.commonPlugin)(e,t),(0,invalid_cache_plugin_js_1.invalidCachePlugin)(),(0,check_duplicate_filenames_plugin_js_1.checkDuplicatedFileNamesPlugin)(),e.compileMode===constants_js_1.ESMODULE&&(0,module_meta_info_plugin_js_1.moduleMetaInfoPlugin)(s),getResolvePlugin(e,s),(0,router_map_plugin_js_1.routerMapPlugin)(),(0,use_new_ohm_url_plugin_js_1.newOhmUrlPlugin)(),(0,use_sensitive_check_plugin_js_1.sensitiveCheckPlugin)(),(0,plugin_commonjs_1.default)(),(0,gc_plugin_js_1.gcPlugin)(),(0,plugin_json_1.default)(),(0,wrapper_chunk_plugin_js_1.wrapperChunkPlugin)(),(0,wait_async_plugin_js_1.waitAsyncPlugin)(),(0,collect_importers_plugin_js_1.collectImportersPlugin)(e),...load_sdk_functions_js_1.sdkPlugins,!e.isPreview&&(0,delete_plugin_js_1.default)({targets:load_sdk_functions_js_1.cleanConfig,runOnce:!0})].filter((e=>"object"==typeof e))}function getHarDeduplicateBuiltInPlugins(e,t){const s=getSupportExtensions(),o=[];return load_sdk_functions_js_1.sdkPlugins.forEach((e=>{"object"==typeof e&&null!==e&&("etsChecker"!==e.name&&"etsTransform"!==e.name&&"apiTransform"!==e.name&&"createProgramPlugin"!==e.name||o.push(e),"genAbc"===e.name&&o.push({name:"myGenAbc",cleanUp:e.cleanUp}))})),[(0,common_plugin_js_1.commonPlugin)(e,t),(0,invalid_cache_plugin_js_1.invalidCachePlugin)(),(0,check_duplicate_filenames_plugin_js_1.checkDuplicatedFileNamesPlugin)(),e.compileMode===constants_js_1.ESMODULE&&(0,module_meta_info_plugin_js_1.moduleMetaInfoPlugin)(s),getResolvePlugin(e,s),(0,router_map_plugin_js_1.routerMapPlugin)(),(0,use_new_ohm_url_plugin_js_1.newOhmUrlPlugin)(),(0,use_sensitive_check_plugin_js_1.sensitiveCheckPlugin)(),(0,plugin_commonjs_1.default)(),(0,gc_plugin_js_1.gcPlugin)(),(0,plugin_json_1.default)(),(0,wait_async_plugin_js_1.waitAsyncPlugin)(),(0,collect_importers_plugin_js_1.collectImportersPlugin)(e),(0,hsp_collect_har_files_js_1.hspCollectHarFilesPlugin)(),...o,!e.isPreview&&(0,delete_plugin_js_1.default)({targets:load_sdk_functions_js_1.cleanConfig,runOnce:!0})].filter((e=>"object"==typeof e))}function getResolvePlugin(e,t){const s=getResolveModules(e),o=e.globalModulePaths??[];return o.push(path_1.default.resolve(e.etsLoaderPath,"../../api")),e.packageManagerType===constants_js_1.OHPM?(0,index_js_1.default)({extensions:t,modulePaths:Array.from(new Set([path_1.default.resolve(constants_js_1.OH_NODE_MODULES),...s])),useRealpathCache:!0,preferBuiltins:!1,pkgNameToPkgInfo:e.pkgNameToPkgBriefInfo,caseSensitiveCheck:e.caseSensitiveCheck,useNativeResolver:e.useNativeResolver&&(0,rust_support_platform_util_js_1.isSupportedPlatform)(),sdkModulesPath:o}):(0,plugin_node_resolve_1.default)({extensions:t,modulePaths:Array.from(new Set([path_1.default.resolve(constants_js_1.NODE_MODULES),path_1.default.resolve(e.etsLoaderPath,constants_js_1.NODE_MODULES),...s])),preferBuiltins:!1})}function generatePreviewResourceFiles(e){return[path_1.default.resolve(__dirname,e.appResource),(0,utils_js_1.getOhPackageJsonPath)(path_1.default.resolve(e.modulePath,e.packageManagerType===constants_js_1.OHPM?constants_js_1.OH_PACKAGE_JSON5:constants_js_1.PACKAGE_JSON))]}function loadCustomCompilePlugins(e,t){const s=[];if(!e)return s;let o;delete require.cache[require.resolve(e)];try{o=require(e).default}catch(t){throw t.message=`${t.message} ${e}`,t}o||t?.printErrorExit("PLUGIN_FILE_NO_DEFAULT_EXPORT",[e],[[e]]);return(Array.isArray(o)?o:[o]).forEach((o=>{validatePlugin(o,e,t),o||t?.printErrorExit("EXPORT_UNDEFINED_PLUGIN",[e],[[e]]),s.push(o)})),s}function validatePlugin(e,t,s){"object"!=typeof e&&s?.printErrorExit("INVALID_PLUGIN_TYPE",[t,typeof e],[[t]]);const o=e.name;o||s?.printErrorExit("PLUGIN_NAME_NOT_EXIST",[t],[[t]]),"string"!=typeof o&&s?.printErrorExit("PLUGIN_NAME_NOT_STRING",[t],[[t]]),Object.keys(e).forEach((r=>{const n=e[r];switch(r){case"name":break;case"order":n&&"last"!==n&&"first"!==n&&"function"!=typeof n&&s?.printErrorExit("PLUGIN_NAME_WITH_UNKNOWN_ORDER",[t,o,n],[[o,t]]);break;case"buildStart":case"resolveId":case"load":case"transform":case"shouldInvalidCache":case"moduleParsed":case"beforeBuildEnd":case"buildEnd":n&&"function"!=typeof n&&s?.printErrorExit("PLUGIN_NAME_WITH_UNKNOWN_HOOK",[t,o,r],[[o,r,t]]);break;default:s?.warn(`'${t}' exports an invalid plugin '${o}' with unknown property: '${r}'.`)}}))}function manualChunks(e,{getModuleInfo:t}){if(e.includes(constants_js_1.NODE_MODULES)||e.includes(constants_js_1.OH_NODE_MODULES))return"commons";const s=t(e);return s&&!s.isEntry?"vendors":void 0}function getCompileInputObject(e){const t={};return Object.entries(e).forEach((([e,s])=>{if(!s.endsWith(".d.ts")&&!s.endsWith(".d.ets")){const o=e.startsWith("../")?`relative/../${e}`:e;t[o]=s}})),t}function processMockConfigModuleInfos(e){const t=e.mockParams?.mockConfigKey2ModuleInfo;if(!t||!Object.keys(t).length)return;const s=getSupportExtensions();Object.keys(t).forEach((e=>{const o=t[e],r=(0,hvigor_arkts_base_1.findSuitableFilePath)(o.filePath,s);r?o.filePath=r:delete t[e]}))}function getCompileEnv(e,t){return[e.compileSdkVersion,e.compatibleSdkVersion,e.runtimeOS,e.etsLoaderPath,!!e.obfuscationOptions?.selfConfig?.ruleOptions?.enable,t.moduleType,path_1.default.resolve(t.cachePath,hvigor_arkts_base_1.MSGPACK_COMPILE_CACHE_DIR_NAME)].join("#")}function generateConfig(e,t,s){const o=getMergedConfig(e);(0,load_sdk_functions_js_1.loadSdkFunctions)(o);const r=o.compileMode?.toLowerCase(),n=o.buildMode?.toLowerCase(),i=o.cachePath,a=n===constants_js_1.DEBUG?path_1.default.resolve(__dirname,o.aceModuleBuild):path_1.default.join(i,"releaseAssets",path_1.default.basename(o.aceModuleBuild)),l=getCompileEnv(e,o),u=s?.mount("KeyManager"),c=u?.getCache(`${e.modulePath}:${e.targetName}`);return c&&c!==l&&s?.unmount(c),u?.setCache(`${e.modulePath}:${e.targetName}`,l,!0),o.compileEnv=l,processMockConfigModuleInfos(o),{perf:e.perf===constants_js_1.AnalyzeMode.VERBOSE||e.perf===constants_js_1.AnalyzeMode.TRACE,unsupportedChangedFiles:[(0,utils_js_1.getOhPackageJsonPath)(path_1.default.resolve(e.modulePath,e.packageManagerType===constants_js_1.OHPM?constants_js_1.OH_PACKAGE_JSON5:constants_js_1.PACKAGE_JSON))],generateModuleGraphOnly:r===constants_js_1.ESMODULE,input:getCompileInputObject("true"===e.widgetCompile?load_sdk_functions_js_1.widgetEntryObj:load_sdk_functions_js_1.entryObj),output:getOutputConfig(a,r,e),shimMissingExports:!0,preserveSymlinks:!1,context:"globalThis",treeshake:n===constants_js_1.RELEASE,disableGenerateBundle:r===constants_js_1.ESMODULE,plugins:getPlugins(o,t,s),watch:getWatchConfig(r),watchMode:e.watchMode,enableFileSystemCache:!0,cacheDirectory:i,onwarn(e){onRollupWarn(e.message,e.code,o.isFaMode)},startEvent:e.startEvent,endEvent:e.endEvent,isPreview:e.isPreview,skipBuildEnd:e.skipBuildEnd,compileEnv:l,pkgName2SourceRoots:(0,utils_js_1.getPkgName2SourceRootsMap)(e),extensions:getSupportExtensions(),depName2RootPath:e.depName2RootPath,modulePath:e.modulePath,isByteCodeHar:e.byteCodeHar,declaredFilesPath:e.declaredFilesPath,useAcornLoose:!e.shouldEmitJs,etsLoaderPath:e.etsLoaderPath,bundledDependencies:e.projectArkOption?.bundledDependencies,shouldCollectDirectImportees:e.shouldCollectDirectImportees,useSourceHash:e.useSourceHash,usePathPlaceholder:e.usePathPlaceholder,hotReloadBuild:e.hotReloadBuild,arkCompileCachePath:e.arkCompileCachePath,buildMode:e.buildMode,writeRollupCache:e.writeRollupCache}}function getOutputConfig(e,t,s){return[{dir:e,chunkFileNames:"[name].js",format:"cjs",sourcemap:t===constants_js_1.JSBUNDLE&&!s.isPreview,sourcemapExcludeSources:!0,sourcemapPathTransform:(e,t)=>{if(s.buildMode===constants_js_1.RELEASE){const o=loadAceBuildJson(s.aceBuildJson);return path_1.default.resolve(path_1.default.dirname(t),e).replace(o.projectRootPath,"")}return path_1.default.resolve(path_1.default.dirname(t),e).replace(s.projectTopDir+path_1.default.sep,"")},exports:"named",sanitizeFileName:!1,bundleMode:t===constants_js_1.JSBUNDLE,manualChunks:s.supportChunks?manualChunks:void 0}]}function getWatchConfig(e){return{chokidar:{useFsEvents:!1},skipWrite:e===constants_js_1.ESMODULE,buildDelay:100}}exports.runArkPack=runArkPack,exports.getResolveModules=getResolveModules,exports.loadAceBuildJson=loadAceBuildJson;var compile_code_snippet_js_2=require("./work-scripts/compile-code-snippet.js");function watch(e,t,s,o){return e.watchMode="true",runArkPack(e,t,s,o)}function wrapperBeforeBuildEnd(e,t){return function(s){const o=getCompilePluginContext(this);let r;try{r=e.beforeBuildEnd.apply(o,[s])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}return r}}function wrapperBuildEnd(e,t){return function(s){const o=getCompilePluginContext(this);try{e.buildEnd.apply(o,[s])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}}}function wrapperModuleParsed(e,t){return function(s){const o=getCompilePluginContext(this);try{e.moduleParsed.apply(o,[s])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}}}function wrapperShouldInvalidCache(e,t){return function(s){const o=getCompilePluginContext(this);let r;try{r=e.shouldInvalidCache.apply(o,[s])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}return r}}function wrapperTransform(e,t){return function(s,o){const r=getCompilePluginContext(this);let n;try{n=e.transform.apply(r,[s,o])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}return n}}function wrapperLoad(e,t){return function(s){const o=getCompilePluginContext(this);let r;try{r=e.load.apply(o,[s])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}return r}}function wrapperResolveId(e,t){return function(s,o,r){const n=getCompilePluginContext(this);let i;try{i=e.resolveId.apply(n,[s,o,r])}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}return i}}function validComposedOhPackagePathMap(e){e.ohPackagePathMap&&e.ohPackagePathMap.forEach(((e,t)=>{utils_js_1.composeOhPackagePathMap.set(t,e)}))}function wrapperBuildStart(e,t){return function(s){const o=getCompilePluginContext(this);try{e.buildStart.apply(o)}catch(e){throw e.message=`${e.message} ${t.hvigorPluginFile}`,e}}}function doWrapper(e,t){const s={name:e.name};return e.buildStart&&(s.buildStart=wrapperBuildStart(e,t)),e.resolveId&&(s.resolveId=wrapperResolveId(e,t)),e.load&&(s.load=wrapperLoad(e,t)),e.transform&&(s.transform=wrapperTransform(e,t)),e.shouldInvalidCache&&(s.shouldInvalidCache=wrapperShouldInvalidCache(e,t)),e.moduleParsed&&(s.moduleParsed=wrapperModuleParsed(e,t)),e.beforeBuildEnd&&(s.beforeBuildEnd=wrapperBeforeBuildEnd(e,t)),e.buildEnd&&(s.buildEnd=wrapperBuildEnd(e,t)),s}function getCompilePluginContext(e){return{getFileName:t=>e.getFileName(t),getModuleIds:()=>e.getModuleIds(),getModuleInfo:t=>e.getModuleInfo(t),parse:(t,s)=>e.parse(t,s),share:e.share}}function updateEventNames(e){const[t,s]=initUpdateEventNameHandler(),o=["beforeBuildEnd","buildEnd","afterBuildEnd","beforeBuild","buildStart","afterBuildStart","resolveId","load","resolveDynamicImport","shouldTransformCachedModule","transform","moduleParsed"];return e.forEach((e=>{const r=e.getName(),n=r.lastIndexOf("-");if(t.has(r))t.get(r)(e);else for(const t of o)if(r.endsWith(t)){const o=s.get(t);o&&o(e,r,n);break}})),e}function onRollupWarn(e,t,s=!1){"SHIMMED_EXPORT"===t||s&&"SOURCEMAP_BROKEN"===t||console.warn("[33m",e,"[39m")}function getCallback(e){return t=>t.setName(e)}function initUpdateEventNameHandler(){const e=new Map;e.set("# BUILD",getCallback("generate build graph for source files")),e.set("## initialize",getCallback("initialize compiler input")),e.set("## generate module graph",getCallback("generate module graph")),e.set("## sort and bind modules",getCallback("sort and bind modules")),e.set("## mark included statements",getCallback("mark included statements")),e.set("## before build end",getCallback("before build end")),e.set("## build end",getCallback("build end")),e.set("## after build end",getCallback("after build end"));const t=new Map;return t.set("beforeBuildEnd",((e,t,s)=>e.setName(`${t.substring(0,s)}- execute hook function before build ends`))),t.set("buildEnd",((e,t,s)=>e.setName(`${t.substring(0,s)}- execute hook function when build ends`))),t.set("afterBuildEnd",((e,t,s)=>e.setName(`${t.substring(0,s)}- execute hook function after build ends`))),t.set("beforeBuild",((e,t,s)=>e.setName(`${t.substring(0,s)}- execute hook function before build starts`))),t.set("buildStart",((e,t,s)=>e.setName(`${t.substring(0,s)}- execute hook function when build starts`))),t.set("afterBuildStart",((e,t,s)=>e.setName(`${t.substring(0,s)}- execute hook function after build starts`))),t.set("resolveId",((e,t,s)=>e.setName(`${t.substring(0,s)}- resolve file ID`))),t.set("load",((e,t,s)=>e.setName(`${t.substring(0,s)}- load file content`))),t.set("resolveDynamicImport",((e,t,s)=>e.setName(`${t.substring(0,s)}- resolve dynamic import`))),t.set("shouldTransformCachedModule",((e,t,s)=>e.setName(`${t.substring(0,s)}- decide whether to transform cached module`))),t.set("transform",((e,t,s)=>e.setName(`${t.substring(0,s)}- transform file content`))),t.set("moduleParsed",((e,t,s)=>e.setName(`${t.substring(0,s)}- execute hook function when module parsed`))),[e,t]}Object.defineProperty(exports,"compileCodeSnippet",{enumerable:!0,get:function(){return compile_code_snippet_js_2.compileCodeSnippet}}),exports.watch=watch;