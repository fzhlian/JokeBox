"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.hspCollectHarFilesPlugin=exports.BYTE_CODE_HAR_DUPLICATE_FILES_INFO=exports.SOURCE_HAR_DUPLICATE_FILES_INFO=void 0;const fs_1=__importDefault(require("fs")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path"));function hspCollectHarFilesPlugin(){return{name:"hspCollectHarFiles",buildEnd:buildEnd}}function buildEnd(){const e=this.share.projectConfig.hspDeduplicateHarInfo;if(!e||0===Object.keys(e).length)return;const t=new Set,o=new Set;Object.values(e).forEach((e=>{e.isByteCodeHarDependency?o.add(e.packageName):t.add(e.dependencyRootPath)}));const s=[],r=[];collectSourceFiles(this,t,o,s,r);const i=this.share.projectConfig.intermediateHarDuplicateDirPath;if(fs_1.default.existsSync(i)||fs_1.default.mkdirSync(i,{recursive:!0}),s.length>0){const e=path_1.default.join(i,exports.SOURCE_HAR_DUPLICATE_FILES_INFO);fs_1.default.writeFileSync(e,s.join(os_1.default.EOL))}if(r.length>0){const e=path_1.default.join(i,exports.BYTE_CODE_HAR_DUPLICATE_FILES_INFO);fs_1.default.writeFileSync(e,r.join(os_1.default.EOL))}}function collectSourceFiles(e,t,o,s,r){for(const i of e.getModuleIds()){const n=e.getModuleInfo(i);if(!n)continue;if(i.startsWith("\0"))continue;const l=collectByteCodeHar(n,o);if(l)r.push(l);else{const e=collectSourceHar(i,t);e&&s.push(e)}}}function collectByteCodeHar(e,t){if(!e.isExternal)return;const o=e.id,s=o.toLowerCase();for(const e of t){const t=e.toLowerCase();if(s===t||s.startsWith(`${t}/`)||s.startsWith(`${t}\\`))return o}}function collectSourceHar(e,t){for(const o of t)if(e.startsWith(o+path_1.default.sep))return e}exports.SOURCE_HAR_DUPLICATE_FILES_INFO="sourceHarDuplicateFilesInfo.txt",exports.BYTE_CODE_HAR_DUPLICATE_FILES_INFO="byteCodeHarDuplicateFilesInfo.txt",exports.hspCollectHarFilesPlugin=hspCollectHarFilesPlugin;