"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImportResolver=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),constants_js_1=require("../../util/constants.js"),util_js_1=require("./util.js"),index_js_1=require("./index.js");class ImportResolver{constructor(e,t){this.resolve=e=>{const t=(0,util_js_1.getPackageName)(e),s=t?t.split("\\")[0]:null;if(!s)return;let r,a;for(const e of this.depName2DepInfos.keys())e.toLowerCase()===s.toLowerCase()&&(r=e,a=this.depName2DepInfos.get(e));if(!a||!r||"hsp"!==a.dependencyType&&!a.isByteCodeHar)return;const i=s===r,n=path_1.default.normalize(e);let o="";const l=a.pkgRootPath;let p=this.getReferenceNamePath(l,e,s);n.endsWith(path_1.default.sep)&&(p=`${p}${path_1.default.sep}`);const h=`^${r}[\\\\/]*$`;return o=this.getResReferencePath(i,h,n,p,e)??"",o?{packageName:a.pkgName,normalizedPath:this.removeFileExtensionFromPath(path_1.default.join(a.pkgName,path_1.default.relative(l,o)))}:void 0},this.depName2DepInfos=e,this.caseSensitiveCheck=t}removeFileExtensionFromPath(e){const t=path_1.default.dirname(e),s=path_1.default.basename(e);let r="";r=s.endsWith(".d.ets")?".d.ets":s.endsWith(".d.ts")?".d.ts":path_1.default.extname(e);const a=s.slice(0,-r.length);return path_1.default.join(t,a)}pathIsDirectory(e){if(!fs_extra_1.default.existsSync(e))return!1;return fs_extra_1.default.statSync(e).isDirectory()}pathIsFile(e){const t=constants_js_1.SUFFIX_EXTENSIONS.map((t=>e+t));t.unshift(e);for(let e=0;e<t.length;e++)if(this.pathIsFilePath(t[e]))return!0;return!1}pathIsFilePath(e){if(!fs_extra_1.default.existsSync(e))return!1;return fs_extra_1.default.statSync(e).isFile()}getReferenceNamePath(e,t,s){const r=new RegExp(`^${s}[/\\\\]*`),a=path_1.default.normalize(t.replace(r,"")).split(path_1.default.sep);return path_1.default.resolve(e,a.join(path_1.default.sep))}getResReferencePath(e,t,s,r,a){let i="";if(e){if(new RegExp(t).test(s))return;if(this.pathIsFile(r))return;this.pathIsDirectory(r)&&(i=index_js_1.importee2filePath.get(a)??"")}if(!e&&!this.caseSensitiveCheck)if(new RegExp(t,"i").test(s))i=index_js_1.importee2filePath.get(a)??"";else{if(this.pathIsFile(r))return;this.pathIsDirectory(r)&&(i=index_js_1.importee2filePath.get(a)??"")}return i}}exports.ImportResolver=ImportResolver;