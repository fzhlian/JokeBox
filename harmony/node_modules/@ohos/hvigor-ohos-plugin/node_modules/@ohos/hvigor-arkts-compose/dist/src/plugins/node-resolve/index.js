"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,i)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.processHarDeduplicate=exports.getExternal=exports.nodeResolve=exports.isBackslashExternal=exports.isExternal=exports.importee2filePath=exports.DEFAULTS=void 0;const fs_1=__importDefault(require("fs")),path_1=__importStar(require("path")),hvigor_arkts_base_1=require("@ohos/hvigor-arkts-base"),deepmerge_1=__importDefault(require("deepmerge")),is_builtin_module_1=__importDefault(require("is-builtin-module")),arkts_pack_js_1=require("../../arkts-pack.js"),constants_js_1=require("../../util/constants.js"),fs_js_1=require("../../util/fs.js"),log_js_1=require("../../util/log.js"),har_deduplicate_util_js_1=require("../har-deduplicate/har-deduplicate-util.js"),import_check_plugin_js_1=__importDefault(require("../import-check-plugin.js")),cache_js_1=require("./cache.js"),deprecated_options_js_1=__importDefault(require("./deprecated-options.js")),resolve_import_specifiers_js_1=require("./resolve-import-specifiers.js"),resolve_ohmodules_js_1=require("./resolve-ohmodules.js"),util_js_1=require("./util.js"),ES6ImportExportRegExp=/(?:^\s*|[}{\(\);,\n]\s*)(import[\s+|{]['"]|(import|module)[\s+|*|{][^"'\(\)\n;]+[\s|}]+from\s*['"]|export[\s+|{](\*|\{|default|function|var|const|let|[_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*))/,ES6AliasRegExp=/(?:^\s*|[}{\(\);,\n]\s*)(export\s*\*\s*from\s*(?:'([^']+)'|"([^"]+)"))/,logger=hvigor_arkts_base_1.ArktsBaseLogger.getLogger("caseSensitiveCheck"),_log=hvigor_arkts_base_1.ArktsBaseLogger.getHvigorConsoleLogger("node-resolve");function isModule(e){return ES6ImportExportRegExp.test(e)||ES6AliasRegExp.test(e)}const deepFreeze=e=>{Object.freeze(e);for(const t of Object.values(e))"object"!=typeof t||Object.isFrozen(t)||deepFreeze(t);return e},baseConditions=["default","module"],baseConditionsEsm=[...baseConditions,"import"],baseConditionsCjs=[...baseConditions,"require"],defaults={dedupe:[],extensions:[".mjs",".js",".json",".node"],resolveOnly:[],moduleDirectories:["oh_modules"],ignoreSideEffectsForRoot:!1},ignoreVirtualFilePrefix="\0hvigor_ignore_";let harDuplicateFileSet;exports.DEFAULTS=deepFreeze((0,deepmerge_1.default)({},defaults)),exports.importee2filePath=new Map;const allowPatterns=e=>{const t=e.map((e=>{if(e instanceof RegExp)return e;const t=e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&");return new RegExp(`^${t}$`)}));return e=>!t.length||t.some((t=>t.test(e)))};async function updateLocation(e,t,r,s,i){if(e&&!s){await(0,fs_js_1.fileExists)(t)&&(t=await(0,fs_js_1.realpathFS)(t))}return i.set(t,r),t}function initData(e){const t=(0,util_js_1.getMainFields)(e),r=!0===e.preferBuiltins||!1===e.preferBuiltins;return{conditionsEsm:[...baseConditionsEsm,...e.exportConditions||[]],conditionsCjs:[...baseConditionsCjs,...e.exportConditions||[]],packageInfoCache:new Map,idToPackageInfo:new Map,mainFields:t,useBrowserOverrides:-1!==t.indexOf("browser"),isPreferBuiltinsSet:r,preferBuiltins:!r||e.preferBuiltins,rootDir:(0,path_1.resolve)(e.rootDir||process.cwd()),dedupe:e.dedupe}}function reject(e,t){return!!(0,util_js_1.normalizeInput)(t.input).includes(e)&&null}function getImportSpecifierList(e,t,r){const s=[e];if(void 0!==t||e[0].match(/^\.?\.?\//)||s.push(`./${e}`),t&&e.endsWith(".js"))for(const i of[".ts"])t.endsWith(i)&&r.includes(i)&&s.push(e.replace(/.js$/,i));return s}function addSourceRootsIntoImportSpecifiers(e,t,r,s,i,o,a,n){if(e||!i||!a)return;const l=t.getModuleInfo(i)?.meta,c=l?.pkgName,u=l?.pkgPath,d=a[c]?.sourceRoots;c&&u&&r===c&&d?.length&&d.forEach((e=>{const t=path_1.default.resolve(u,e,s.join("/"));let r=path_1.default.relative(o,t).replace(/\\/g,"/");"."!==r.charAt(0)&&(r=`./${r}`),n.push(r)}))}function addResolvedMeta(e,t,r,s,i){if(e&&s&&s>i){const o=r.slice(i+1,s).map((e=>path_1.default.resolve(t,e)));e.meta={backupSourceRoots:o,resolvedBySourceRoot:!0}}return e}async function getRes(e,t,r,s,i,o,a,n,l,c,u,d,p){if(e){if(t&&c)return!u&&r&&s!==i&&o.warn(`preferring built-in module '${i}' over local alternative at '${r.location}', pass 'preferBuiltins: false' to disable this behavior or 'preferBuiltins: true' to disable this warning`),!1;if(d&&0!==a.indexOf((0,path_1.normalize)(d.trim(path_1.sep))))return null}if(p.modulesOnly&&await(0,fs_js_1.fileExists)(a)){return isModule(await(0,fs_js_1.readFile)(a,"utf-8"))?{id:`${a}${n}`,moduleSideEffects:l(a)}:null}return{id:`${a}${n}`,moduleSideEffects:l(a)}}function updateBrowserMapCache(e,t,r){if(e){if(Object.prototype.hasOwnProperty.call(e,t)){if(!e[t])return r.set(t,e),[{id:constants_js_1.ES6_BROWSER_EMPTY},null];t=e[t]}r.set(t,e)}return[null,t]}function getResolveLikeNode(e,t,r,s,i,o,a,n,l,c,u,d,p,f,_,h,g,m,j,E,v,S,C){return async(x,k,R,w)=>{const[F,D]=k.split("?"),b=""+(D?`?${D}`:"");k=F;const P=!R||e(k)?t:(0,path_1.dirname)(R),M=r.get(R);if(s&&M){const e=(0,path_1.resolve)(P,k);if(!1===M[k]||!1===M[e])return{id:constants_js_1.ES6_BROWSER_EMPTY};k=("."!==k[0]&&M[k]||M[e]||M[`${e}.js`]||M[`${e}.json`])??k}const I=k.split(/[/\\]/);let y=I.shift(),O=!1;if("@"===y[0]&&I.length>0?y+=`/${I.shift()}`:"."===y[0]&&(y=(0,path_1.resolve)(P,k),O=!0),!O&&!i(y))return reject(k,o);const B=getImportSpecifierList(k,R,a),$=B.length-1;addSourceRootsIntoImportSpecifiers(O,x,y,I,R,P,E.pkgNameToPkgInfo,B);const A=w&&w["node-resolve"]&&w["node-resolve"].isRequire,q=A?n:l;let L;s&&!q.includes("browser")&&q.push("browser"),L=C&&S&&v?await doNativeResolve(A?S:v,B,P,R):await(0,resolve_import_specifiers_js_1.resolveImportSpecifiers)({importer:R,importSpecifierList:B,exportConditions:q,warn:(...e)=>x.warn(...e),packageInfoCache:c,extensions:a,mainFields:u,preserveSymlinks:d,useBrowserOverrides:s,baseDir:P,moduleDirectories:p,modulePaths:f,rootDir:t,ignoreSideEffectsForRoot:_,caseSensitiveCheck:E.caseSensitiveCheck,sdkModulesPath:E.sdkModulesPath});const H=(0,is_builtin_module_1.default)(k),N=H&&h?{packageInfo:void 0,hasModuleSideEffects:()=>null,hasPackageEntry:!0,packageBrowserField:!1}:L;if(!N)return null;const{packageInfo:T,hasModuleSideEffects:W,hasPackageEntry:V,packageBrowserField:z}=N;let{location:U}=N;const Y=updateBrowserMapCache(z,U,r);if(Y[0])return Y[0];U=Y[1],U=await updateLocation(V,U,T,d,g);return addResolvedMeta(await getRes(V,H,L,N,k,x,U,b,W,h,m,j,E),P,B,N.resolvedSpecifierIndex,$)}}async function doNativeResolve(e,t,r,s){for(let i=0;i<t.length;i++){const o=await e.async(r,t[i]);if(o.error||!o.path)continue;o.caseSensitiveDetected&&s&&(0,log_js_1.hvigorConsoleLoggerPrintError)(_log,"CASE_SENSITIVE_DETECTED_AND_IMPORTER",[t[i]+(o.indexLoaded?"/index":""),s]);const a="\\\\?\\";return{location:o.path.startsWith(a)?o.path.substring(a.length):o.path,resolvedSpecifierIndex:i,hasModuleSideEffects:()=>null}}}function checkModuleDirectories(e){if(e.some((e=>e.includes("/"))))throw new Error("`moduleDirectories` option must only contain directory names. If you want to load modules from somewhere not supported by the default module resolution algorithm, see `modulePaths`.")}function updateDedupe(e,t){return"function"!=typeof e&&(e=e=>t.dedupe.includes(e)||t.dedupe.includes((0,util_js_1.getPackageName)(e))),e}function getResolveOnly(e){return"function"==typeof e.resolveOnly?e.resolveOnly:allowPatterns(e.resolveOnly)}function doWidgetCompileCheck(e,t,r){if("true"===e.widgetCompile&&e.byteCodeHar2HspDep?.get(t)?.length){const s=e.byteCodeHar2HspDep?.get(t)?.map((e=>`'${e}'`));(0,log_js_1.hvigorConsoleLoggerPrintError)(_log,"REMOVE_REFERENCES_FOR_SERVICE_WIDGET",[s.join(", "),r?`At file: ${r}`:""])}}function isExternal(e,t,r,s,i={}){for(const[e,o]of t)if(e.test(r))return"true"===i.widgetCompile&&(0,log_js_1.hvigorConsoleLoggerPrintError)(_log,"REMOVE_REFERENCES_FOR_SERVICE_WIDGET",[o,s?`At file: ${s}`:""]),!0;for(const[t,o]of e)if(t.test(r))return doWidgetCompileCheck(i,o,s),!0;return!1}function isBackslashExternal(e,t,r){for(const[e,s]of t)if(e.test(r))return!0;for(const[t,s]of e)if(t.test(r))return!0;return!1}function readSystemApi(e){const t=new Map;return e.forEach((e=>{fs_1.default.readdirSync(e).forEach((r=>{const s=path_1.default.join(e,r);fs_1.default.statSync(s).isFile()&&t.set(r.replace(".d.ts","").replace(".d.ets",""),s)}))})),t}function getVirtualFileId(e){return ignoreVirtualFilePrefix+e.replace(/\\/g,"_").replace(/\//g,"_")}function loadNativeResolver(e,t,r,s,i,o){if(!e)return[void 0,void 0];try{const{ResolverFactory:e}=require("oxc-resolver"),a=new e({conditionNames:t.conditionsEsm,mainFields:t.mainFields,extensions:r,symlinks:!s,modules:[...i,"oh_modules"],caseSensitive:o}),n=a.cloneWithOptions({conditionNames:t.conditionsCjs});return[a,n]}catch(e){console.warn("load native resolver failed: ",e)}return[void 0,void 0]}function setImportee2filePath(e,t){void 0!==e?.id&&exports.importee2filePath.set(t,e.id)}function backSlashExternalSaved(e,t,r,s){return!!isBackslashExternal(e,t,r)&&(setImportee2filePath(s,r),!0)}function nodeResolve(e={}){const{warnings:t}=(0,deprecated_options_js_1.default)(e),r={...defaults,...e},{extensions:s,jail:i,moduleDirectories:o,modulePaths:a,ignoreSideEffectsForRoot:n,sdkModulesPath:l,useNativeResolver:c}=r,u=initData(r);let d,p,f;checkModuleDirectories(o);const _=updateDedupe(u.dedupe,r),h=getResolveOnly(r),g=new Map,m=new Map;let j=!1;const E=new Map,v=new Map,S=new Map;let C,x;const k={order:"post",async handler(e,t,l){if(e===constants_js_1.ES6_BROWSER_EMPTY)return e;if(/\0/.test(e))return null;const{custom:k={}}=l;let R;if(/\0/.test(t)&&(t=void 0),/^lib\S+\.so/.test(e))return{id:getVirtualFileId(e),external:j};if(!r.caseSensitiveCheck&&isExternal(m,E,e,t,this.share?.projectConfig))return R=await getResolveLikeNode(_,u.rootDir,g,u.useBrowserOverrides,h,d,s,u.conditionsCjs,u.conditionsEsm,u.packageInfoCache,u.mainFields,p,o,a,n,u.preferBuiltins,u.idToPackageInfo,u.isPreferBuiltinsSet,i,r,C,x,c)(this,e,t,k),setImportee2filePath(R,e),{id:e,external:!0};if("."!==e[0]&&f.has(e)&&(R={id:f.get(e)}),R||(R=await getResolveLikeNode(_,u.rootDir,g,u.useBrowserOverrides,h,d,s,u.conditionsCjs,u.conditionsEsm,u.packageInfoCache,u.mainFields,p,o,a,n,u.preferBuiltins,u.idToPackageInfo,u.isPreferBuiltinsSet,i,r,C,x,c)(this,e,t,k)),r.caseSensitiveCheck&&isExternal(m,E,e,t,this.share?.projectConfig))return setImportee2filePath(R,e),{id:e,external:!0};const w=backSlashExternalSaved(v,S,e,R);return R&&(import_check_plugin_js_1.default.resolveId.call(this,e,R.id,t,r),R=processFinalResolved(this,e,R,j,w)),R}};return{name:"oh-resolve",buildStart(e){exports.importee2filePath.clear(),d=e,t.forEach((e=>this.warn(e))),({preserveSymlinks:p}=e);const i=this.share?.projectConfig?.projectTopDir||process.cwd();this.share.symlinkMap=(0,resolve_ohmodules_js_1.resolveAllOhModules)(i),updateRealpathCache(r.useRealpathCache),f=readSystemApi(new Set(l)),getExternal(m,E,v,S,this.share.projectConfig),j=!this.share.projectConfig.isFaMode,[C,x]=loadNativeResolver(c,u,s,p,a,r.caseSensitiveCheck),harDuplicateFileSet=(0,har_deduplicate_util_js_1.getHarDuplicateFileSet)(this.share.projectConfig)},generateBundle:clearCache,beforeBuildEnd(){cache_js_1.caseErrorSet.forEach((e=>{logger.error(e)}))},resolveId:k,load:load,transform:transform,moduleParsed(e){import_check_plugin_js_1.default.moduleParsed.call(this,e)},getPackageInfoForId:e=>u.idToPackageInfo.get(e),cleanUp:()=>{m.clear(),v.clear(),S.clear(),f?.clear(),clearCache(),C?.clearCache(),harDuplicateFileSet?.clear()}}}function getExternal(e,t,r,s,i){const o=new Set;if(i.compileMode===constants_js_1.ESMODULE){const e=(0,arkts_pack_js_1.loadAceBuildJson)(i.aceBuildJson);Object.keys(e?.hspNameOhmMap??{}).forEach((e=>{t.set(new RegExp(`^(${e})($|/\\S*)`,"i"),e),s.set(new RegExp(`^(${e})(\\\\\\S*)`,"i"),e)}))}if(i.compileBlockPkg)for(const e of i.compileBlockPkg)o.add(e);for(const t of o)e.set(new RegExp(`^(${t})($|/\\S*)`,"i"),t),r.set(new RegExp(`^(${t})(\\\\\\S*)`,"i"),t)}function updateRealpathCache(e){e?(0,fs_js_1.enableRealpathCache)():(0,fs_js_1.disableRealpathCache)()}function clearCache(){(0,fs_js_1.clearRealpathCache)(),(0,fs_js_1.clearFileCache)(),(0,cache_js_1.clearStepAddressingCache)(),cache_js_1.readCachedFile.clear(),cache_js_1.isFileCached.clear(),cache_js_1.isDirCached.clear()}function transform(e,t){import_check_plugin_js_1.default.transform.call(this,e,t)}function load(e){return e===constants_js_1.ES6_BROWSER_EMPTY?"export default {};":e.startsWith(ignoreVirtualFilePrefix)||(0,har_deduplicate_util_js_1.isHspDeduplicateRealCompile)(this.share.projectConfig)&&e.startsWith("\0")&&harDuplicateFileSet&&harDuplicateFileSet.has(e.substring(1))?"":null}function withinModule(e,t){const r=e.share.projectConfig.modulePath;return t.id.includes(r)}function processFinalResolved(e,t,r,s,i){if(i&&(0,har_deduplicate_util_js_1.isHspCollectFilesCompile)(e.share.projectConfig))return{id:t,external:!0};if(r.id.endsWith(".d.ts")||r.id.endsWith(".d.ets"))return e.share.projectConfig?.customizedOptions?.basePackage&&withinModule(e,r)&&(e.share.projectConfig.customHarDeclareFilesMap||(e.share.projectConfig.customHarDeclareFilesMap={}),e.share.projectConfig.customHarDeclareFilesMap[getVirtualFileId(r.id)]={id:r.id}),{id:getVirtualFileId(r.id),external:s};const o=processHarDeduplicate(e,r.id,s);return o||r}function processHarDeduplicate(e,t,r){if((0,har_deduplicate_util_js_1.isHspDeduplicateRealCompile)(e.share.projectConfig)&&harDuplicateFileSet&&harDuplicateFileSet.has(t)){let s={isHarDeduplicate:!0};const i=e.getModuleInfo(t);return i&&i.meta&&(s=Object.assign(i.meta,s)),{id:`\0${t}`,external:r,meta:s}}return null}exports.isExternal=isExternal,exports.isBackslashExternal=isBackslashExternal,exports.nodeResolve=nodeResolve,exports.getExternal=getExternal,exports.processHarDeduplicate=processHarDeduplicate,exports.default=nodeResolve;