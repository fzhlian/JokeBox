"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AppPluginBuilder=void 0;const hvigor_1=require("@ohos/hvigor"),collect_duplicate_har_dependencies_js_1=require("../../har-dedepulicate/collect_duplicate_har_dependencies.js"),config_file_loader_js_1=require("../../utils/loader/config-file-loader.js"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),oh_package_loader_js_1=require("../../utils/loader/file/oh-package-loader.js"),project_task_initializer_js_1=require("../task-initializer/project-task-initializer.js"),resolver_cache_js_1=require("../../utils/resolver/resolver-cache.js"),one_sdk_validator_js_1=require("../../utils/one-sdk-validator.js"),abstract_plugin_builder_js_1=require("./abstract-plugin-builder.js"),module_incremental_skip_optimization_js_1=require("../hooks/module-incremental-skip-optimization.js"),task_schedule_optimization_js_1=require("../hooks/task-schedule-optimization.js"),ohpm_load_install_js_1=require("../hooks/ohpm-load-install.js");class AppPluginBuilder extends abstract_plugin_builder_js_1.AbstractPluginBuilder{constructor(e,i){super(i),this.project=e}prepare(){this._log.debug("App plugin prepare start..."),config_file_loader_js_1.configFileLoader.clean(),res_model_loader_js_1.resModelLoader.clean(),oh_package_loader_js_1.ohPackageLoader.clean(),this._log.debug("App plugin prepare end...")}createPlugin(){return this._log.debug("App plugin creating..."),this.initializationStrategy.createAppPlugin(this.project)}registerHooks(e){this._log.debug("App plugin register hook start..."),this.registerAfterBindSystemPluginsHook(e),this.registerNodeEvaluatedInternalHook(e),hvigor_1.hvigorCore.hvigorNodeEvaluatedInternalHook(()=>{(0,collect_duplicate_har_dependencies_js_1.processHarDeduplicate)(e)}),this.registerOhpmLoadInstallHook(e),this.registerModuleSkipOptimizationHook(this.project),this.registerTaskScheduleOptimizationHook(this.project),this._log.debug("App plugin register hook end...")}registerAfterBindSystemPluginsHook(e){this.project.afterBindSystemPlugins(async()=>{var i;e.initGlobalData(),e.initBuildOptionMap(e._project.getBuildProfilePath()),e.initTaskService(),await(null===(i=e.getTaskService())||void 0===i?void 0:i.setup()),e.initContext(),project_task_initializer_js_1.ProjectTaskInitializer.initialize(e)})}registerNodeEvaluatedInternalHook(e){hvigor_1.hvigorCore.hvigorNodeEvaluatedInternalHook(()=>{var i,r;this.ifThrowBuildModeError(),resolver_cache_js_1.ResolverCache.clear(),null===(i=e.getTaskService())||void 0===i||i.initDependencyInfo(),this.initializeTaskDepends(this.project,void 0,!1),one_sdk_validator_js_1.OneSdkValidator.apiInspection(e.getProjectModel()),e.initTraceData(),null===(r=e.getTaskService())||void 0===r||r.initProductData()})}registerOhpmLoadInstallHook(e){hvigor_1.hvigorCore.hvigorNodeBeforeEvaluatedInternalHook(()=>{(new ohpm_load_install_js_1.OhpmLoadInstallService).ohpmLoadInstall(e)})}registerModuleSkipOptimizationHook(e){"true"===process.env.ENABLE_MODULE_SKIP&&hvigor_1.hvigor.taskGraphResolvedInternal(()=>{(new module_incremental_skip_optimization_js_1.ModuleIncrementalSkipService).processModuleSkip(e)})}registerTaskScheduleOptimizationHook(e){!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal(hvigor_1.INCREMENTAL_OPTIMIZATION)&&hvigor_1.hvigor.taskGraphResolvedInternal(()=>{new task_schedule_optimization_js_1.TaskScheduleOptimizationService(e).computeAndSetCompileDependencies()})}}exports.AppPluginBuilder=AppPluginBuilder;