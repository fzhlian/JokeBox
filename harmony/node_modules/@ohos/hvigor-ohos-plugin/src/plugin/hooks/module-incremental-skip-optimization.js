"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModuleIncrementalSkipService=void 0;const hvigor_1=require("@ohos/hvigor"),inject_util_js_1=require("../../utils/inject-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path"));class ModuleIncrementalSkipService{constructor(){this._log=ohos_logger_js_1.OhosLogger.getLogger(ModuleIncrementalSkipService.name)}processModuleSkip(e){const t=path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),"cache","changed_modules.txt");!fs_1.default.existsSync(t)||inject_util_js_1.InjectUtil.isPreviewProcess()||inject_util_js_1.InjectUtil.isUnitTestProcess()?this._log.warn("Incremental skip feature will be disabled, since record file not exist or in unsupported build mode (preview and unit test)."):hvigor_1.coreParameter.startParams.incrementalExecution?(this.getModuleDependMap(e),this.getBuildModuleStat(e)?this.readChangedFile(t):this._log.warn("Module status not enough, the module level incremental skip feature will be disabled.")):this._log.warn("Since incremental mode has been closed, the module level incremental skip feature will be disabled.")}getBuildModuleStat(e){var t,i;let o=[],l=new Set;const r=hvigor_1.hvigorCore.getExtraConfig().get("module");if(void 0===r)e.getAllSubModules().forEach(e=>{l.add(e.getName())});else for(const t of r.split(",")){const i=t.split("@")[0],l=e.findModuleByName(i);if(void 0===l)return!1;o.push(l)}for(const e of o)l.add(e.getName()),null===(t=hvigor_1.hvigorCore.getModuleDepRelationMap().get(e.getName()))||void 0===t||t.forEach(e=>{l.add(e)});for(const t of l){const o=null===(i=e.findModuleByName(t))||void 0===i?void 0:i.getNodeDir();if(!o)return!1;if(!fs_1.default.existsSync(path_1.default.resolve(o,"build")))return this._log.warn(`When using module incremental skip feature, failed to find build result in module: ${t}`),!1}return!0}getModuleDependMap(e){e.getAllSubModules().forEach(e=>{const t=new Set;e.getAllPluginIds().forEach(i=>{var o,l,r;const n=e.getPluginById(i);Array.from(null!==(r=null===(l=null===(o=null==n?void 0:n.getTaskService())||void 0===o?void 0:o.getDependencyInfo())||void 0===l?void 0:l.getModuleDependencyMap().keys())&&void 0!==r?r:[]).forEach(e=>{t.has(e)||t.add(e)})}),hvigor_1.hvigorCore.getModuleDepRelationMap().set(e.getName(),t)})}readChangedFile(e){const t=fs_1.default.readFileSync(e,"utf8").split("\n").map(e=>e.trim()).filter(e=>""!==e);hvigor_1.hvigorCore.setChangedModuleNameList(new Set(t))}}exports.ModuleIncrementalSkipService=ModuleIncrementalSkipService;