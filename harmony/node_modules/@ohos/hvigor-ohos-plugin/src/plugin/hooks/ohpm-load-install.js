"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhpmLoadInstallService=void 0;const ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),hvigor_1=require("@ohos/hvigor"),oh_package_loader_js_1=require("../../utils/loader/file/oh-package-loader.js"),path_const_js_1=require("@ohos/hvigor/src/common/const/path-const.js"),common_const_js_1=require("../../const/common-const.js"),path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),json_util_js_1=require("../../utils/json-util.js"),run_command_util_js_1=require("../../utils/run-command-util.js"),fs_1=__importDefault(require("fs")),global_project_data_service_js_1=require("../../tasks/service/global-project-data-service.js");class OhpmLoadInstallService{constructor(){this._log=ohos_logger_js_1.OhosLogger.getLogger(OhpmLoadInstallService.name)}ohpmLoadInstall(e){var o;const t=null!==(o=(0,hvigor_1.getAlignTarget)())&&void 0!==o?o:"";this.isOnlyCleanTask()||this.ohpmLoadInstallForBuild(t);const a=global_project_data_service_js_1.GlobalProjectDataService.getInstance().initProjectPkgJsonFileHash(e.getProjectModel());global_project_data_service_js_1.GlobalProjectDataService.getInstance().setProjectPkgJsonFileHash(a)}ohpmLoadInstallForBuild(e){const o=path_1.default.resolve(path_const_js_1.HVIGOR_PROJECT_ROOT_DIR,common_const_js_1.CommonConst.OH_PACKAGE_JSON5);let t;if(fs_extra_1.default.existsSync(o)){const e=json_util_js_1.JsonUtil.getJson5Obj(o),a=hvigor_1.hvigorCore.getParameter().getExtParamInternal(common_const_js_1.CommonConst.PARAMETER_FILE);t=null!=a?a:null==e?void 0:e.parameterFile}if(oh_package_loader_js_1.ohPackageLoader.setIsChangeParameterFile(e,t),oh_package_loader_js_1.ohPackageLoader.loadUpdatedOhPackageToDisk(e,t),oh_package_loader_js_1.ohPackageLoader.shouldDoOhpmInstall()){this._log.info("start to execute ohpm install");const o=process.env.ohpmBin||"ohpm";if(o&&fs_1.default.existsSync(o)||run_command_util_js_1.RunCommandUtil.run("ohpm -v",void 0,!0)){const a=path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),common_const_js_1.CommonConst.DEPENDENCYMAP,e);let s;this._log.debug(`ohpm install command is "${o}" i --all --target_path ${a}`),s=t?`"${o}" i --all --target_path ${a} --parameterFile=${t}`:`"${o}" i --all --target_path ${a}`;run_command_util_js_1.RunCommandUtil.run(s,void 0,!0)||this._log.printErrorExit("OHPM_INSTALL_FAILED")}else this._log.warn("need to configure ohpm environment in your system, please see official guide to configure ohpm environment")}}isOnlyCleanTask(){const e=hvigor_1.hvigor.getCommandEntryTaskInternal();return 1===(null==e?void 0:e.length)&&"clean"===e[0]}}exports.OhpmLoadInstallService=OhpmLoadInstallService;