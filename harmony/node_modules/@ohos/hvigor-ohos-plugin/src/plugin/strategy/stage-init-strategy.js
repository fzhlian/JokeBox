"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.StageInitializationStrategy=void 0;const initialization_strategy_js_1=require("./initialization-strategy.js"),hap_extra_info_js_1=require("../../project/data/hap-extra-info.js"),common_const_js_1=require("../../const/common-const.js"),ohos_plugin_id_js_1=require("../common/ohos-plugin-id.js"),app_plugin_js_1=require("../app-plugin.js"),cangjie_register_js_1=require("../hooks/cangjie-register.js"),hap_plugin_js_1=require("../hap-plugin.js"),hsp_plugin_js_1=require("../hsp-plugin.js"),har_plugin_js_1=require("../har-plugin.js"),task_initializer_js_1=require("../../utils/task-initializer.js"),ohos_logger_1=require("../../utils/log/ohos-logger");class StageInitializationStrategy extends initialization_strategy_js_1.InitializationStrategy{constructor(){super(),this._log=ohos_logger_1.OhosLogger.getLogger(StageInitializationStrategy.name)}createAppPlugin(i){const e=new app_plugin_js_1.AppPlugin(i);return e.doProjectInspection(),e}createHapPlugin(i,e){var t;const a=new cangjie_register_js_1.CangjieRegisterService;this.cangjieObj=a.dealCangjieSchema();const n=this.initPluginParam(new hap_plugin_js_1.HapPlugin(i),i,!0);n.initGlobalData(),this.setUpModulePlugin(n,i),e.creatorManager=task_initializer_js_1.TaskInitializer.initializeHap(n);try{null===(t=this.cangjieObj)||void 0===t||t.registerCangjieHapTask(i,n)}catch(i){this._log.debug(`failed to register the cangjie hap task: ${i}`)}return n}createHspPlugin(i,e){var t;const a=new cangjie_register_js_1.CangjieRegisterService;this.cangjieObj=a.dealCangjieSchema();const n=this.initPluginParam(new hsp_plugin_js_1.HspPlugin(i),i,!0);this.setUpModulePlugin(n,i),e.creatorManager=task_initializer_js_1.TaskInitializer.initializeHsp(n),e.initHspPluginGlobalData(i);try{null===(t=this.cangjieObj)||void 0===t||t.registerCangjieHspTask(i,n)}catch(i){this._log.debug(`failed to register the cangjie hsp task: ${i}`)}return n}createHarPlugin(i,e){var t;const a=new cangjie_register_js_1.CangjieRegisterService;this.cangjieObj=a.dealCangjieSchema();const n=this.initPluginParam(new har_plugin_js_1.HarPlugin(i),i,!1);n.initGlobalData(),this.setUpModulePlugin(n,i),e.creatorManager=task_initializer_js_1.TaskInitializer.initializeHar(n);try{null===(t=this.cangjieObj)||void 0===t||t.registerCangjieHarTask(i,n)}catch(i){this._log.debug(`failed to register the cangjie har task: ${i}`)}return n}createProjectModel(i){const e=i.getProject(),t=e.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_APP_PLUGIN);return t||this._log.printErrorExit("STAGE_NO_SYSTEM_PLUGIN",[`${[e.getBuildFilePath()]}.ts`],[[`${[e.getBuildFilePath()]}.ts`]]),t.getProjectModel()}initPluginParam(i,e,t){const a=this.createProjectModel(e),n=this.createModuleModel(a,e,t);return i.withProjectModel(a).withModuleModel(n).withPluginApiType(hap_extra_info_js_1.ApiType.STAGE).withRuntimeConfigFileName(common_const_js_1.CommonConst.MODULE_JSON5)}setUpModulePlugin(i,e){i.doModuleInspection(),i.initModuleTaskService(!1),i.initBuildOptionMap(e.getBuildProfilePath()),i.initTargetDepends(),i.initModuleCommonTasksForDiffApiType(!1)}}exports.StageInitializationStrategy=StageInitializationStrategy;