"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,s)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__decorate=this&&this.__decorate||function(e,t,i,o){var s,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,o);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(a=(r<3?s(a):r>3?s(t,i,a):s(t,i))||a);return r>3&&a&&Object.defineProperty(t,i,a),a},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractCompileNode=void 0;const os_1=__importDefault(require("os")),path=__importStar(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),const_1=require("@ohos/hvigor/src/common/const/const"),fs_extra_1=__importDefault(require("fs-extra")),ini_1=require("ini"),find_target_product_js_1=require("../../common/find-target-product.js"),project_ohos_config_manager_js_1=require("../../common/global/project-ohos-config-manager.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),sdk_const_js_1=require("../../const/sdk-const.js"),aot_compile_mode_enum_js_1=require("../../enum/aot-compile-mode-enum.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),compile_mode_enum_js_1=require("../../enum/compile-mode-enum.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),build_mode_manager_js_1=require("../../project/build-option/build-mode-manager.js"),build_option_util_js_1=require("../../project/build-option/build-option-util.js"),sdk_info_extension_js_1=require("../../sdk/sdk-info-extension.js"),array_util_js_1=require("../../utils/array-util.js"),file_util_js_1=require("../../utils/file-util.js"),inject_util_js_1=require("../../utils/inject-util.js"),json_util_js_1=require("../../utils/json-util.js"),oh_package_loader_js_1=require("../../utils/loader/file/oh-package-loader.js"),res_model_loader_js_1=require("../../utils/loader/file/res-model-loader.js"),ohos_test_util_js_1=require("../../utils/ohos-test-util.js"),global_project_data_service_js_1=require("../service/global-project-data-service.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js");class AbstractCompileNode extends ohos_hap_task_js_1.OhosHapTask{constructor(e,t,i){var o;super(e,{...i,name:`${AbstractCompileNode.getCompileNodeTaskName(t,i.name)}`}),this.TSIMPORTSENDABLE="ark.tsImportSendable",this.commonOption={path:path.dirname(process.execPath),watchMode:"false"},this.externalApiPaths=[],this.buildOption=e.getBuildOption();const s=e.getTargetData().getTargetName();if(this.codeType=t,this.codeModel=this.moduleModel.getSourceSetByTargetName(s).getCodeMap().get(this.codeType),this.isArkModule=this.service.isArkModule(),this.sourcePath=null===(o=this.codeModel)||void 0===o?void 0:o.getSrcPath(),this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&!this.isFaMode&&this.sourcePath&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(path.resolve(this.sourcePath,".."))){const e=this.moduleModel.getModule().getNodeDir();this.sourcePath=(0,ohos_test_util_js_1.getOhosTestIntermediatesEtsPath)(e)}this.aceSuperVisualPath=path.resolve(this.moduleModel.getSourceRootByTargetName(s),"supervisual"),this.aceModuleJsonPath=this.pathInfo.getIntermediatesArkModuleJsonPath(),fs_extra_1.default.existsSync(this.aceModuleJsonPath)||(this.aceModuleJsonPath=path.resolve(this.pathInfo.getIntermediatesProcessProfile())),this.resourceTable=path.resolve(this.pathInfo.getIntermediatesRes(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),this.rawFileResource=path.resolve(this.pathInfo.getIntermediatesRes(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES,build_directory_const_js_1.BuildDirConst.RAW_FILE),this.resProfileDir=this.pathInfo.getIntermediatesResProfilePath(),this.aceBuildJsonDir=this.pathInfo.getIntermediatesLoaderPath(),this.aceModuleBuild=path.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),this.codeType);const r=this.moduleModel.getSourceRootByTargetName(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET);this.mainCodePath=path.resolve(r,this.codeType.toString().toLowerCase()),this.anBuildOutputPath=path.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),aot_compile_mode_enum_js_1.AotCompileModeEnum.AN),this.isCrossplatform=this.moduleModel.isCrossplatformModule(this.projectModel.getArkUIXConfigJsonObj())}static getCompileNodeTaskName(e,t){return e===code_type_enum_js_1.CodeType.ETS?`${t}ArkTS`:`${t}${e.toUpperCase()}`}collectCustomTypes(){return this.targetService.getCustomTypes()||[]}get expandImportPath(){var e;return this.moduleModel.isHarModule()||null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.expandImportPath}get autoLazyFilter(){var e,t,i,o,s,r,a,n,l;const d=null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.autoLazyFilter;if(void 0===d||void 0===(null==d?void 0:d.include)||void 0===(null==d?void 0:d.exclude))return d;const u=this.targetService.getModuleService().getModuleModel(),c=u.getProfileOpt(),_=this.targetService.getTargetData().getTargetName(),h=null===(o=null===(i=null===(t=u.getTargetOptions().filter(e=>e.name===_)[0].config)||void 0===t?void 0:t.buildOption)||void 0===i?void 0:i.arkOptions)||void 0===o?void 0:o.autoLazyFilter;if(void 0!==h)return h;const p=null===(s=this.getTargetBuildOption(u,_).arkOptions)||void 0===s?void 0:s.autoLazyFilter;if(void 0!==p)return p;const g=null===(a=null===(r=c.buildOption)||void 0===r?void 0:r.arkOptions)||void 0===a?void 0:a.autoLazyFilter;if(void 0!==g)return g;const m=null===(l=null===(n=(0,find_target_product_js_1.findTargetProduct)(u.getParentProject()).buildOption)||void 0===n?void 0:n.arkOptions)||void 0===l?void 0:l.autoLazyFilter;return void 0!==m?m:void 0}getTargetBuildOption(e,t){var i,o,s;const r=e.getProfileOpt(),a=build_option_util_js_1.BuildOptionUtil.getOrDefaultBuildModeBinderSet(null!==(i=r.buildModeBinder)&&void 0!==i?i:[]),n=build_mode_manager_js_1.BuildModeManager.getBuildMode(),l=build_mode_manager_js_1.buildOptionManager.getBuildOptNameFromMapping(a,n,t);let d=null!==(o=r.buildOptionSet)&&void 0!==o?o:[];return d=build_option_util_js_1.BuildOptionUtil.arrayDeduplication(d),build_option_util_js_1.BuildOptionCombiner.processCopyFrom(d),null!==(s=(0,array_util_js_1.getElementFromArr)(d,l))&&void 0!==s?s:{}}async beforeAlwaysAction(){var e,t,i,o,s,r,a;const n=this.expandImportPath;if(this.userProjectConfig={autoLazyImport:null!==(t=null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.autoLazyImport)&&void 0!==t?t:!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal(common_const_js_1.HvigorConfigConst.OHOS_DEFAULTS_AUTOLAZYIMPORT),allowEmptyBundleName:!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal(common_const_js_1.CommonConst.EMPTY_BUNDLENAME),reExportCheckMode:this.getReExportCheckMode(),executionMode:hvigor_1.coreParameter.startParams.optimizationStrategy,usePathPlaceholder:!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal(common_const_js_1.CommonConst.OHOS_ROLLUP_CACHE_USE_PATH_PLACEHOLDER),writeRollupCache:!1!==hvigor_1.hvigorCore.getParameter().getPropertyInternal(common_const_js_1.CommonConst.OHOS_ARK_COMPILE_WRITE_ROLLUP_CACHE),isExpandImportEnabled:!!(null==n?void 0:n.enable),expandImportExclude:(null===(i=null==n?void 0:n.exclude)||void 0===i?void 0:i.length)?null==n?void 0:n.exclude.join(","):"",lazyImportExclude:(null===(o=this.autoLazyFilter)||void 0===o?void 0:o.exclude)?this.autoLazyFilter.exclude.join(","):"",lazyImportInclude:(null===(s=this.autoLazyFilter)||void 0===s?void 0:s.include)?this.autoLazyFilter.include.join(","):"",ignoreCrossplatformCheck:this.isCrossplatform&&this.moduleModel.isIgnoreCrossPlatformCheckModule(this.projectModel.getArkUIXConfigJsonObj()),isHarDeduplicateEnabled:this.targetService.shouldDoDeduplicateTask(),skipOhModulesLint:!0===(null===(r=this.targetService.getBuildOption().arkOptions)||void 0===r?void 0:r.skipOhModulesLint),enableStrictCheckOHModule:this.getEnableStrictCheckOHModule(),disableSendableCheckRules:this.getDisableSendableCheckRules(),useDeclarationFileSignature:!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal(common_const_js_1.CommonConst.OHOS_ETS_LINTER_USE_DECLARATION_FILE_SIGNATURE),customizedOptions:this.customizedOptions,integratedHsp:this.getIntegratedHsp()},this.targetService.shouldDoDeduplicateTask()){let e=null===(a=this.targetService.getBuildOption().resOptions)||void 0===a?void 0:a.idDefinedFilePath;e&&(e=path.isAbsolute(e)?e:path.resolve(this.projectModel.getProjectDir(),e),fs_extra_1.default.existsSync(e)&&(this.userProjectConfig.idDefinedJson5=fs_extra_1.default.statSync(e).mtime))}this.targetService.isIntegratedHsp()&&(this.userProjectConfig.integratedHspUseGetCurrentBundleName=inject_util_js_1.InjectUtil.isIntegratedHspUseGetCurrentBundleName()),this.customTypes=this.collectCustomTypes()}getIntegratedHsp(){var e;return!!this.moduleModel.isHspModule()&&(null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.integratedHsp)}getDisableSendableCheckRules(){var e,t;return null!==(t=null===(e=this.targetService.getBuildOption().strictMode)||void 0===e?void 0:e.disableSendableCheckRules)&&void 0!==t?t:[]}getReExportCheckMode(){var e,t;return null!==(t=null===(e=this.targetService.getBuildOption().arkOptions)||void 0===e?void 0:e.reExportCheckMode)&&void 0!==t?t:"noCheck"}getEnableStrictCheckOHModule(){var e,t;return null!==(t=null===(e=this.targetService.getBuildOption().strictMode)||void 0===e?void 0:e.enableStrictCheckOHModule)&&void 0!==t&&t}get isByteCodeHarOptimize(){return inject_util_js_1.InjectUtil.isByteCodeHarOptimize()}declareInputs(){var e,t,i,o,s,r,a,n,l,d,u,c,_,h,p,g;const m=(new Map).set("debuggable",this.targetService.isDebug()).set("isArk",this.isArkModule).set("needCoverageInsert",inject_util_js_1.InjectUtil.isOhosTestCoverage()).set(this.TSIMPORTSENDABLE,!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal(this.TSIMPORTSENDABLE)).set("customTypes",null!==(e=this.customTypes)&&void 0!==e?e:"").set("isByteCodeHarOptimize",this.isByteCodeHarOptimize);for(const[e,i]of Object.entries(null!==(t=this.packageJsonObj.dependencies)&&void 0!==t?t:{}))m.set(e,`${e}: ${i}`);return this.moduleModel.getModuleType()!==module_type_enum_js_1.ModuleType.Har||(null===(i=this.buildOption)||void 0===i?void 0:i.debuggable)||m.set("sourceMapDir",null!==(o=hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR])&&void 0!==o?o:""),(null===(s=this.buildOption)||void 0===s?void 0:s.debuggable)||m.set("branchElimination",null!==(n=null===(a=null===(r=this.targetService.getBuildOption())||void 0===r?void 0:r.arkOptions)||void 0===a?void 0:a.branchElimination)&&void 0!==n&&n),m.set("caseSensitiveCheck",null!==(u=null===(d=null===(l=this.targetService.getBuildOption())||void 0===l?void 0:l.strictMode)||void 0===d?void 0:d.caseSensitiveCheck)&&void 0!==u&&u),m.set(common_const_js_1.CommonConst.USE_NORMALIZED_OHM_URL,this.getUseNormalizedOHMUrl()),m.set(build_directory_const_js_1.BuildDirConst.TRANSFORM_LIB,null!==(h=null===(_=null===(c=this.targetService.getBuildOption())||void 0===c?void 0:c.arkOptions)||void 0===_?void 0:_.transformLib)&&void 0!==h?h:""),m.set("compatibleSdkVersionStage",this.compatibleSdkVersionStage||""),m.set("skipOhModulesLint",!0===(null===(g=null===(p=this.targetService.getBuildOption())||void 0===p?void 0:p.arkOptions)||void 0===g?void 0:g.skipOhModulesLint)),this.userProjectConfig&&Object.entries(this.userProjectConfig).forEach(([e,t])=>{m.set(e,t)}),m}declareOutputFiles(){var e;const t=(new hvigor_1.FileSet).addEntry(this.aceModuleBuild,{isDirectory:!0});if(this.targetService.getAnBuildMode()===aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_PARTIAL&&t.addEntry(this.anBuildOutputPath,{isDirectory:!0}),this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Har&&!(null===(e=this.buildOption)||void 0===e?void 0:e.debuggable))if(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]){const e=this.getSourceMapDir(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]);t.addEntry(path.resolve(e,build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP),{isDirectory:!1})}else t.addEntry(path.resolve(this.pathInfo.getDefaultSourceMapPath(),build_directory_const_js_1.BuildArtifactConst.SOURCEMAPS_MAP),{isDirectory:!1});return t}declareInputFiles(){const e=(new hvigor_1.FileSet).addEntry(this.aceBuildJsonDir,{isDirectory:!0}).addEntries(this.getAllExistDependentMainPath()).addEntries(this.getAllExistHarSrcPath(),{isDirectory:!0});fs_extra_1.default.existsSync(this.rawFileResource)&&e.addEntry(this.rawFileResource,{isDirectory:!0});this.targetService.getResourceDirs().length>0&&fs_extra_1.default.existsSync(this.resourceTable)&&e.addEntry(this.resourceTable),!this.service.hasLiteDevice()&&fs_extra_1.default.existsSync(this.aceModuleJsonPath)&&e.addEntry(this.aceModuleJsonPath),this.resProfileDir&&fs_extra_1.default.existsSync(this.resProfileDir)&&e.addEntry(this.resProfileDir,{isDirectory:!0}),this.aceSuperVisualPath&&fs_extra_1.default.existsSync(this.aceSuperVisualPath)&&e.addEntry(this.aceSuperVisualPath,{isDirectory:!0}),this.sourcePath&&fs_extra_1.default.existsSync(this.sourcePath)&&e.addEntry(this.sourcePath,{isDirectory:!0});const t=json_util_js_1.JsonUtil.getJson5Obj(this.packageManagerPath);if(t){const i=path.join(this.module.getNodeDir(),t.main||"Index.ets");fs_extra_1.default.existsSync(i)&&fs_extra_1.default.statSync(i).isFile()&&e.addEntry(i)}if(this.targetService.getTargetData().getTargetName()===common_const_js_1.CommonConst.OHOS_TEST){const t=path.resolve(this.module.getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,common_const_js_1.CommonConst.OHOS_TEST);fs_extra_1.default.existsSync(t)&&e.addEntry(t,{isDirectory:!0})}return fs_extra_1.default.existsSync(this.pathInfo.getIntermediatesPkgContextInfoPath())&&e.addEntry(this.pathInfo.getIntermediatesPkgContextInfoPath()),e}getAllExistHarSrcPath(){return this.service.getDependencyRootPaths().map(e=>path.resolve(e,"src","main",this.codeType)).filter(e=>fs_extra_1.default.existsSync(e))}getAllExistDependentMainPath(){return this.service.getDependencyMainPaths().filter(e=>fs_extra_1.default.existsSync(e))}taskShouldDo(){return void 0!==this.sourcePath}moveReleaseMap(e,t,i=this.codeType){const o=path.resolve(e.getPathInfo().getInterMediatesLoaderOutPath(),i,build_directory_const_js_1.BuildArtifactConst.RELEASE_MAP);if(!fs_extra_1.default.existsSync(o))return;const s=path.resolve(this.getTaskTempDir(e),i,build_directory_const_js_1.BuildArtifactConst.RELEASE_MAP);fs_extra_1.default.existsSync(s)&&fs_extra_1.default.removeSync(s),fs_extra_1.default.moveSync(o,s),t.debug(`move ${o} to ${s}`)}async beforeTask(){if(inject_util_js_1.InjectUtil.isColdReload()||fs_extra_1.default.removeSync(this.aceModuleBuild),this.projectModel.isCrossplatformProject()){const e=this.projectModel.getCompileApiMetaByProduct((0,find_target_product_js_1.findTargetProduct)(this.projectModel).name),t=new sdk_info_extension_js_1.SdkInfoExtension(e).getArkUIXInfo();await t.setup();const i=t.getArkUIXRootPath();this.externalApiPaths.push(path.resolve(i))}}getTaskTempDir(e,t=""){const i=path.resolve(this.getArkCompileCachePath(e),`${this.targetService.getBuildMode().toLowerCase()}${t}`);return fs_extra_1.default.existsSync(i)||fs_extra_1.default.mkdirsSync(i),i}getArkCompileCachePath(e){const t=path.resolve(super.getTaskTempDir(e),`${this.targetCompileMode}`);return fs_extra_1.default.existsSync(t)||fs_extra_1.default.mkdirsSync(t),t}validateModuleJson(e){const t=this.pathInfo.getIntermediatesArkModuleJsonPath(),i=json_util_js_1.JsonUtil.getJson5Obj(t);this.validateModulePage(e,i),this.validateAbilitiesAndExtensionAbilitiesSrcEntry(e,i)}initCommonArkConfig(){var e,t,i,o,s;const r=(0,wdk_1.cloneDeep)(null===(e=project_ohos_config_manager_js_1.projectOhosConfigManager.getOverrides())||void 0===e?void 0:e.appOpt),a=this.getPkgContextInfo();let n=this.getResolveConflictMode(),l=new Map;if(n){const e=this.service.getDependencyName2RootPath();!1===e?(n=!1,l=new Map):l=e}const d=fs_extra_1.default.realpathSync.native(this.sdkInfo.getEtsLoader());return{moduleType:this.moduleModel.getModuleType(),perf:hvigor_1.AnalyzeModeMap.get(hvigor_1.hvigorCore.getParameter().getStartParamsInternal().analyze),targetName:`.${this.targetName}`,packageManagerType:this.getPackageManagerType(),localPropertiesPath:path.resolve(this.projectModel.getProjectDir(),"local.properties"),isPreview:!1,isOhosTest:"ohosTest"===this.targetName,isLocalTest:inject_util_js_1.InjectUtil.isLocalTest(),buildMode:this.targetService.getBuildMode(),hotReloadBuild:hvigor_1.hvigorCore.getParameter().getStartParamsInternal().hotReloadBuild,watchMode:"false",aceProfilePath:this.resProfileDir,etsLoaderPath:d,modulePath:this.module.getNodeDir(),testFrameworkPar:{testMode:inject_util_js_1.InjectUtil.isOhosTestCoverage()?common_const_js_1.CommonConst.OHOS_TEST:void 0,coveragePathFilter:inject_util_js_1.InjectUtil.getCoveragePathFilter(),coverageMode:inject_util_js_1.InjectUtil.getCoverageMode()},needCoverageInsert:inject_util_js_1.InjectUtil.isOhosTestCoverage(),debugLine:inject_util_js_1.InjectUtil.isDebugLineEnable(),projectTopDir:path.resolve(this.projectModel.getProjectDir()),compileSdkVersion:this.compileApiVersion,compatibleSdkVersion:this.compatibleApiVersion,originCompatibleSdkVersion:this.originCompatibleSdkVersion,compatibleSdkVersionStage:this.compatibleSdkVersionStage,bundleName:this.getBundleName(r),etsLoaderVersion:this.sdkInfo.getEtsComponentVersion(),etsLoaderReleaseType:this.sdkInfo.getEtsComponentReleaseType(),aotCompileMode:inject_util_js_1.InjectUtil.isOhosTestCoverage()?aot_compile_mode_enum_js_1.AotCompileModeEnum.AOT_NULL:this.targetService.getAnBuildMode(),apPath:this.targetService.getApAbsolutePath(),entryModuleName:this.moduleName,entryModuleVersion:this.packageJsonObj.version,entryPackageName:this.getEntryPackageName(),allModuleNameHash:global_project_data_service_js_1.GlobalProjectDataService.getInstance().getAllModuleNameHash(),externalApiPaths:this.getExternalApiPaths(),compilerTypes:this.customTypes,isCrossplatform:this.isCrossplatform,hvigorPluginFile:this.getHvigorPluginFile(),compilePluginPath:this.moduleModel.getCompilePluginPath(),buildGeneratedProfilePath:path.resolve(this.pathInfo.getGenerateBuildProfileDir(),this.targetName),bundleType:this.getBundleType(r),arkTSVersion:this.targetData.getProduct().arkTSVersion,apiVersion:this.sdkInfo.getSdkVersion(),needCompleteSourcesMap:"ohosTest"===this.targetName||inject_util_js_1.InjectUtil.isOhosTestCoverage()||inject_util_js_1.InjectUtil.isLocalTest()||this.moduleModel.isHarModule()&&!this.targetService.isOpenSource(),isFaMode:this.isFaMode,buildDir:this.pathInfo.getModuleBuildPath(),deviceTypes:this.moduleModel.getDeviceTypes(),pkgContextInfo:a,ohPackagePathMap:oh_package_loader_js_1.ohPackageLoader.OhPackagePathMap,dependencyAliasMap:this.getDependencyAliasMap(a),permission:this.moduleModel.getPermission(),useGetCurrentBundleName:inject_util_js_1.InjectUtil.isIntegratedHspUseGetCurrentBundleName()&&this.targetService.isIntegratedHsp(),projectArkOption:null===(t=this.targetService.getBuildOption())||void 0===t?void 0:t.arkOptions,sourceMapDir:hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]?this.getSourceMapDir(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR]):void 0,branchElimination:null!==(o=null===(i=this.targetService.getBuildOption().arkOptions)||void 0===i?void 0:i.branchElimination)&&void 0!==o&&o,transformLib:this.normalizeTransformLib(),tsImportSendable:!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal(this.TSIMPORTSENDABLE),resolveConflictMode:n,depName2RootPath:l,depName2DepInfo:this.service.getDependencyName2DepInfo(),rootPathSet:Array.from(global_project_data_service_js_1.GlobalProjectDataService.getInstance().getRootPathSet()),useNativeResolver:null===(s=hvigor_1.hvigorCore.getParameter().getPropertyInternal(common_const_js_1.CommonConst.USE_NATIVE_RESOLVER))||void 0===s||s,shouldEmitJs:this.targetCompileMode===compile_mode_enum_js_1.CompileModeEnum.JS_BUNDLE||inject_util_js_1.InjectUtil.isOhosTestCoverage()||!(!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal(common_const_js_1.CommonConst.NO_EMIT_JS)&&this.checkSdkTscSyntaxKind(d)),useTscResolve:!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal(common_const_js_1.CommonConst.USE_TSC_RESOLVE),singleFileEmit:this.targetService.isDebug()&&inject_util_js_1.InjectUtil.isSingleFileEmitEnabled()&&!inject_util_js_1.InjectUtil.isOhosTestCoverage(),userProjectConfig:this.userProjectConfig,executionMode:hvigor_1.coreParameter.startParams.optimizationStrategy,arkCompileCachePath:this.getArkCompileCachePath(this.targetData),autoLazyFilter:this.autoLazyFilter,isHarDeduplicateEnabled:this.targetService.shouldDoDeduplicateTask(),intermediateHarDuplicateDirPath:this.pathInfo.getIntermediatesHarDuplicatePath(),...this.userProjectConfig,...this.getStrictModeConfig()}}get customizedOptions(){var e;const t=null===(e=this.targetService.getBuildOption().packingOptions)||void 0===e?void 0:e.customizedOptions;return(null==t?void 0:t.basePackage)&&(t.basePackage=path.resolve(this.module.getNodeDir(),t.basePackage)),t}getStrictModeConfig(){var e,t,i,o;const s=null===(e=this.buildOption)||void 0===e?void 0:e.strictMode;return(null==s?void 0:s.useNormalizedOHMUrl)&&void 0===(null==s?void 0:s.noExternalImportByPath)&&Object.assign(s,{noExternalImportByPath:!0}),{strictMode:s,useNormalizedOHMUrl:this.getUseNormalizedOHMUrl(),caseSensitiveCheck:null!==(o=null===(i=null===(t=this.targetService.getBuildOption())||void 0===t?void 0:t.strictMode)||void 0===i?void 0:i.caseSensitiveCheck)&&void 0!==o&&o}}getPackageManagerType(){return this.isOhpmProject?"ohpm":"npm"}getBundleType(e){var t,i;return null!==(i=null!==(t=null==e?void 0:e.bundleType)&&void 0!==t?t:this.targetData.getProduct().bundleType)&&void 0!==i?i:this.projectModel.getBundleType()}getEntryPackageName(){return"ohosTest"===this.targetName&&inject_util_js_1.InjectUtil.isOhosTestCoverage()?`${this.packageJsonObj.name}_test`:this.packageJsonObj.name}getBundleName(e){var t,i;return null!==(i=null!==(t=null==e?void 0:e.bundleName)&&void 0!==t?t:this.targetData.getProduct().bundleName)&&void 0!==i?i:this.projectModel.getDefaultBundleName()}checkSdkTscSyntaxKind(e){try{const t=require(path.join(e,"node_modules","typescript")).SyntaxKind;return!!t&&!!(t.ImportDeclaration&&t.ExportDeclaration&&t.CallExpression&&t.ImportEqualsDeclaration)}catch(e){return!1}}getResolveConflictMode(){const e=e=>{if(fs_extra_1.default.existsSync(e)){return(0,ini_1.parse)(fs_extra_1.default.readFileSync(e,{encoding:"utf-8"})).resolve_conflict}};let t=e(path.resolve(this.projectModel.getProjectDir(),".ohpmrc"));return void 0!==t?t:(t=e(path.resolve(os_1.default.homedir(),".ohpm/.ohpmrc")),void 0===t||t)}normalizeTransformLib(){var e,t;if(!inject_util_js_1.InjectUtil.isInTest()&&this.targetService.isSourceCodeHar())return;const i=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.transformLib;return i?path.resolve(this.pathInfo.getModulePath(),i):void 0}getBlockDependencies(){return this.isByteCodeHarOptimize?this.service.getRootHspDependencies().concat(this.service.getRootByteCodeHarDependencies()):this.service.getHspOrByteCodeHarDependencies()}async initDefaultArkCompileConfig(){const e=this.moduleModel.isHspModule()||this.targetService.isByteCodeHar(),t=this.pathInfo.getIntermediatesEtsTgzPath(this.moduleName);return{...this.initCommonArkConfig(),aceModuleJsonPath:this.aceModuleJsonPath,appResource:this.resourceTable,rawFileResource:this.rawFileResource,resourceTableHash:(0,hvigor_1.hashFile)(this.resourceTable),runtimeOS:this.sdkInfo.isOhos?common_const_js_1.CommonConst.OPEN_HARMONY:common_const_js_1.CommonConst.HARMONY_OS,sdkInfo:`${this.sdkInfo.isOhos}:${this.sdkInfo.getSdkVersion()}:${this.sdkInfo.getEtsComponentVersion()}:${this.sdkInfo.getEtsComponentReleaseType()}`,aceModuleRoot:this.sourcePath,compileMode:this.targetCompileMode,aceSuperVisualPath:this.aceSuperVisualPath,aceBuildJson:path.resolve(this.aceBuildJsonDir,build_directory_const_js_1.BuildArtifactConst.LOADER_JSON),cachePath:this.getTaskTempDir(this.targetData),aceModuleBuild:this.aceModuleBuild,supportChunks:!0,declaredFilesPath:e?t:void 0,shouldCollectDirectImportees:this.isByteCodeHarOptimize,isByteCodeHarOptimize:this.isByteCodeHarOptimize,expandImportPath:this.expandImportPath}}async getPreviewCompileConfig(e){const t=this.pathInfo.getBuildConfigPath(!0);let i={};fs_extra_1.default.existsSync(t)?i=fs_extra_1.default.readJsonSync(t):e.debug(`Build config file not found: ${t}`),i.cachePath&&delete i.cachePath;const o={...await this.initDefaultArkCompileConfig(),...i};return o.obfuscationOptions&&delete o.obfuscationOptions,o.watchMode="true",o.isPreview=!0,o.projectPath=o.aceModuleRoot,o.level=e.getLevel(),o.buildDir=this.pathInfo.getModulePreviewPath(),o.sdkPath=this.sdkInfo.sdkDir,o.uiTransformOptimization=!1,fs_extra_1.default.ensureDirSync(o.cachePath),fs_extra_1.default.ensureDirSync(o.aceModuleBuild),o}handleCompileEvents(e,t,i){t&&e&&(e.forEach(e=>{const i=Object.assign(e.head.type===hvigor_1.MetricEventType.DURATION?new hvigor_1.DurationEvent("","","",0,"",""):new hvigor_1.ContinualEvent("","","",0,""),e);hvigor_1.MetricService.getInstance().submit(i),i.getParent()||(t.addChild(i.getId()),i.setParent(t.getId())),i.setLog(i.getName(),hvigor_1.MetricLogType.INFO,i.getDescription())}),i&&this.updateTid(t))}validateAbility(e){const t=this.targetData.getTargetName(),i=this.moduleModel.getSourceSetByTargetName(t).getLegacyModuleTargetRes().getJsonPath();if(!fs_extra_1.default.existsSync(i))return;const o=res_model_loader_js_1.resModelLoader.getConfigJson(i),s=o.module.abilities?o.module.abilities:[],r=path.resolve(this.moduleModel.getModule().getNodeDir(),build_directory_const_js_1.BuildDirConst.SRC,t===common_const_js_1.CommonConst.OHOS_TEST?common_const_js_1.CommonConst.OHOS_TEST:build_directory_const_js_1.BuildDirConst.MAIN),a=new Map;s.forEach(t=>{t.srcLanguage||e.printErrorExit("SRC_LANGUAGE_UNDEFINED",[t.name,o]);const s=t.srcLanguage?t.srcLanguage:"",n=path.resolve(r,s,t.srcPath);fs_extra_1.default.existsSync(n)||e.printErrorExit("SRC_PATH_NOT_FOUND",[t.srcPath,n,i],[[t.srcPath]]),a.set(t.name,s)});(o.module.js?o.module.js:[]).forEach(t=>{var o;if("form"===t.type)return;const s=null!==(o=a.get(t.name))&&void 0!==o?o:"";t.pages.forEach(o=>{var a,n;const l=path.resolve(r,s,`${t.name.substring(1)}`,`${o}.${null!==(n=null===(a=t.mode)||void 0===a?void 0:a.syntax)&&void 0!==n?n:"hml"}`);fs_extra_1.default.existsSync(l)||e.printErrorExit("MODULE_JS_PAGE_NOT_FOUND",[o,l,i],[[o]])})})}updateTid(e){e.getChildren().forEach(t=>{const i=hvigor_1.MetricService.getInstance().getEventById(t);i&&this.updateTid(i.setTid(e.getTid()))})}validateModulePage(e,t){const i=t.module.pages;if(void 0===i)return;const o=`${i.replace(/\$profile:/,"")}.json`,s=path.resolve(this.resProfileDir,o);fs_extra_1.default.existsSync(s)||e.printErrorExit("MODULE_PAGE_NOT_FOUND",[i,s],[[o]])}validateAbilitiesAndExtensionAbilitiesSrcEntry(e,t){this.validateSrcEntry(e,t.module.abilities),this.validateSrcEntry(e,t.module.extensionAbilities)}validateSrcEntry(e,t){const i=this.moduleModel.getSourceSetByTargetName(this.targetData.getTargetName());if(t&&(!t||0!==t.length))for(const o of t){const t=o.srcEntry;if(void 0===t)continue;const s=path.isAbsolute(t)?t:path.resolve(i.getSourceSetRoot(),t);if(this.targetName===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(0,ohos_test_util_js_1.isTemplatesAfterSourceCodeMigration)(i.getSourceSetRoot()))return;if(!file_util_js_1.FileUtil.fileExists(s)&&!this.targetService.isCustomizedHar()){const o=i;e.printErrorExit("MODULE_SRC_ENTRY_NOT_FOUND",[t,o.getModuleTargetRes().getJsonPath()])}}}getHvigorPluginFile(){var e,t;let i=null===(t=null===(e=this.buildOption)||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.compilePluginFile;if(i){const e=path.resolve(this.moduleModel.getProjectDir(),i);i=fs_extra_1.default.existsSync(e)?e:`${e}.ts`}return i}getExternalApiPaths(){return this.compileApiVersion>sdk_const_js_1.ApiVersion.API_VERSION_9&&this.targetData.isHarmonyOS()&&this.sdkInfo.getHmsArkDir()&&this.externalApiPaths.push(this.sdkInfo.getHmsArkDir()),this.externalApiPaths}getUseNormalizedOHMUrl(){var e,t;return!!(null===(t=null===(e=this.buildOption)||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.useNormalizedOHMUrl)}getPkgContextInfo(){const e=this.pathInfo.getIntermediatesPkgContextInfoPath();return json_util_js_1.JsonUtil.getJson5Obj(e)}getDependencyAliasMap(e){const t=new Map;return e?(Object.values(e).forEach(e=>{e.dependencyAlias&&t.set(e.dependencyAlias,e.packageName)}),t):t}getSourceMapDir(e){return path.isAbsolute(e)?path.resolve(hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR],this.moduleName):path.resolve(this.projectModel.getProjectDir(),"hvigor",hvigor_1.coreParameter.properties[const_1.OHOS_ARK_COMPILE_SOURCE_MAP_DIR],this.moduleName)}}__decorate([(0,hvigor_1.Input)()],AbstractCompileNode.prototype,"autoLazyFilter",null),__decorate([(0,hvigor_1.Input)()],AbstractCompileNode.prototype,"customizedOptions",null),exports.AbstractCompileNode=AbstractCompileNode;