"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,s)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ArkCompile=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),hvigor_common_1=require("@ohos/hvigor-common"),hvigor_logger_1=require("@ohos/hvigor-logger"),fse=__importStar(require("fs-extra")),get_obfuscation_rules_js_1=require("../common/obfuscation/get-obfuscation-rules.js"),ohos_trace_js_1=require("../common/trace/ohos-trace.js"),type_js_1=require("../common/trace/type.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),inject_const_js_1=require("../const/inject-const.js"),sdk_const_js_1=require("../const/sdk-const.js"),code_type_enum_js_1=require("../enum/code-type-enum.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),build_profile_utils_js_1=require("../utils/build-profile-utils.js"),byte_code_har_utils_js_1=require("../utils/byte-code-har-utils.js"),dependency_util_js_1=require("../utils/dependency-util.js"),file_util_js_1=require("../utils/file-util.js"),har_target_util_js_1=require("../utils/har-target-util.js"),inject_util_js_1=require("../utils/inject-util.js"),oh_package_loader_js_1=require("../utils/loader/file/oh-package-loader.js"),json_util_js_1=require("../utils/json-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),math_util_js_1=require("../utils/math-util.js"),mock_config_utils_js_1=require("../utils/mock-config-utils.js"),obfuscation_config_resolver_js_1=require("../utils/obfuscation-config-resolver.js"),source_roots_utils_js_1=require("../utils/source-roots-utils.js"),task_util_js_1=require("../utils/task-util.js"),abstract_compile_node_js_1=require("./abstract/abstract-compile-node.js"),task_names_js_1=require("./common/task-names.js"),compile_resource_js_1=require("./compile-resource.js"),generate_loader_json_js_1=require("./generate-loader-json.js"),har_extend_info_js_1=require("./har/har-extend-info.js"),ohos_uitransform_optimization_js_1=require("./module-info/ohos-uitransform-optimization.js"),global_project_data_service_js_1=require("./service/global-project-data-service.js"),target_task_service_js_1=require("./service/target-task-service.js"),run_ark_js_1=require("./worker/run-ark.js"),worker_id_helper_js_1=require("./worker/worker-id-helper.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;class ArkCompile extends abstract_compile_node_js_1.AbstractCompileNode{constructor(e,t,o){super(e,t,o),this._log=ohos_logger_js_1.OhosLogger.getLogger(ArkCompile.name),this.obfuscationHash="",this.localModuleParamMap=new Map,this.needPreloadSoFileSet=new Set,this.writeBuildModePromise=void 0,this.formJsonPathArr=target_task_service_js_1.TargetTaskService.getFormJsonArr(e),this.needSubmitArkTsWidget=(0,task_util_js_1.shouldCompileArkTsWidget)(this.formJsonPathArr,this.moduleModel.isFormExtensionModule(this.targetName)),this.pkgNameToPkgBriefInfo={},this._taskService=e,this.arkdataPathAll=[]}taskShouldDo(){return(void 0!==this.sourcePath||this.checkPackageMain())&&this.checkRollUpPlugin()}declareInputs(){var e,t,o,i,s,r,a,n,l,c,d,u,_,h,g,p,f,m,v,j;const C=super.declareInputs().set("arkTsWdiget",this.needSubmitArkTsWidget),S=hvigor_1.hvigorCore.getExtraConfig().get(common_const_js_1.CommonConst.DEBUG_LINE);S&&C.set(common_const_js_1.CommonConst.DEBUG_LINE,S);const y=this.getObfuscationEnable();return C.set(common_const_js_1.CommonConst.OBFUSCATION_ENABLE,String(y)),C.set(common_const_js_1.CommonConst.OBFUSCATION_FILES_HASH,this.obfuscationHash),C.set(common_const_js_1.CommonConst.TSC_MAX_FLOW_DEPTH,String(null===(o=null===(t=null===(e=this.buildOption)||void 0===e?void 0:e.arkOptions)||void 0===t?void 0:t.tscConfig)||void 0===o?void 0:o.maxFlowDepth)),C.set(common_const_js_1.CommonConst.NO_EXTERNAL_IMPORT_BY_PATH,null!==(i=this.targetService.isNoExternalImportByPath())&&void 0!==i&&i),C.set(common_const_js_1.CommonConst.COPY_CODE_RESOURCE_ENABLE,null===(n=null===(a=null===(r=null===(s=this.targetService.getBuildOption())||void 0===s?void 0:s.resOptions)||void 0===r?void 0:r.copyCodeResource)||void 0===a?void 0:a.enable)||void 0===n||n),(null===(u=null===(d=null===(c=null===(l=this.targetService.getBuildOption())||void 0===l?void 0:l.resOptions)||void 0===c?void 0:c.copyCodeResource)||void 0===d?void 0:d.enable)||void 0===u||u)&&(C.set(common_const_js_1.CommonConst.COPY_CODE_RESOURCE_EXCLUDES,null!==(p=null===(g=null===(h=null===(_=this.targetService.getBuildOption())||void 0===_?void 0:_.resOptions)||void 0===h?void 0:h.copyCodeResource)||void 0===g?void 0:g.excludes)&&void 0!==p?p:[]),C.set(common_const_js_1.CommonConst.COPY_CODE_RESOURCE_INCLUDES,null!==(j=null===(v=null===(m=null===(f=this.targetService.getBuildOption())||void 0===f?void 0:f.resOptions)||void 0===m?void 0:m.copyCodeResource)||void 0===v?void 0:v.includes)&&void 0!==j?j:"undefined")),C.set(common_const_js_1.CommonConst.OHOS_UI_TRANSFORM_OPTIMIZATION,(0,ohos_uitransform_optimization_js_1.getOhosUiTransformOptimization)(this.targetService)),C.set(common_const_js_1.CommonConst.OHOS_ROLLUP_CACHE_USE_SOURCE_HASH,!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal(common_const_js_1.CommonConst.OHOS_ROLLUP_CACHE_USE_SOURCE_HASH)),C.set("localModuleParamMap",JSON.stringify(Object.fromEntries(this.localModuleParamMap))),C}declareOutputFiles(){const e=super.declareOutputFiles(),t=this.targetService.getTargetData().getTargetName();return!this.moduleModel.isHspModule()||t===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET||inject_util_js_1.InjectUtil.isColdReload()||inject_util_js_1.InjectUtil.isUnitTestProcess()||inject_util_js_1.InjectUtil.isHotReload()||inject_util_js_1.InjectUtil.isPreviewProcess()||e.addEntry(path_1.default.resolve(this.aceModuleBuild,`../${build_directory_const_js_1.BuildDirConst.DECLARE_FILE_OUTPUT}`),{isDirectory:!0}),this.allowToPreloadSystemSo()&&e.addEntry(this.pathInfo.getPreloadSoFilePath(),{isDirectory:!1}),e}addRootForDependencyCustomTypes(e,t){const o=[],i=e.getDependencyRootPath(),s=e.getPackageJsonObj(),r=Object.keys({...(null==s?void 0:s.devDependencies)||{},...(null==s?void 0:s.dependencies)||{}}),a=[],n=this.targetService.getCustomTypes();if(t.forEach(e=>{if([e,`@types/${e}`].some(e=>r.includes(e)))return void((null==n?void 0:n.includes(e))||a.push(e));!(0,build_profile_utils_js_1.getCustomTypePathIfExists)(i,e)?a.push(e):o.push(path_1.default.isAbsolute(e)?e:path_1.default.resolve(i,e))}),a.length){const e=(0,hvigor_common_1.getOsLanguage)(),t=(0,hvigor_logger_1.getUrl)(hvigor_logger_1.DEVELOPER_URL),o=`Can not find custom types: '[${a.join(",")}]', try to configure at file: ${this.service.getProjectModel().getProfilePath()}\n`;t?this._log.warn(`${o}Reference: ${t}/consumer/${e}/doc/harmonyos-guides/arkoptions-guide#types`):this._log.warn(`${o}Reference: Go to the official website to see Guides > Application Framework > ArkTS > ArkTS Compilation Toolchain > Configuring arkOptions in build-profile.json5`)}return o}getDependencyCustomTypes(e,t){var o,i;let s=[];if(e.isLocal()){s=(null===(o=(0,dependency_util_js_1.getLocalDependencyBuildOptions)(e,t).arkOptions)||void 0===o?void 0:o.types)||[]}else{s=(null===(i=e.getPackageJsonObj().metadata)||void 0===i?void 0:i.customTypes)||[]}return this.addRootForDependencyCustomTypes(e,s)}collectCustomTypes(){const e=[...this.targetService.getCustomTypes()||[]];if(!inject_util_js_1.InjectUtil.isDependenciesTypesEnable())return e;const t=har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService);return this.service.getHarDependencies().forEach(o=>{const i=this.getDependencyCustomTypes(o,t);i.length&&e.push(...i)}),this._log.debug(`All custom types found in module '${this.moduleName}': ${JSON.stringify(e)}`),e}addSelfPreloadSystemSoFileList(){var e,t;const o=null===(e=this._taskService.getTargetData().getModuleSourceSetModel().getModuleTargetRes().getModuleJsonOpt())||void 0===e?void 0:e.module;null===(t=null==o?void 0:o.abilities)||void 0===t||t.forEach(e=>{(0,task_util_js_1.isHomeAbility)(e)&&this.needPreloadSoFileSet.add(path_1.default.resolve(this.pathInfo.getModuleSrcMainPath(),e.srcEntry))}),(null==o?void 0:o.srcEntry)&&this.needPreloadSoFileSet.add(path_1.default.resolve(this.pathInfo.getModuleSrcMainPath(),o.srcEntry))}addDependencyPreloadSystemSoFileList(){this.service.getHarDependencies().forEach(e=>{var t,o,i;e.isByteCodeHarDependency()||null===(i=null===(o=null===(t=e.getModuleJsonObj())||void 0===t?void 0:t.module)||void 0===o?void 0:o.abilities)||void 0===i||i.forEach(t=>{(0,task_util_js_1.isHomeAbility)(t)&&this.needPreloadSoFileSet.add(path_1.default.resolve(e.getDependencyRootPath(),build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,t.srcEntry))})})}allowToPreloadSystemSo(){return this.isPreloadSystemSoEnabled&&!this.moduleModel.isHspModule()}addPreloadSystemSoFileList(){this.addSelfPreloadSystemSoFileList(),this.addDependencyPreloadSystemSoFileList()}async beforeAlwaysAction(){await super.beforeAlwaysAction(),this.obfuscationOptions=await this.getObfuscationOptions(),this.obfuscationOptions&&(this.obfuscationHash=this.computeObfuscationFileHash(this.obfuscationOptions)),this._log.debug(`obfuscationOptions: ${JSON.stringify(this.obfuscationOptions)}`),this.arkDataCompile(),this.setPkgNameToPkgBriefInfo(),this.setByteCodeHarToDependencyKeys(),this.setLocalModuleParamMap(),this.userProjectConfig&&(this.userProjectConfig.isPreloadSoEnabled=this.allowToPreloadSystemSo())}setByteCodeHarToDependencyKeys(){const e=inject_util_js_1.InjectUtil.isInTest(),t=!!this.obfuscationOptions,o=this.getUseNormalizedOHMUrl(),i=inject_util_js_1.InjectUtil.isColdReload()||inject_util_js_1.InjectUtil.isHotReload()||inject_util_js_1.InjectUtil.isPreviewProcess();!t||!o||this.moduleModel.isHarModule()||e||i||(this.byteCodeHarToDependencyKeys=(0,byte_code_har_utils_js_1.getByteCodeHarToDependencyKeys)(this.targetService))}setLocalModuleParamMap(){this.projectModel.getProject().getAllSubModules().forEach(e=>{var t;const o=path_1.default.resolve(e.getNodeDir(),common_const_js_1.CommonConst.OH_PACKAGE_JSON5),i=oh_package_loader_js_1.ohPackageLoader.getOhPackageJsonObj(o),s={parameterFilePath:this.projectModel.getParameterFileAbsolutePath(),ohPackageFilePath:o};if((null==i?void 0:i.version)&&(null==i?void 0:i.version.match(common_const_js_1.ParameterizationConst.REGEX))){const o=file_util_js_1.FileUtil.extracted(null==i?void 0:i.version,this.projectModel.getParameterFileObj(),s);null===(t=this.localModuleParamMap)||void 0===t||t.set(e.getNodeDir(),o)}})}async beforeTask(){if(await super.beforeTask(),fse.existsSync(this.pathInfo.getPreloadSoFilePath())&&fse.removeSync(this.pathInfo.getPreloadSoFilePath()),!this.targetService.isDebug())if(this.hasCacheBoosterPlugin())await this.checkAndCleanCache();else{const e=this.getIncrementalCacheItem(common_const_js_1.CommonConst.OBFUSCATION_ENABLE);if(String(e)!==String(this.getObfuscationEnable()))return this._log.debug("Clean the arkts cache due to obfuscation config changes."),void await this.cleanCache();this.getIncrementalCacheItem(common_const_js_1.CommonConst.OBFUSCATION_FILES_HASH)!==this.obfuscationHash&&(this._log.debug("Clean the arkts cache due to obfuscation file changes."),await this.cleanCache())}}declareInputFiles(){var e,t;const o=super.declareInputFiles().addEntries(this.formJsonPathArr),i=this.targetService.getTargetData().getTargetName(),s=this.pathInfo.getGenerateBuildProfilePath(i);fse.existsSync(s)&&o.addEntry(s);const r=this.targetService.getModuleService().getModuleModel().getProjectDir(),a=path_1.default.resolve(r,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.CPP_TYPES);fse.existsSync(a)&&o.addEntry(a,{isDirectory:!0}),this.service.getHarModuleDependencies().forEach(([,e])=>{var t;const i=e.getDependencyRootPath(),s=path_1.default.resolve(i,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.CPP_TYPES);fse.existsSync(s)&&o.addEntry(s,{isDirectory:!0});const r=path_1.default.resolve(i,build_directory_const_js_1.BuildArtifactConst.BUILD_PROFILE_FILE);fse.existsSync(r)&&o.addEntry(r);const a=null===(t=this.pkgNameToPkgBriefInfo[e.getPackageName()])||void 0===t?void 0:t.originalSourceRoots;(null==a?void 0:a.length)&&a.forEach(e=>{const t=path_1.default.resolve(i,e);fse.existsSync(t)&&o.addEntry(path_1.default.resolve(i,e),{isDirectory:!0})})});const n=null===(t=null===(e=this.targetService.getTargetData().getTargetOpt())||void 0===e?void 0:e.source)||void 0===t?void 0:t.sourceRoots;(null==n?void 0:n.length)&&n.forEach(e=>{o.addEntry(path_1.default.resolve(this.pathInfo.getModulePath(),e),{isDirectory:!0})});const l=this.moduleModel.getMockConfigPath();fse.existsSync(l)&&(o.addEntry(l,{isDirectory:!1}),o.addEntries((0,mock_config_utils_js_1.getMockConfigSources)(l,this.moduleModel.getProjectDir())));const c=this.moduleModel.getCompilePluginPath();return c&&fse.existsSync(c)&&o.addEntry(c),o}async doTaskAction(){this.validateModuleJson(this._log),this.allowToPreloadSystemSo()&&this.addPreloadSystemSoFileList();const e=await this.initDefaultArkCompileConfig();this._log.debug("build config:"),this._log.anonymizeDebug(e),e.externalApiPaths.length>0&&this._log.debug(`Compile arkts with external api path: ${e.externalApiPaths.join(path_1.default.delimiter)}`),e.obfuscationOptions&&(await fse.ensureDir(e.obfuscationOptions.obfuscationCacheDir),await fse.ensureDir(path_1.default.dirname(e.obfuscationOptions.exportRulePath))),e.cachePath&&this.trace(e.cachePath),fse.ensureDirSync(e.cachePath),fse.ensureDirSync(e.aceModuleBuild);let t=null,o=hvigor_1.coreParameter.properties.ohosArkCompileMaxSize;(void 0===o||o<=0||o>hvigor_1.PoolConstant.MAX_POOL_NUM)&&(o=common_const_js_1.ArkPackConst.MAX_ARK_COMPILE_NUM);const i=[...new Array(o).keys()];let s=i;const r=(0,worker_id_helper_js_1.getWorkerIdWithModule)(e.modulePath),a=this.getWorkerPool().getMaxPoolNum();if(void 0!==r&&a>0&&(s=[(0,math_util_js_1.mod)(r,Math.min(a,o))]),t=await(0,run_ark_js_1.submitArkCompileWork)(this,this.getWorkerPool(),this._log,e,async(o,i)=>{void 0!==i&&(0,worker_id_helper_js_1.setWorkerIdWithModule)(e.modulePath,i),this.moveReleaseMap(this.targetData,this._log,this.codeType),this.handleCompileEvents(o,t?this.getSubDurationEvent(t):this.durationEvent,!1),await this.writeBuildMode(e)},s),this.needSubmitArkTsWidget){const t=await this.initWidgetDefaultArkCompileConfig();let s=i;const r=(0,worker_id_helper_js_1.getWorkerIdWithModule)(e.modulePath,!0);void 0!==r&&a>0&&(s=[(0,math_util_js_1.mod)(r,Math.min(a,o))]),t.ignoreWarning=!0;let n=null;n=await(0,run_ark_js_1.submitArkCompileWork)(this,this.getWorkerPool(),this._log,t,async(o,i)=>{void 0!==i&&(0,worker_id_helper_js_1.setWorkerIdWithModule)(e.modulePath,i,!0),this.handleCompileEvents(o,n?this.getSubDurationEvent(n):this.durationEvent,!1),await this.writeBuildMode(t)},s)}(0,task_util_js_1.warnCreateBuildProfileTask)(this.targetData,this.targetService,this._log)}async writeBuildMode(e){if(!this.writeBuildModePromise){const t=path_1.default.resolve(e.arkCompileCachePath,"compileInfo.json");this.writeBuildModePromise=new Promise(o=>{e.buildMode&&(fse.ensureFileSync(t),fse.writeJsonSync(t,{buildMode:e.buildMode}),o())}).finally(()=>{this.writeBuildModePromise=void 0})}await this.writeBuildModePromise}trace(e){const t=path_1.default.resolve(e,hvigor_arkts_compose_1.MSGPACK_COMPILE_CACHE_DIR_NAME);ohos_trace_js_1.ohosTrace.traceIncrement(this.moduleName,type_js_1.TraceIncrement.COMPILE_ARKTS,fse.existsSync(t))}getSelfPkgBriefInfo(){var e;const t=null===(e=this.targetData.getTargetOpt().source)||void 0===e?void 0:e.sourceRoots,o=this.pathInfo.getModulePath(),i=this.packageJsonObj.name||this.moduleName,s={pkgRoot:o,originalSourceRoots:t,sourceRoots:[...t||[],path_1.default.relative(o,this.pathInfo.getModuleSrcMainPath()),path_1.default.relative(o,path_1.default.resolve(this.pathInfo.getGenerateBuildProfileDir(),this.targetName))],pkgName:i};return{[i]:s}}setPkgNameToPkgBriefInfo(){this.pkgNameToPkgBriefInfo={...(0,source_roots_utils_js_1.getDependenciesPkgBriefInfo)(this.targetService),...this.getSelfPkgBriefInfo()}}getCollectImportersConfig(){var e,t;const o=this.pathInfo.getBuildConfigPath(),i=json_util_js_1.JsonUtil.getJson5Obj(o);if("hotReload"===(null===(e=null==i?void 0:i.patchConfig)||void 0===e?void 0:e.mode)||"coldReload"===(null===(t=null==i?void 0:i.patchConfig)||void 0===t?void 0:t.mode))return{relativeDir:path_1.default.resolve(this.pathInfo.getModuleSrcMainPath(),"ets"),buildConfigJsonPath:this.pathInfo.getBuildConfigPath(),isReload:!1}}getTscAddressPaths(e){const t=this.pkgNameToPkgBriefInfo,o={};return Object.values(t).forEach(t=>{var i;const s=null===(i=t.sourceRoots)||void 0===i?void 0:i.map(o=>path_1.default.join(path_1.default.relative(e,path_1.default.resolve(t.pkgRoot,o)),"*"));(null==s?void 0:s.length)&&(o[`${t.pkgName}/*`]=s)}),o}async initDefaultArkCompileConfig(){var e,t,o,i,s,r,a,n,l,c,d,u,_,h;const g=this.targetData.getModuleModel().getMockConfigPath(),p={...await super.initDefaultArkCompileConfig(),pkgNameToPkgBriefInfo:this.pkgNameToPkgBriefInfo,projectModel:global_project_data_service_js_1.GlobalProjectDataService.getInstance().getCompileProjectModel(),pkgJsonFileHash:global_project_data_service_js_1.GlobalProjectDataService.getInstance().getProjectPkgJsonFileHash(),allModulePaths:global_project_data_service_js_1.GlobalProjectDataService.getInstance().getAllModulePaths(),routerMap:this.getRouterMapConfig(),obfuscationOptions:this.obfuscationOptions,byteCodeHarToDependencyKeys:this.byteCodeHarToDependencyKeys,compileBlockPkg:this.getBlockDependencies().map(e=>e.getDependencyName()),mockParams:{decorator:"@MockSetup",packageName:"@ohos/hamock",etsSourceRootPath:"src/main/ets",mockConfigPath:fse.existsSync(g)?g:void 0,mockConfigKey2ModuleInfo:(0,mock_config_utils_js_1.getMockConfigKey2ModuleInfoMap)(this.moduleModel.getMockConfigPath(),this.service),source2ModuleIdMap:(0,mock_config_utils_js_1.getSource2ModuleIdMap)(g,this.moduleModel.getProjectDir())},caseSensitiveCheck:!(!(0,hvigor_1.isWindows)()&&!(0,hvigor_1.isMac)())&&(null!==(o=null===(t=null===(e=this.targetService.getBuildOption())||void 0===e?void 0:e.strictMode)||void 0===t?void 0:t.caseSensitiveCheck)&&void 0!==o&&o),copyCodeResourceEnable:null===(a=null===(r=null===(s=null===(i=this.targetService.getBuildOption())||void 0===i?void 0:i.resOptions)||void 0===s?void 0:s.copyCodeResource)||void 0===r?void 0:r.enable)||void 0===a||a,copyCodeResourceExcludes:null!==(d=null===(c=null===(l=null===(n=this.targetService.getBuildOption())||void 0===n?void 0:n.resOptions)||void 0===l?void 0:l.copyCodeResource)||void 0===c?void 0:c.excludes)&&void 0!==d?d:[],copyCodeResourceIncludes:null===(h=null===(_=null===(u=this.targetService.getBuildOption())||void 0===u?void 0:u.resOptions)||void 0===_?void 0:_.copyCodeResource)||void 0===h?void 0:h.includes,uiTransformOptimization:(0,ohos_uitransform_optimization_js_1.getOhosUiTransformOptimization)(this.targetService),sdkPath:this.sdkInfo.sdkDir,needPreloadSoFileSet:this.needPreloadSoFileSet,preloadSoFilePath:this.pathInfo.getPreloadSoFilePath(),useSourceHash:!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal(common_const_js_1.CommonConst.OHOS_ROLLUP_CACHE_USE_SOURCE_HASH),localModuleParamMap:this.localModuleParamMap};return p.aceModuleRoot||(p.aceModuleRoot=path_1.default.resolve(this.pathInfo.getModuleSrcMainPath(),this.codeType)),p.otherPaths=this.getTscAddressPaths(p.aceModuleRoot),p.collectImportersConfig=this.getCollectImportersConfig(),p}async initWidgetDefaultArkCompileConfig(){const e=this.getTaskTempDir(this.targetData,"_widget"),t={...await this.initDefaultArkCompileConfig(),widgetCompile:"true",cachePath:e,aceBuildJson:this.pathInfo.getWidgetLoaderJsonPath(),byteCodeHar2HspDep:this.service.getByteCodeHar2Hsp()};return t.obfuscationOptions&&(t.obfuscationOptions={...t.obfuscationOptions,obfuscationCacheDir:path_1.default.resolve(e,"obfuscation")}),t}getRouterMapConfig(){var e;const t=new Map,o=[];this.service.getHarDependencies().forEach(e=>{if(e.isLocal()){const t=(0,dependency_util_js_1.getLocalDependencyRouterMap)(this.projectModel,this.targetService,e);t&&Array.prototype.push.apply(o,t)}else{const t=dependency_manager_js_1.DependencyManager.getRemoteDependencyRouterMapObjList(e);t&&Array.prototype.push.apply(o,t)}});const i=null!==(e=this.targetService.getTargetRouterMapObjList(this.moduleModel))&&void 0!==e?e:o;return null==i||i.sort((e,t)=>e.name.localeCompare(t.name)).forEach(e=>{const o=path_1.default.resolve(e.moduleNodeDir,e.pageSourceFile),i=`${e.name}@${e.buildFunction}`,s=t.has(o)?`${t.get(o)}#${i}`:i;t.set(o,s)}),t}arkDataCompile(){const e=this._taskService.getModuleService().getHarDependencies();if(void 0===e||e.length<=0)return;const t=this._taskService.getModuleService().getModuleModel().getName(),o=this._taskService.getTargetData().getPathInfo().getModuleSrcMainResourceRawfileArkdataPath(),i=this._taskService.getTargetData().getPathInfo().getIntermediatesResArkDataPath();this.arkdataPathAll.push(o);const s=new Set;if(fse.existsSync(o)){const e=fse.readdirSync(o);for(const t of e)s.add(t)}fse.existsSync(i)||fse.mkdirSync(i,{recursive:!0});for(const o of e){const e=o.getPackageName(),r=this._taskService.getModuleService().getProjectModel().getModuleModelByName(e),a=null==r?void 0:r.getProjectDir();if(void 0===a)continue;const n=path_1.default.resolve(a,build_directory_const_js_1.BuildDirConst.SRC,build_directory_const_js_1.BuildDirConst.MAIN,build_directory_const_js_1.BuildDirConst.RESOURCES,build_directory_const_js_1.BuildDirConst.RAW_FILE,build_directory_const_js_1.BuildDirConst.ARK_DATA,build_directory_const_js_1.BuildDirConst.SCHEMA);if(!fse.existsSync(n))continue;this.arkdataPathAll.push(n);const l=fse.readdirSync(n);for(const o of l){s.has(o)&&this._log.printErrorExit("SAME_NAME_ARK_DATA_JSON_FILE",[o,e,o,t]),s.add(o);const r=path_1.default.resolve(n,o),a=path_1.default.resolve(i,o);fse.existsSync(i)&&fse.copyFileSync(r,a)}}}initTaskDepends(){if((0,task_util_js_1.limitMinApiVersion)(this.targetData,sdk_const_js_1.ApiVersion.API_VERSION_9)){this.declareDependsList(generate_loader_json_js_1.GenerateLoaderJson.name,compile_resource_js_1.CompileResource.name,CommonTask.CREATE_BUILD_PROFILE.name);har_target_util_js_1.HarTargetUtil.calDepHarTargets(this.targetService).forEach((e,t)=>this.declareDepends(`${e}@${CommonTask.CREATE_HAR_BUILD_PROFILE.name}`,t))}else this.declareDependsList(generate_loader_json_js_1.GenerateLoaderJson.name,compile_resource_js_1.CompileResource.name)}async getObfuscationOptions(){var e,t,o,i;const s=this.targetService.getBuildOption();if(s.debuggable)return void("true"===(null===(e=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.ARK_OBFUSCATION))||void 0===e?void 0:e.toLowerCase())&&this._log.warn("Obfuscation is only enabled in release mode."));const r=path_1.default.resolve(this.getTaskTempDir(this.targetData),"obfuscation");let a=null===(t=s.arkOptions)||void 0===t?void 0:t.obfuscation;s.artifactType&&this._log.warn("buildOption/artifactType is deprecated, please use buildOption/arkOptions/obfuscation instead."),s.artifactType===har_extend_info_js_1.ArtifactType.OBFUSCATION&&void 0===(null===(o=null==a?void 0:a.ruleOptions)||void 0===o?void 0:o.enable)&&(a={...a,ruleOptions:{enable:!0},libDir:this.module.getNodeDir()});const n=this.getObfuscationEnable();if(!a||void 0===(null===(i=a.ruleOptions)||void 0===i?void 0:i.enable)){if(void 0===n)return;this._log.debug(`Command line specified enable was used, obfuscationEnable is: ${n}`),a={ruleOptions:{enable:n},libDir:this.module.getNodeDir()}}if(!(this.compileApiVersion<sdk_const_js_1.ApiVersion.API_VERSION_10||this.isFaMode)){if(this.moduleModel.isHapModule()&&void 0!==a.consumerFiles&&this._log.warn("The property 'consumerFiles' is not support in hap moduleÂ´s build-profile.json5"),void 0!==n&&a.ruleOptions&&(a.ruleOptions.enable=n),!0===hvigor_1.hvigorCore.getParameter().getPropertyInternal("ohos.obfuscationRules.optimization"))try{return(0,get_obfuscation_rules_js_1.getObfuscationOptionsWithCache)(this.targetService,a,r)}catch(e){return(0,obfuscation_config_resolver_js_1.resolveObfuscationOptions)(this.targetService,a,r)}return(0,obfuscation_config_resolver_js_1.resolveObfuscationOptions)(this.targetService,a,r)}this._log.warn(`Obfuscation is supported in stage mode of API${sdk_const_js_1.ApiVersion.API_VERSION_10} or later.`)}computeObfuscationFileHash(e){var t,o,i,s,r,a,n,l;const c=[];c.push(...null!==(i=null===(o=null===(t=e.selfConfig)||void 0===t?void 0:t.ruleOptions)||void 0===o?void 0:o.rules)&&void 0!==i?i:[]),c.push(...null!==(r=null===(s=e.selfConfig)||void 0===s?void 0:s.consumerRules)&&void 0!==r?r:[]),c.push(...e.dependencies.hars),c.push(...e.dependencies.hsps);for(const t of[...e.dependencies.libraries,...e.dependencies.hspLibraries])c.push(...null!==(n=null===(a=t.ruleOptions)||void 0===a?void 0:a.rules)&&void 0!==n?n:[]),c.push(...null!==(l=t.consumerRules)&&void 0!==l?l:[]);const d=(0,hvigor_common_1.createHash)();for(const e of c)fse.existsSync(e)&&d.update(fse.readFileSync(e));return d.digest("hex")}getIncrementalCacheItem(e){var t,o,i;return null===(i=null===(o=null===(t=hvigor_1.ProjectCacheService.getInstance(this.projectModel.getProject()).getTaskSnapShot(this.getName(),this.module))||void 0===t?void 0:t.getInputs())||void 0===o?void 0:o.find(t=>t.getName()===e))||void 0===i?void 0:i.getValue()}async cleanCache(){const e=this.getTaskTempDir(this.targetData);await fse.emptydir(e);const t=path_1.default.resolve(e,"..",".ts_checker_cache");fse.existsSync(t)&&await fse.rm(t)}getObfuscationEnable(){var e,t,o,i,s;const r=null===(e=hvigor_1.hvigorCore.getExtraConfig().get(inject_const_js_1.InjectConst.ARK_OBFUSCATION))||void 0===e?void 0:e.toLowerCase();return"false"!==r&&("true"===r||(null===(s=null===(i=null===(o=null===(t=this.buildOption)||void 0===t?void 0:t.arkOptions)||void 0===o?void 0:o.obfuscation)||void 0===i?void 0:i.ruleOptions)||void 0===s?void 0:s.enable))}checkPackageMain(){const e=this.packageJsonObj.main?this.packageJsonObj.main:build_directory_const_js_1.BuildArtifactConst.INDEX_ETS;return fse.existsSync(path_1.default.resolve(this.pathInfo.getModulePath(),e))}checkRollUpPlugin(){return this.codeType===code_type_enum_js_1.CodeType.ETS?this.sdkInfo.hasRollUpPluginInEtsLoader:this.sdkInfo.hasRollUpPluginInJsLoader}onFailed(e){super.onFailed(e);const t=e;t.extraInfo&&(t.extraInfo.infoMsg&&this._log.info(t.extraInfo.infoMsg),t.extraInfo.warnMsg&&this._log.warn(t.extraInfo.warnMsg))}async checkAndCleanCache(){const e=path_1.default.resolve(this.getTaskTempDir(this.targetData),ArkCompile.TASK_COMPILE_ARK_TS_FILE_NAME),t=String(this.getObfuscationEnable()),o=this.obfuscationHash;let i,s;try{if(await fse.pathExists(e)){const t=await fse.readFile(e,"utf-8"),o=JSON.parse(t);i=o.enable,s=o.hash,"undefined"===s&&(s=void 0)}}catch(e){this._log.debug("read obfuscation cache file error: ",e)}t!==i&&(this._log.debug("Clean the arkts cache due to obfuscation config changes."),await this.cleanCache()),o!==s&&(this._log.debug("Clean the arkts cache due to obfuscation file changes."),await this.cleanCache()),await fse.writeFile(e,JSON.stringify({enable:t,hash:o}),"utf-8")}hasCacheBoosterPlugin(){const e=this.targetService.getModuleService().getNode().getAllPluginIds();for(const t of e)if("cache-booster"===t)return!0;return!1}}exports.ArkCompile=ArkCompile,ArkCompile.TASK_COMPILE_ARK_TS_FILE_NAME="TaskCompileArkTS.cache";