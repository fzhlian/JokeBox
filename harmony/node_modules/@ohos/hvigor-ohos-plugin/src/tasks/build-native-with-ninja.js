"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildNativeWithNinja=void 0;const promises_1=__importDefault(require("fs/promises")),path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),fs_extra_1=__importDefault(require("fs-extra")),command_builder_modifier_js_1=require("../builder/command-builder-modifier.js"),native_command_builder_js_1=require("../builder/native-command-builder.js"),common_const_js_1=require("../const/common-const.js"),cpu_abi_enum_js_1=require("../enum/cpu-abi-enum.js"),collect_duplicate_har_dependencies_js_1=require("../har-dedepulicate/collect_duplicate_har_dependencies.js"),cmake_util_js_1=require("../utils/cmake/cmake-util.js"),file_util_js_1=require("../utils/file-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),abstract_build_native_js_1=require("./abstract-build-native.js"),build_native_with_cmake_js_1=require("./build-native-with-cmake.js"),task_names_js_1=require("./common/task-names.js");var Task=task_names_js_1.TaskNames.Task;class BuildNativeWithNinja extends abstract_build_native_js_1.AbstractBuildNative{constructor(e){super(e,Task.BUILD_NATIVE_WITH_NINJA),this._log=ohos_logger_js_1.OhosLogger.getLogger(BuildNativeWithNinja.name)}initTaskDepends(){var e,t,a;this.declareDepends(build_native_with_cmake_js_1.BuildNativeWithCmake.name);for(const i of this.service.getDependencyInfo().getModuleDependencyMap().keys()){const s=null!==(t=null!==(e=this.projectModel.getTarget(i,this.targetName))&&void 0!==e?e:this.projectModel.getTarget(i,"default"))&&void 0!==t?t:this.projectModel.getTarget(i),o=null!==(a=null==s?void 0:s.getTargetData().getTargetName())&&void 0!==a?a:"default";this.declareDepends(`${o}@${Task.DO_NATIVE_STRIP.name}`,i)}}async buildCommand(e,t,a,i,s){var o;const r=t.getPathInfo(),n=path_1.default.resolve(r.getNinjaWorkDir(),e),l=new native_command_builder_js_1.NativeCommandBuilder(this.sdkInfo.getNativeNinjaTool()).changeToDir(n),u=new command_builder_modifier_js_1.CommandBuilderModifier(l,command_builder_modifier_js_1.CommandBuilderType.NINJA).wrapCommandBuilder().build();(null===(o=this._nativeOption)||void 0===o?void 0:o.targets)&&this._nativeOption.targets.length>0&&u.push(...this._nativeOption.targets),this._log._printDebugCommand("Ninja",u),s.stop(),s.setLog(s.getName(),hvigor_1.MetricLogType.INFO);const _=`submit CMake task to work pool with ABI of ${e}`,d=this.durationEvent.createSubEvent(_,"");d.start(),await this.executeCommand(u,n,a,i,d),d.stop(),d.setLog(_,hvigor_1.MetricLogType.INFO)}taskShouldDo(){const e=cmake_util_js_1.CmakeUtil.nativeTaskCondition(this.moduleModel,this.targetData,this._nativeOption);return e||fs_extra_1.default.emptyDirSync(this.pathInfo.getIntermediatesCppOutPut()),e}async doTaskAction(){var e;const t=this.targetData.getPathInfo(),a=path_1.default.resolve(t.getIntermediatesCppOutPut()),i=cmake_util_js_1.CmakeUtil.checkAbiFilters(null===(e=this._nativeOption)||void 0===e?void 0:e.abiFilters,this.targetData.isHarmonyOS(),this.moduleModel,this.targetName);await this.cleanUnwanted(i);for(const e of i){const i=`generate Ninja command with ABI of ${e}`,s=this.durationEvent.createSubEvent(i,"");s.start();const o=path_1.default.resolve(a,e),r=path_1.default.resolve(t.getNinjaWorkDir(),e);await this.buildCommand(e,this.targetData,async()=>{const t=cmake_util_js_1.CmakeUtil.parseLibraries(r,this.targetName,e);await this.syncOutput(t,o,r)},[],s),await this.syncStl(e,o,r,t)}}async cleanUnwanted(e){if(!fs_extra_1.default.existsSync(this.pathInfo.getIntermediatesCppOutPut()))return;const t=await promises_1.default.readdir(this.pathInfo.getIntermediatesCppOutPut(),{withFileTypes:!0});for(const a of t)a.isDirectory()&&!e.includes(a.name)&&fs_extra_1.default.rmdirSync(path_1.default.resolve(this.pathInfo.getIntermediatesCppOutPut(),a.name),{recursive:!0})}async syncOutput(e,t,a){var i;const s=new Map,o=null===(i=this._nativeOption)||void 0===i?void 0:i.targets;for(const[i,r]of e.entries())o&&o.length>0&&-1===o.indexOf(i)?this._log.debug(`Case targets are configured, dependency ${i} are not synchronized.`):await this.syncLibOutputs(r,t,a,s)}async syncLibOutputs(e,t,a,i){const s=e.getNameOnDisk();if(!s)return;const o=path_1.default.resolve(t,s),r=e.getOutputs().map(e=>path_1.default.isAbsolute(e)?path_1.default.resolve(e):path_1.default.resolve(a,e)).filter(e=>fs_extra_1.default.existsSync(e)&&!hvigor_1.PathUtil.checkCopyPathIsSame(e,o));for(const e of r)this._log.debug(`External build set its own library output location for ${s}, which will be hard linked or copy to the expected location.`),await file_util_js_1.FileUtil.linkFile(e,o,!0);await this.syncLibDeps(e,t,a,i)}async syncLibDeps(e,t,a,i){var s;const o=path_1.default.normalize(this.sdkInfo.getSdkNativeDir()),r=this.targetData.isHarmonyOS()?path_1.default.normalize(this.sdkInfo.getHmsNativeDir()):void 0,n=null!==(s=(0,collect_duplicate_har_dependencies_js_1.getHspNeedDeduplicateHarInfoMap)(this.moduleName))&&void 0!==s?s:{},l=Object.keys(n),u=this.targetService.shouldDoDeduplicateTask();for(let s of e.getRuntimeFiles()){s=path_1.default.isAbsolute(s)?path_1.default.resolve(s):path_1.default.resolve(a,s),s=path_1.default.normalize(s);const e=l.find(e=>s.startsWith(e));if(u&&this.moduleModel.isHspModule()&&e){this._log.debug(`Deduplicate ${s} from har in module ${this.moduleName}.`);continue}this._log.debug(`Sync native runtime file ${s}.`);const n=path_1.default.resolve(t,path_1.default.basename(s));!fs_extra_1.default.existsSync(s)||hvigor_1.PathUtil.checkCopyPathIsSame(s,n)||this.excludeFromHsp(s)?await this.removeHarOutPutSo(s,n):this.isExcludeFromHar(s)?this._log.debug(`Exclude from har: ${s}`):i.get(s)&&i.get(s)===n||(r&&s.startsWith(r)||s.startsWith(o)?i.set(s,n):(i.set(s,n),await file_util_js_1.FileUtil.linkFile(s,n)))}}isExcludeFromHar(e){const{excludeFromHar:t=!0}=this.targetService.getNativeLibOption();return this.moduleModel.isHarModule()&&t&&this.excludeFromHar(e)}async removeHarOutPutSo(e,t){fs_extra_1.default.existsSync(e)&&fs_extra_1.default.existsSync(t)&&this.isExcludeFromHar(e)&&(fs_extra_1.default.rmSync(t),this._log.debug(`Remove the so cache file: ${t}`))}async syncStl(e,t,a,i){const s=cmake_util_js_1.CmakeUtil.parseStlFromCMakeCache(a);this._log.debug(`OHOS_STL is ${s.value}`);const o="c++_static"===s.value||"none"===s.value,r=path_1.default.resolve(t,"libc++.so"),n=path_1.default.resolve(t,common_const_js_1.NativeConst.SHARED_STL_LIBRARY),l=path_1.default.resolve(i.getModuleBuildIntermediates(),"libs",e);if(o)return this._log.debug(`${this.moduleName} remove files start`),fs_extra_1.default.removeSync(r),fs_extra_1.default.removeSync(n),fs_extra_1.default.removeSync(l),void this._log.debug(`${this.moduleName} remove files end`);this._log.debug(`Copy STL ${common_const_js_1.NativeConst.SHARED_STL_LIBRARY} to ${t} due to OHOS_STL is 'c++_shared'`);const u=path_1.default.resolve(this.sdkInfo.getSdkNativeDir(),"llvm","lib",cpu_abi_enum_js_1.CpuAbiEnum.getCpuType(e),"c++"),_=path_1.default.resolve(u,common_const_js_1.NativeConst.SHARED_STL_LIBRARY);if(!fs_extra_1.default.existsSync(_))return void this._log.warn(`Missing stl library ${_};`);const d=fs_extra_1.default.statSync(_);if(fs_extra_1.default.existsSync(n)){const e=fs_extra_1.default.statSync(n);if(d.size===e.size&&d.mtimeMs===e.mtimeMs)return}await fs_extra_1.default.copy(_,n,{overwrite:!0,recursive:!0,preserveTimestamps:!0})}excludeFromHsp(e){return!!this.service.getDependencyInfo().getHspDependencies().map(e=>e.getDependencyRootPath()).find(t=>path_1.default.normalize(e).startsWith(path_1.default.normalize(t)))}excludeFromHar(e){return e=path_1.default.normalize(fs_extra_1.default.realpathSync(e)),!!this.service.getHarDependencies().find(t=>{const a=path_1.default.normalize(t.getDependencyRootPath()),i=path_1.default.relative(a,e);return!i.startsWith("..")&&!path_1.default.isAbsolute(i)})}}exports.BuildNativeWithNinja=BuildNativeWithNinja;