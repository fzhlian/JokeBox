"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mergeTwoArray=exports.deduplicateArray=exports.deduplicateDynamicImportLibInfoObj=exports.deduplicateDeclarationEntry=exports.deduplicateOtherCompileFiles=exports.deduplicateCompileEntry=exports.deduplicateWorkers=exports.processByteCodeHarDeclarationEntry=exports.mergeWorkers=exports.mergeDynamicImportLibInfo=exports.mergeCompileEntry=exports.mergeDeclarationEntry=exports.getFilteredDuplicateHarInfo=void 0;const hvigor_1=require("@ohos/hvigor"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),ohmurl_utils_js_1=require("../../utils/ohmurl-utils.js"),log=ohos_logger_js_1.OhosLogger.getLogger("DeduplicateUtil");function getFilteredDuplicateHarInfo(e){const r=new Set,t=new Set,o=new Set;return Object.values(e).forEach(e=>{e.isByteCodeHarDependency?r.add(e.packageName):(t.add(e.dependencyRootPath),e.isSODependency||o.add(e.dependencyRootPath))}),{byteCodeHarPkgNameSet:r,sourceHarPkgPathSet:t,sourceHarWithoutSoPkgPathSet:o}}function mergeDeclarationEntry(e,r){mergeArray(e,r,e=>{log.debug(`Deduplicate declarationEntry add ${e}`)})}function mergeCompileEntry(e,r){mergeArray(e,r,e=>{log.debug(`Deduplicate compileEntry add ${e}`)})}function mergeDynamicImportLibInfo(e,r){mergeObject(e,r,e=>{log.debug(`Deduplicate dynamicImportLibInfo add ${e}`)})}function mergeWorkers(e,r){mergeArray(e,r,e=>{log.debug(`Deduplicate workers add ${e}`)})}function processByteCodeHarDeclarationEntry(e,r,t,o,a){r.forEach(r=>{if(!r.toLowerCase().startsWith(e.toLowerCase()))return;if(o.has(r.toLowerCase()))return;o.add(r.toLowerCase());const i=genByteCodeHarImportOhmUrl(r,t);i&&a.add(i)})}function genByteCodeHarImportOhmUrl(e,r){const t=e.toLowerCase(),o=r.packageName.toLowerCase();let a;if(t===o||new RegExp(`^${o}(/*|\\\\*)$`).test(t))a=(0,ohmurl_utils_js_1.generateOhmUrl)(r);else if(t.startsWith(`${o}/`)){const t=e.substring(`${o}/`.length).replace(/\\/g,"/");a=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(r,t)}else if(t.startsWith(`${o}\\`)){const t=e.substring(`${o}\\`.length).replace(/\\/g,"/");a=(0,ohmurl_utils_js_1.generateOhmUrlForSourceFile)(r,t)}return a}function deduplicateWorkers(e,r){return deduplicateArrayStartWith(e,r,e=>{log.debug(`Deduplicate workers ${e}`)})}function deduplicateCompileEntry(e,r){return deduplicateArrayStartWith(e,r,e=>{log.debug(`Deduplicate compileEntry ${e}`)})}function deduplicateOtherCompileFiles(e,r){return deduplicateArrayStartWith(e,r,e=>{log.debug(`Deduplicate otherCompileFiles ${e}`)})}function deduplicateDeclarationEntry(e,r){const t=[];for(let o=r.length-1;o>=0;o--){const a=r[o];(0,ohmurl_utils_js_1.transformOhmUrlToPkgName)(a)===e&&(t.push(a),r.splice(o,1),log.debug(`Deduplicate declarationEntry ${e} ${a}`))}return t}function deduplicateDynamicImportLibInfoObj(e,r){const t={};return Object.keys(e).forEach(o=>{const a=e[o];r.has(a.pkgPath)&&(t[o]=a,delete e[o],log.debug(`Deduplicate dynamicImportLibInfo ${o} : ${a}`))}),t}function deduplicateArray(e,r){const t=[];for(let o=e.length-1;o>=0;o--){const a=e[o];r(a)&&(t.push(a),e.splice(o,1))}return t}function mergeTwoArray(e,r,t,o=hvigor_1.noop){e.forEach(e=>{r.find(r=>t(e,r))||(r.push(e),o(e))})}function mergeArray(e,r,t){e.forEach(e=>{r.includes(e)||(r.push(e),t(e))})}function mergeObject(e,r,t){Object.keys(e).forEach(o=>{r[o]||(r[o]=e[o],t({[o]:e[o]}))})}function deduplicateArrayStartWith(e,r,t){const o=[];for(let a=e.length-1;a>=0;a--){const i=e[a];for(const n of r)if(i.startsWith(n)){o.push(i),e.splice(a,1),t(i);break}}return o}exports.getFilteredDuplicateHarInfo=getFilteredDuplicateHarInfo,exports.mergeDeclarationEntry=mergeDeclarationEntry,exports.mergeCompileEntry=mergeCompileEntry,exports.mergeDynamicImportLibInfo=mergeDynamicImportLibInfo,exports.mergeWorkers=mergeWorkers,exports.processByteCodeHarDeclarationEntry=processByteCodeHarDeclarationEntry,exports.deduplicateWorkers=deduplicateWorkers,exports.deduplicateCompileEntry=deduplicateCompileEntry,exports.deduplicateOtherCompileFiles=deduplicateOtherCompileFiles,exports.deduplicateDeclarationEntry=deduplicateDeclarationEntry,exports.deduplicateDynamicImportLibInfoObj=deduplicateDynamicImportLibInfoObj,exports.deduplicateArray=deduplicateArray,exports.mergeTwoArray=mergeTwoArray;