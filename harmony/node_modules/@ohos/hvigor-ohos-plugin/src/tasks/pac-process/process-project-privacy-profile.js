"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessProjectPrivacyProfile=void 0;const ohos_app_task_js_1=require("../task/ohos-app-task.js"),hvigor_1=require("@ohos/hvigor"),path_1=__importDefault(require("path")),task_names_js_1=require("../common/task-names.js");var Task=task_names_js_1.TaskNames.Task;const pac_util_js_1=require("./pac-util.js"),common_const_js_1=require("../../const/common-const.js"),fs_extra_1=__importDefault(require("fs-extra")),make_project_pack_info_js_1=require("../make-project-pack-info.js"),ohos_plugin_id_js_1=require("../../plugin/common/ohos-plugin-id.js"),abstract_hap_module_plugin_js_1=require("../../plugin/common/abstract-hap-module-plugin.js"),hsp_plugin_js_1=require("../../plugin/hsp-plugin.js"),json_util_js_1=require("../../utils/json-util.js"),merge_pac_files_js_1=require("./merge-pac-files.js"),trace_pac_js_1=require("./trace-pac.js");class ProcessProjectPrivacyProfile extends ohos_app_task_js_1.OhosAppTask{constructor(e,s){super(e,s,Task.PROCESS_PROJECT_PRIVACY_PROFILE),this.outputPath=path_1.default.resolve(this.service.getPathInfo().getProjectOutputPath(),common_const_js_1.CommonConst.PAC_ONLY_JSON),this.appPacJson=path_1.default.resolve(this.service.getProjectModel().getProjectDir(),common_const_js_1.CommonConst.APP_SCOPE,common_const_js_1.CommonConst.PAC_JSON)}declareInputs(){var e,s,t;const o=super.declareInputs();this.project.getAllSubModules().forEach(e=>{var s,t,n;const i=json_util_js_1.JsonUtil.getJson5Obj(path_1.default.resolve(e.getNodeDir(),common_const_js_1.CommonConst.OH_PACKAGE_JSON5));o.set(`${e.getName()}dependencies`,null!==(s=JSON.stringify(null==i?void 0:i.dependencies))&&void 0!==s?s:""),o.set(`${e.getName()}devDependencies`,null!==(t=JSON.stringify(null==i?void 0:i.devDependencies))&&void 0!==t?t:""),o.set(`${e.getName()}dynamicDependencies`,null!==(n=JSON.stringify(null==i?void 0:i.dynamicDependencies))&&void 0!==n?n:"")});const n=json_util_js_1.JsonUtil.getJson5Obj(path_1.default.resolve(this.project.getNodeDir(),common_const_js_1.CommonConst.OH_PACKAGE_JSON5));return o.set("dependencies",null!==(e=JSON.stringify(null==n?void 0:n.dependencies))&&void 0!==e?e:""),o.set("devDependencies",null!==(s=JSON.stringify(null==n?void 0:n.devDependencies))&&void 0!==s?s:""),o.set("dynamicDependencies",null!==(t=JSON.stringify(null==n?void 0:n.dynamicDependencies))&&void 0!==t?t:""),o}declareInputFiles(){const e=super.declareInputFiles();return fs_extra_1.default.existsSync(this.appPacJson)&&e.addEntry(this.appPacJson),this.project.getAllSubModules().forEach(s=>{const t=path_1.default.resolve(s.getNodeDir(),common_const_js_1.CommonConst.PAC_JSON);!s.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HAP_PLUGIN)&&fs_extra_1.default.existsSync(t)&&fs_extra_1.default.existsSync(t)&&e.addEntry(t)}),e}declareOutputFiles(){const e=new hvigor_1.FileSet;return e.addEntry(this.outputPath),e}initTaskDepends(){this.dependsOn(make_project_pack_info_js_1.MakeProjectPackInfo.name)}doTaskAction(){if(!fs_extra_1.default.existsSync(this.service.getSdkInfo().getPacSchema()))return;const e=[],s=[];this.service.getAllOtherDependencies().forEach(e=>{s.push(e.getPackageJsonObj())}),this.processValidPacFiles(this.appPacJson,e),this.service.getAllModuleOrProjectDependencies().forEach(s=>{const t=path_1.default.resolve(s.getDependencyRootPath(),common_const_js_1.CommonConst.PAC_JSON);this.processValidPacFiles(t,e)}),this.project.getAllSubModules().forEach(t=>{var o;const n=null!==(o=t.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HAP_PLUGIN))&&void 0!==o?o:t.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HSP_PLUGIN);if(void 0!==n&&(n instanceof abstract_hap_module_plugin_js_1.AbstractHapModulePlugin||n instanceof hsp_plugin_js_1.HspPlugin)&&n.getTaskService()){const o=n.getTaskService();if(!t.getPluginById(ohos_plugin_id_js_1.OhosPluginId.OHOS_HAP_PLUGIN)){const s=path_1.default.resolve(t.getNodeDir(),common_const_js_1.CommonConst.PAC_JSON);this.processValidPacFiles(s,e)}o.getAllModuleOrProjectDependencies().forEach(s=>{const t=path_1.default.resolve(s.getDependencyRootPath(),common_const_js_1.CommonConst.PAC_JSON);this.processValidPacFiles(t,e)}),o.getAllOtherDependencies().forEach(e=>{s.push(e.getPackageJsonObj())})}});const t=e.map(e=>(0,pac_util_js_1.checkPacJsonExistAndGetObj)(e)).filter(e=>void 0!==e),o=(0,merge_pac_files_js_1.mergePacFiles)(t);(0,pac_util_js_1.mergeDependencies)(s,o),fs_extra_1.default.outputJSONSync(this.outputPath,o),(0,trace_pac_js_1.tracePac)(this.project.getName())}processValidPacFiles(e,s){(0,pac_util_js_1.pacFileValidate)(this.project.getName(),e,this.service.getSdkInfo().getPacSchema())&&s.push(e)}}exports.ProcessProjectPrivacyProfile=ProcessProjectPrivacyProfile;