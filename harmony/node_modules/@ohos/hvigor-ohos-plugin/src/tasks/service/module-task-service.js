"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,r,o){void 0===o&&(o=r);var s=Object.getOwnPropertyDescriptor(e,r);s&&!("get"in s?!e.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,o,s)}:function(t,e,r,o){void 0===o&&(o=r),t[o]=e[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)"default"!==r&&Object.prototype.hasOwnProperty.call(t,r)&&__createBinding(e,t,r);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkHasTargetApplyProduct=exports.ModuleTaskService=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),util=__importStar(require("util")),hvigor_1=require("@ohos/hvigor"),task_util_js_1=require("@ohos/hvigor/src/base/util/task-util.js"),find_target_product_js_1=require("../../common/find-target-product.js"),hvigor_extra_config_info_js_1=require("../../common/hvigor-extra-config-info.js"),module_path_info_iml_js_1=require("../../common/iml/module-path-info-iml.js"),common_const_js_1=require("../../const/common-const.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),module_target_impl_js_1=require("../../plugin/context/impl/module-target-impl.js"),inject_util_js_1=require("../../utils/inject-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),target_utils_js_1=require("../../utils/target-utils.js"),hap_task_target_data_js_1=require("../data/hap-task-target-data.js"),status_js_1=require("./status.js"),task_service_js_1=require("./task-service.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("Hvigor-module-service");class ModuleTaskService extends task_service_js_1.TaskService{constructor(t,e,r,o){super(e.getModule(),t,r,o),this._moduleModel=e,this._targetDataSet=new Set,this._targets=[],this._targetArtifactNames=new Map,this._status=new status_js_1.FullStatus(this.initTargetData())}getModuleModel(){return this._moduleModel}getTargetDataSet(){return this._targetDataSet}getTargets(){return this._targets}getTargetArtifactNames(){return this._targetArtifactNames}isArkModule(){return this._moduleModel.isArkModule()}getRelatedEntryModules(){var t;return null!==(t=this._moduleModel.getRelatedEntryModules())&&void 0!==t?t:void 0}static checkEntryModules(t,e){return t===module_type_enum_js_1.ModuleType.Feature&&void 0!==e&&0!==e.length}hasLiteDevice(){var t;return null===(t=this._moduleModel.getDeviceTypes())||void 0===t?void 0:t.some(t=>"liteWearable"===t||"smartVision"===t)}initTargetData(){const t=this._moduleModel.getTargetOptions(),e=target_utils_js_1.TargetUtils.computeTargets(this._projectModel.getModuleSpecificTargets().get(this._moduleModel.getName()),t),r=(0,hvigor_extra_config_info_js_1.getBuildRoot)(),o=this._moduleModel.getProjectDir();path_1.default.normalize(path_1.default.relative(o,path_1.default.resolve(o,r))).startsWith("..")&&_log.printErrorExit("INVALID_BUILDROOT_VALUE",[r]);const s=(0,find_target_product_js_1.findTargetProduct)(this._projectModel),a=[new status_js_1.Status(this._moduleModel.getProfileOpt())];return t.forEach(t=>{var o,i;const _=t.name,u=this.targetNeedPack(s,_,e),l=new module_path_info_iml_js_1.ModulePathInfoIml(this._moduleModel,_,s.name,r),n=new hap_task_target_data_js_1.ModuleTargetData(this._moduleModel,t,l,s);u&&(this._targets.push(new module_target_impl_js_1.ModuleTargetImpl(t,l,this._projectModel,this._moduleModel)),(null===(o=t.output)||void 0===o?void 0:o.artifactName)&&this._targetArtifactNames.set(_,null===(i=t.output)||void 0===i?void 0:i.artifactName)),this._targetDataSet.add([n,u]),a.push(n.getTargetStatus())}),a}findTargetDataByName(t){for(const e of this._targetDataSet.values()){const r=e[0];if(r.getTargetName()===t)return r}}targetNeedPack(t,e,r){let o=!1;return r.indexOf(e)>-1&&(o=!0),r.indexOf("all")>-1&&(o=e!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET),inject_util_js_1.InjectUtil.isDeviceTest()&&(o=e===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET||e===common_const_js_1.DefaultTargetConst.DEFAULT_TARGET),inject_util_js_1.InjectUtil.isSync()&&!hasCommandEntryTask()&&this.hasCppInOhosTest()&&(o=e===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET||o),checkHasTargetApplyProduct(this._moduleModel,e,t.name)&&o}hasCppInOhosTest(){return fs_1.default.existsSync(path_1.default.resolve(this._moduleModel.getSourceRootByTargetName(common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET),code_type_enum_js_1.CodeType.CPP))}}function hasCommandEntryTask(){const t=hvigor_1.hvigor.getCommandEntryTaskInternal();return void 0!==t&&t.length>0}function getProducts(t,e,r,o){if(r===common_const_js_1.CommonConst.OHOS_TEST)return[o];const s=null==t?void 0:t.getTargetApplyProducts(e.getName(),r);return null!=s?s:["default"]}function checkHasTargetApplyProduct(t,e,r){if(t.isHarModule()||(0,task_util_js_1.getAlignTarget)())return!0;const o=t.getParentProject(),s=getProducts(o,t,e,r),a=o.getProductNames();return s.some(t=>!a.includes(t))&&_log.printErrorExit("INVALID_PRODUCT_FOR_TARGET",[e,o.getProfilePath()],[[e,util.format(s)]]),s.includes(r)}exports.ModuleTaskService=ModuleTaskService,exports.checkHasTargetApplyProduct=checkHasTargetApplyProduct;