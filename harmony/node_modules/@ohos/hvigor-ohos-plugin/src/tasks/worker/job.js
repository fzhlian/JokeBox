"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.runArkLint=exports.run=void 0;const startTime=Number(process.hrtime.bigint()),crypto_1=__importDefault(require("crypto")),fs_1=__importDefault(require("fs")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),hvigor_arkts_compose_1=require("@ohos/hvigor-arkts-compose"),log4js_1=require("log4js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),generate_pkg_context_info_js_1=require("../generate-pkg-context-info.js"),util_js_1=require("./util.js"),endTime=Number(process.hrtime.bigint()),log=ohos_logger_js_1.OhosLogger.getLogger("Ark");let level=log4js_1.levels.DEBUG,hasLoadDependencies=!1;const run=async(e,o)=>((0,util_js_1.generateLoaderEnv)(e),level=log4js_1.levels.getLevel(e.level,log4js_1.levels.INFO),log.setLevel(level),e.pkgContextInfo&&(e.pkgContextInfo=new Proxy(e.pkgContextInfo,{get(e,o){if("string"==typeof o)return generate_pkg_context_info_js_1.soLibsPattern.test(o)&&!e[o]?(0,generate_pkg_context_info_js_1.getSoDefaultContextInfo)(o):e[o]}})),new Promise(t=>{(0,hvigor_arkts_compose_1.runArkPack)(e,log,void 0,void 0,o).then(o=>{o.isSuccess?((0,ohos_logger_js_1.handleLogs)(o.compileLogEvents,log,level),!e.isMainThread&&!hasLoadDependencies&&o.compileEvents.push(getLoadDependencyEvent()),t(o.compileEvents)):t(o.error)}).catch(o=>{var t;const r=path_1.default.resolve(null!==(t=e.cachePath)&&void 0!==t?t:"",hvigor_arkts_compose_1.MSGPACK_COMPILE_CACHE_DIR_NAME);throw fs_1.default.rmSync(r,{recursive:!0,force:!0}),o}).finally(()=>{log.debug(`Ark compile task finished.finished time is ${process.hrtime.bigint()}`)})}));exports.run=run;const runArkLint=async e=>{(0,util_js_1.generateLoaderEnv)(e.config);const o=await(0,hvigor_arkts_compose_1.runEtsStandaloneChecker)(e);level=log4js_1.levels.getLevel(e.config.level,log4js_1.levels.INFO),(0,ohos_logger_js_1.handleLogs)(o,log,level);const t=o.filter(e=>"error"===e.level);if(t.length>0){const e=t.map(e=>e.msg).join(os_1.default.EOL);log._buildError(`ArkTS lint errors.${os_1.default.EOL}${e}`)._printErrorAndExit(),log.printErrorExit("ARKTS_LINT_ERRORS",[e])}};function getLoadDependencyEvent(){return hasLoadDependencies=!0,new hvigor_arkts_compose_1.CompileEvent(crypto_1.default.randomUUID(),"load compilation dependencies",process.pid,hvigor_1.MAIN_THREAD,0,0).setStartTime(startTime).setEndTime(endTime).setState("success")}exports.runArkLint=runArkLint;