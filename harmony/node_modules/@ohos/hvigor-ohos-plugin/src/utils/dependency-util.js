"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getLocalDependencyBuildOptions=exports.getLocalDependencyShareConfig=exports.getLocalDependencyRouterMap=exports.getRemoteDepHarTargetSources=exports.getLocalDepHarTargetSources=exports.getDependenciesWithoutHar=exports.minimizeHspDependencies=exports.getJson5Obj=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),common_const_js_1=require("../const/common-const.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),dependency_manager_js_1=require("../project/dependency/dependency-manager.js"),file_util_js_1=require("./file-util.js"),har_target_util_js_1=require("./har-target-util.js"),parameter_utils_js_1=require("./parameter-utils.js"),build_mode_manager_js_1=require("../project/build-option/build-mode-manager.js"),json5Map=hvigor_1.hvigorCore.getCache("JSON_CACHE");function getJson5Obj(e,t=!1){var n;const o=fs_1.default.statSync(e).mtime.getTime();(null===(n=json5Map.get(e))||void 0===n?void 0:n.timeStamp)!==o&&json5Map.set(e,{timeStamp:o,fileContent:hvigor_1.Json5Reader.getJson5Obj(e)});const r=json5Map.get(e).fileContent;return t?(0,wdk_1.cloneDeep)(r):r}function minimizeHspDependencies(e,t,n){(0,parameter_utils_js_1.getPropertyKeepDependency)()||(e.dependencies=getDependenciesWithoutHar(dependency_interface_js_1.DependencyEnum.DEPENDENCIES,t,n),e.dynamicDependencies=getDependenciesWithoutHar(dependency_interface_js_1.DependencyEnum.DYNAMIC_DEPENDENCIES,t,n),e.devDependencies&&delete e.devDependencies)}function getDependenciesWithoutHar(e,t,n){const o={},r=t.getHspDependencies().filter(t=>t.getDependencyEnum()===e);if(0===r.length)return{};const a={parameterFilePath:t.getProjectModel().getParameterFileAbsolutePath(),ohPackageFilePath:n};return r.forEach(e=>{const n=e.getDependencyName();o[n]=file_util_js_1.FileUtil.extracted(e.getDependedVersion(),t.getModuleModel().getParentProject().getParameterFileObj(),a)}),o}function getLocalDepHarTargetSources(e,t,n){var o;const r=[],a=har_target_util_js_1.HarTargetUtil.calDepHarTargets(e),s=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(t,n),i=null==s?void 0:s.getModule().getNodeDir(),c=null==s?void 0:s.getModule().getName(),d=c?a.get(c):"default",l=null==s?void 0:s.getTargetOptions().filter(e=>e.name===d),p=l?null===(o=l[0].resource)||void 0===o?void 0:o.directories:void 0;if((null==p?void 0:p.length)&&i&&p.forEach(e=>{const t=path_1.default.resolve(i,e);fs_1.default.existsSync(t)&&(null==r||r.push(t))}),!(null==p?void 0:p.length)&&i){const e=path_1.default.resolve(i,common_const_js_1.CommonConst.SRC_MAIN_RESOURCES);fs_1.default.existsSync(e)&&(null==r||r.push(e))}return r}function getRemoteDepHarTargetSources(e){var t,n;const o=[],r=e.getDependencyRootPath(),a=null===(n=null===(t=getJson5Obj(path_1.default.resolve(r,common_const_js_1.CommonConst.OH_PACKAGE_JSON5)).metadata)||void 0===t?void 0:t.resource)||void 0===n?void 0:n.directories;(null==a?void 0:a.length)&&a.forEach(e=>{const t=path_1.default.resolve(r,e);fs_1.default.existsSync(t)&&(null==o||o.push(t))});const s=path_1.default.resolve(r,common_const_js_1.CommonConst.SRC_MAIN_RESOURCES);return!o.includes(s)&&fs_1.default.existsSync(s)&&(null==o||o.push(s)),o}function getLocalDependencyRouterMap(e,t,n){const o=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(n,e),r=har_target_util_js_1.HarTargetUtil.calDepHarTargets(t),a=o&&r.get(o.getName());return dependency_manager_js_1.DependencyManager.getLocalDependencyRouterMapObjList(n,e,a)}function getLocalDependencyShareConfig(e,t,n){const o=dependency_manager_js_1.DependencyManager.getModuleModelByDependency(n,e),r=har_target_util_js_1.HarTargetUtil.calDepHarTargets(t),a=o&&r.get(o.getName());return dependency_manager_js_1.DependencyManager.getLocalDependencyShareConfigObjList(n,e,a)}function getLocalDependencyBuildOptions(e,t){var n,o,r;const a=null!==(o=null===(n=e.getModuleJsonObj())||void 0===n?void 0:n.module.name)&&void 0!==o?o:e.getPackageName(),s=null!==(r=t.get(a))&&void 0!==r?r:"default";return build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(a,s)}exports.getJson5Obj=getJson5Obj,exports.minimizeHspDependencies=minimizeHspDependencies,exports.getDependenciesWithoutHar=getDependenciesWithoutHar,exports.getLocalDepHarTargetSources=getLocalDepHarTargetSources,exports.getRemoteDepHarTargetSources=getRemoteDepHarTargetSources,exports.getLocalDependencyRouterMap=getLocalDependencyRouterMap,exports.getLocalDependencyShareConfig=getLocalDependencyShareConfig,exports.getLocalDependencyBuildOptions=getLocalDependencyBuildOptions;