"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LibsFileCacheUtil=void 0;const path_1=__importDefault(require("path")),hvigor_common_1=require("@ohos/hvigor-common"),fs_extra_1=__importDefault(require("fs-extra")),so_strip_util_js_1=require("./so-strip-util.js");class LibsFileCacheUtil{static getFileHash(t){return(0,hvigor_common_1.hash)(String(t.size+t.mtime.getTime()))}static async isSourceChanged(t,e,i,s,a){const r=path_1.default.relative(s,e),l=this.isStripped(t,i.debugSymbol,r,s);if(this.isStripped(t,a,r,s)!==l)return!0;const o=i.libs[e];return void 0===o||!fs_extra_1.default.existsSync(e)||o!==LibsFileCacheUtil.getFileHash(fs_extra_1.default.statSync(e))}static isStripped(t,e,i,s){var a;return(null===(a=null==e?void 0:e.strip)||void 0===a||a?so_strip_util_js_1.SoStripUtil.filesExcluding:so_strip_util_js_1.SoStripUtil.matchedFiles)(t.collectAllLibs,null==e?void 0:e.exclude,s).some(t=>path_1.default.normalize(t)===path_1.default.normalize(i))}static async isSinkChanged(t,e){const i=e.stripped[t];return void 0===i||!fs_extra_1.default.existsSync(t)||i!==LibsFileCacheUtil.getFileHash(fs_extra_1.default.statSync(t))}static async generateFileHashesForDirectory(t){if(!t||!path_1.default.isAbsolute(t))throw new Error(`Invalid ${t} path. It must be a non-empty absolute path.`);const e={};if(!fs_extra_1.default.existsSync(t))return e;async function i(t,i){try{const a=path_1.default.join(t,i),r=fs_extra_1.default.statSync(a);r.isDirectory()?await s(a):r.isFile()&&(e[a]=LibsFileCacheUtil.getFileHash(r))}catch(t){if(!(t instanceof Error&&"code"in t&&"ENOENT"===t.code))throw t}}async function s(t){const e=fs_extra_1.default.readdirSync(t);for(const s of e)await i(t,s)}return await s(t),e}static async refreshLibsFileCache(t,e,i,s){const a={libs:fs_extra_1.default.existsSync(t)?await LibsFileCacheUtil.generateFileHashesForDirectory(t):{},stripped:fs_extra_1.default.existsSync(e)?await LibsFileCacheUtil.generateFileHashesForDirectory(e):{},debugSymbol:s};fs_extra_1.default.ensureDirSync(path_1.default.dirname(i)),await fs_extra_1.default.writeFile(i,JSON.stringify(a),"utf8")}}exports.LibsFileCacheUtil=LibsFileCacheUtil;