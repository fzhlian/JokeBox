"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ohPackageLoader=void 0;const path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),class_type_const_js_1=require("@ohos/hvigor/src/base/common/options/class-type-const.js"),node_config_path_info_1=require("@ohos/hvigor/src/common/node-config-path-info"),fs_extra_1=__importDefault(require("fs-extra")),common_const_1=require("../../../const/common-const"),json_util_1=require("../../json-util"),ohos_logger_1=require("../../log/ohos-logger"),config_file_loader_1=require("../config-file-loader");class OhPackageLoader{constructor(){this._log=ohos_logger_1.OhosLogger.getLogger("OhPackageLoader"),this.isUpdatedOhPackageInfo=!1,this.isLoaded=!1,this.isChangedParameterFile=!1,this.OhPackagePathMap=new Map,this.UpdatePathToOriginMap=new Map}getDependenciesOpt(e){var o;return this.saveOhPackagePathInfoToLoader(),null===(o=this.getOhPackageJsonObj(e))||void 0===o?void 0:o.dependencies}clean(){this.isUpdatedOhPackageInfo=!1,this.isLoaded=!1,this.OhPackagePathMap=new Map,this.UpdatePathToOriginMap=new Map,this.isChangedParameterFile=!1}getDevDependenciesOpt(e){var o;return this.saveOhPackagePathInfoToLoader(),null===(o=this.getOhPackageJsonObj(e))||void 0===o?void 0:o.devDependencies}getDynamicDependenciesOpt(e){var o;return this.saveOhPackagePathInfoToLoader(),null===(o=this.getOhPackageJsonObj(e))||void 0===o?void 0:o.dynamicDependencies}getOhPackageJsonObj(e){var o;return config_file_loader_1.configFileLoader.getConfigFileJson(null!==(o=this.UpdatePathToOriginMap.get(e))&&void 0!==o?o:e)}setDependenciesOpt(e,o){this.validateDependency(o),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.dependencies=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdatedOhPackageInfo=!0,hvigor_1.hvigorCore.getCache(common_const_1.CommonConst.DEP_NODE).clear()}setDevDependenciesOpt(e,o){this.validateDependency(o),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.devDependencies=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdatedOhPackageInfo=!0,hvigor_1.hvigorCore.getCache(common_const_1.CommonConst.DEP_NODE).clear()}setDynamicDependenciesOpt(e,o){this.validateDependency(o),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.dynamicDependencies=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdatedOhPackageInfo=!0,hvigor_1.hvigorCore.getCache(common_const_1.CommonConst.DEP_NODE).clear()}getVersion(e){return this.saveOhPackagePathInfoToLoader(),config_file_loader_1.configFileLoader.getConfigFileJson(e).version}setVersion(e,o){"string"!=typeof o&&this._log.printErrorExit("VERSION_IS_NOT_A_STRING",[o]),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.version=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdatedOhPackageInfo=!0}shouldDoOhpmInstall(){return this.isUpdatedOhPackageInfo||this.isChangedParameterFile||node_config_path_info_1.nodeConfigPathInfo.getIsModuleChanged()||"true"===hvigor_1.hvigor.getParameterInternal().getExtParamInternal(common_const_1.CommonConst.ENFORCE_OHPM)}loadUpdatedOhPackageToDisk(e,o){this._log.debug("start to load updatedOhPackageInfo to the disk"),this.saveOhPackagePathInfoToLoader();const t=path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),common_const_1.CommonConst.DEPENDENCYMAP,e),a=path_1.default.resolve(t,`${common_const_1.CommonConst.DEPENDENCYMAP}.json5`);fs_extra_1.default.removeSync(path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),common_const_1.CommonConst.DEPENDENCYMAP)),fs_extra_1.default.mkdirSync(t,{recursive:!0});const n={basePath:a,targetName:e||void 0,rootDependency:`./${common_const_1.CommonConst.OH_PACKAGE_JSON5}`,dependencyMap:{},modules:[]};hvigor_1.hvigor.getAllNodesInternal().forEach(e=>{const i=path_1.default.resolve(e.getNodePathInternal(),common_const_1.CommonConst.OH_PACKAGE_JSON5);if(e.getNodeNameInternal()===hvigor_1.hvigor.getRootNodeInternal().getNodeNameInternal()&&e.classKind===class_type_const_js_1.ClassTypeConst.HVIGOR_PROJECT){const e=config_file_loader_1.configFileLoader.getConfigFileJson(i);return e.parameterFile=o,fs_extra_1.default.writeFileSync(path_1.default.resolve(t,common_const_1.CommonConst.OH_PACKAGE_JSON5),JSON.stringify(e)),this.OhPackagePathMap.set(i,path_1.default.resolve(t,common_const_1.CommonConst.OH_PACKAGE_JSON5)),void this.UpdatePathToOriginMap.set(path_1.default.resolve(t,common_const_1.CommonConst.OH_PACKAGE_JSON5),i)}n.modules.push({name:`${e.getNodeNameInternal()}`,srcPath:`${path_1.default.relative(a,e.getNodePathInternal())}`}),fs_extra_1.default.existsSync(path_1.default.resolve(t,e.getNodeNameInternal()))||fs_extra_1.default.mkdirSync(path_1.default.resolve(t,e.getNodeNameInternal())),fs_extra_1.default.writeFileSync(path_1.default.resolve(t,e.getNodeNameInternal(),common_const_1.CommonConst.OH_PACKAGE_JSON5),JSON.stringify(config_file_loader_1.configFileLoader.getConfigFileJson(i))),this.OhPackagePathMap.set(i,path_1.default.resolve(t,e.getNodeNameInternal(),common_const_1.CommonConst.OH_PACKAGE_JSON5)),this.UpdatePathToOriginMap.set(path_1.default.resolve(t,e.getNodeNameInternal(),common_const_1.CommonConst.OH_PACKAGE_JSON5),i),n.dependencyMap[e.getNodeNameInternal()]=`./${e.getNodeNameInternal()}/${common_const_1.CommonConst.OH_PACKAGE_JSON5}`}),fs_extra_1.default.writeFileSync(a,JSON.stringify(n)),this._log.debug("load to the disk finished")}getNodeOhPackagePath(e){var o;return this.isUpdatedOhPackageInfo&&(null===(o=this.OhPackagePathMap)||void 0===o?void 0:o.get(e))||e}saveOhPackagePathInfoToLoader(){this.isLoaded||(hvigor_1.hvigor.getAllNodesInternal().forEach(e=>{const o=path_1.default.resolve(e.getNodePathInternal(),common_const_1.CommonConst.OH_PACKAGE_JSON5);config_file_loader_1.configFileLoader.setConfigFileJson(o,json_util_1.JsonUtil.getJson5Obj(o))}),this.isLoaded=!0)}validateDependency(e){for(const o in e)"string"!=typeof e[o]&&this._log.printErrorExit("DEPENDENCY_VERSION_IS_NOT_A_STRING",[e[o]])}getOriginPathFromUpdatePath(e){return this.isUpdatedOhPackageInfo?(e.forEach((o,t)=>{o=o.includes(common_const_1.CommonConst.OH_PACKAGE_JSON5)?o:path_1.default.resolve(o,common_const_1.CommonConst.OH_PACKAGE_JSON5);const a=exports.ohPackageLoader.UpdatePathToOriginMap.get(o);e[t]=a?path_1.default.dirname(a):path_1.default.dirname(o)}),e):e=e.map(e=>path_1.default.dirname(e))}setIsChangeParameterFile(e,o){if("string"!=typeof e)return void this._log.printErrorExit("OHOS_ALIGN_TARGET_TYPE_ERROR",[path_1.default.resolve(hvigor_1.hvigor.getRootNodeInternal().getNodePathInternal(),"hvigor","hvigor-config.json5")]);const t=path_1.default.resolve(hvigor_1.PathUtil.getHvigorCacheDir(),common_const_1.CommonConst.DEPENDENCYMAP,e,common_const_1.CommonConst.OH_PACKAGE_JSON5);if(!fs_extra_1.default.existsSync(t)&&o)return;const a=json_util_1.JsonUtil.getJson5Obj(t),n=null==a?void 0:a.parameterFile;this.isChangedParameterFile=n!==o}getOverrides(e){var o;return this.saveOhPackagePathInfoToLoader(),null===(o=this.getOhPackageJsonObj(e))||void 0===o?void 0:o.overrides}setOverrides(e,o){this.validateDependency(o),this.saveOhPackagePathInfoToLoader();const t=config_file_loader_1.configFileLoader.getConfigFileJson(e);t.overrides=o,config_file_loader_1.configFileLoader.setConfigFileJson(e,t),this.isUpdatedOhPackageInfo=!0}}exports.ohPackageLoader=new OhPackageLoader;