"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.projectBuildProfileLoader=void 0;const wdk_1=require("@baize/wdk"),hvigor_1=require("@ohos/hvigor"),class_type_const_js_1=require("@ohos/hvigor/src/base/common/options/class-type-const.js"),common_const_js_1=require("../../../const/common-const.js"),abstract_build_profile_loader_js_1=require("./abstract-build-profile-loader.js");class ProjectBuildProfileLoader extends abstract_build_profile_loader_js_1.AbstractBuildProfileLoader{constructor(){super(...arguments),this.logger=hvigor_1.HvigorLogger.getLogger(ProjectBuildProfileLoader.name)}getBuildProfile(){return this.getBuildProfileJson5Obj(hvigor_1.hvigor.getRootNodeInternal().getNodeNameInternal(),!0,class_type_const_js_1.ClassTypeConst.HVIGOR_PROJECT)}setBuildProfileJson5Obj(e,o,r=!0){super.setBuildProfileJson5ObjCheck(e,o,common_const_js_1.BuildProfileSchemaFileConst.PROJECT_BUILD_PROFILE_SCHEMA_PATH,class_type_const_js_1.ClassTypeConst.HVIGOR_PROJECT)}initializeReplace(e){return this.replaceTargets(e)}replaceTargets(e){const o=(0,wdk_1.cloneDeep)(e);return hvigor_1.hvigor.getRootNodeInternal().subNodesInternal(e=>{var r;if(!o.modules.some(o=>o.name===e.getNodeNameInternal())){const t=null===(r=hvigor_1.hvigorConfig.getNodeDescriptorByNameInternal(e.getNodeNameInternal()))||void 0===r?void 0:r.srcPath;o.modules.push({name:e.getNodeNameInternal(),srcPath:null!=t?t:e.getNodePathInternal()})}const t=e.getExtraOptionInternal("targets");if(!t)return;o.modules.forEach(o=>{o.name===e.getNodeNameInternal()&&(o.targets=t)})}),o.modules=o.modules.filter(e=>hvigor_1.hvigor.getAllNodesInternal().some(o=>o.getNodeNameInternal()===e.name)),o}checkBuildProfile(e,o){if(!e.app.products||!o.app.products||e.app.products.length!==o.app.products.length)return void this.logger.printErrorExit("CAN_NOT_ADD_OR_DELETE_PRODUCTS",["build-profile.json5"]);this.checkMaxFlowDepth(o)&&this.logger.warn("Setting maxFlowDepth in hvigorfile.ts is not supported and may cause side effects.");const r=e.app.products,t=o.app.products;r.forEach(e=>{const o=t.find(o=>o.name===e.name);o?o.runtimeOS!==e.runtimeOS&&this.logger.printErrorExit("CAN_NOT_CHANGE_NAME_OR_RUNTIME_PRODUCTS",[e.runtimeOS]):this.logger.printErrorExit("CAN_NOT_CHANGE_NAME_OR_RUNTIME_PRODUCTS",[e.name])})}checkMaxFlowDepth(e){var o,r,t,i,l,n,s,a;for(const l of(null===(o=null==e?void 0:e.app)||void 0===o?void 0:o.products)||[])if(void 0!==(null===(i=null===(t=null===(r=null==l?void 0:l.buildOption)||void 0===r?void 0:r.arkOptions)||void 0===t?void 0:t.tscConfig)||void 0===i?void 0:i.maxFlowDepth))return!0;for(const o of(null===(l=null==e?void 0:e.app)||void 0===l?void 0:l.buildModeSet)||[])if(void 0!==(null===(a=null===(s=null===(n=null==o?void 0:o.buildOption)||void 0===n?void 0:n.arkOptions)||void 0===s?void 0:s.tscConfig)||void 0===a?void 0:a.maxFlowDepth))return!0;return!1}}exports.projectBuildProfileLoader=new ProjectBuildProfileLoader;