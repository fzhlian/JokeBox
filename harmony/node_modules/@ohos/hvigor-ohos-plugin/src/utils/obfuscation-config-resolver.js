"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.transformRules=exports.resolveObfuscationDependencies=exports.resolveObfuscationOptions=void 0;const fs_1=__importDefault(require("fs")),promises_1=__importDefault(require("fs/promises")),path_1=__importDefault(require("path")),hvigor_1=require("@ohos/hvigor"),build_option_path_info_js_1=require("../common/build-option-path-info.js"),common_const_js_1=require("../const/common-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),build_mode_manager_js_1=require("../project/build-option/build-mode-manager.js"),dependency_interface_js_1=require("../project/dependency/core/dependency-interface.js"),file_util_js_1=require("./file-util.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("obfuscation"),resolveObfuscationOptions=async(e,o,t)=>{var s,n,r;const i=e.getTargetData().getModuleModel(),l=e.getTargetData().getTargetName();if(!o)return;const a=await(0,exports.resolveObfuscationDependencies)(i,e.getModuleService());return o.ruleOptions={enable:null===(s=o.ruleOptions)||void 0===s?void 0:s.enable,rules:(null===(n=o.ruleOptions)||void 0===n?void 0:n.rules)||(0,exports.transformRules)(null===(r=o.ruleOptions)||void 0===r?void 0:r.files,i.getProjectDir(),i,l)},o.consumerRules=o.consumerRules||(0,exports.transformRules)(o.consumerFiles,i.getProjectDir(),i,l),{selfConfig:o,sdkApis:[],obfuscationCacheDir:t,exportRulePath:e.getTargetData().getPathInfo().getObfuscationExportRulePath(),dependencies:a}};exports.resolveObfuscationOptions=resolveObfuscationOptions;const resolveObfuscationDependencies=async(e,o)=>{const t={libraries:[],hspLibraries:[],hars:[],hsps:[]};return await resolveDepObfuscationOptions(e,o,t),t};function handleNoneLocalModule(e,o,t,s){const n=path_1.default.resolve(e,common_const_js_1.CommonConst.OBFUSCATION_TXT),r=o.getAllDependencyType().get(t);fs_1.default.existsSync(n)&&(_log.debug(`Collect obfuscation config from dependency ${t}.`),r===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HAR&&-1===s.hars.indexOf(n)&&s.hars.push(n),r===dependency_interface_js_1.DependencyType.DEPENDENCY_TYPE_HSP&&-1===s.hsps.indexOf(n)&&s.hsps.push(n))}function handleByDepModuleType(e,o,t,s,n){var r,i;if(e){_log.debug(`Collect obfuscation config from library ${o.getName()}.`);const l={ruleOptions:{enable:null===(r=e.ruleOptions)||void 0===r?void 0:r.enable,rules:(0,exports.transformRules)(null===(i=e.ruleOptions)||void 0===i?void 0:i.files,t,o,"default")},consumerRules:(0,exports.transformRules)(e.consumerFiles,t,o,"default"),libDir:t};s===module_type_enum_js_1.ModuleType.Har&&n.libraries.push(l),s===module_type_enum_js_1.ModuleType.Shared&&n.hspLibraries.push(l)}}exports.resolveObfuscationDependencies=resolveObfuscationDependencies;const resolveDepObfuscationOptions=async(e,o,t)=>{var s;const n=e.getParentProject().isOhpmProject(),r=["version","devDependencies","dynamicDependencies","dependencies"],i=n?e.getOhPackageJson5Path():e.getPackageJsonPath();if(!fs_1.default.existsSync(i))return;const l=await hvigor_1.Json5Reader.readJson5File(i);if(n){const o=e.getParentProject().getParameterFileObj(),t={parameterFilePath:e.getParentProject().getParameterFileAbsolutePath(),ohPackageFilePath:i};file_util_js_1.FileUtil.resolveJsonObjWithoutParam(l,o,t,r)}if(!(null==l?void 0:l.name))return;const a=n?common_const_js_1.CommonConst.OH_MODULES:common_const_js_1.CommonNodeConst.NODE_MODULES;for(const n in l.dependencies){if(!Object.prototype.hasOwnProperty.call(null==l?void 0:l.dependencies,n))continue;const r=path_1.default.resolve(e.getProjectDir(),a,...n.split("/"));if(!fs_1.default.existsSync(r)){_log.warn(`Dependency ${n} not found.`);continue}let i;try{i=await promises_1.default.lstat(r)}catch(e){_log.warn(`Dependency ${n} not found or symbolic link is invalid.`);continue}const u=i.isSymbolicLink()?await promises_1.default.realpath(r):r,c=resolveModuleWithPath(u,e.getAllModules());if(!c){handleNoneLocalModule(u,o,n,t);continue}const p=c.getModuleType(),d=null===(s=build_mode_manager_js_1.buildOptionManager.getTargetBuildOption(c.getName(),"default").arkOptions)||void 0===s?void 0:s.obfuscation,_=t.libraries.find(e=>e.libDir===u)||t.hspLibraries.find(e=>e.libDir===u);d&&_||(handleByDepModuleType(d,c,u,p,t),c.isHarModule()&&await resolveDepObfuscationOptions(c,o,t))}},resolveModuleWithPath=(e,o)=>{for(const t of o.values()){if(""===path_1.default.relative(t.getProjectDir(),e))return t}},transformRules=(e,o,t,s)=>{if(!e)return[];const n=[];return"string"==typeof e?(checkObFile(e,o,n,t,s),n):(e.forEach(e=>checkObFile(e,o,n,t,s)),n)};exports.transformRules=transformRules;const checkObFile=(e,o,t,s,n)=>{const r=path_1.default.resolve(o,e),i=build_option_path_info_js_1.buildOptionPath.getTargetBuildOptPath(s,n,"files");fs_1.default.existsSync(r)||_log.printErrorExit("OBFUSCATION_FILE_LOST",[e,r,s.getName(),i],[[e,r]]),t.push(r)};