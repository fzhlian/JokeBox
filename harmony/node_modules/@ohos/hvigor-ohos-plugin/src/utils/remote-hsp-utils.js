"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.initSignRemoteHspMap=exports.getRemoteHspPathMap=exports.getSignRemoteHspMetadata=exports.semverMaxSatisfying=exports.compareIfSetRemoteHsp=exports.getHspBaseData=exports.getRemoteHspObj=exports.getRemoteHspMap=exports.getRemoteHspObjList=void 0;const path_1=__importDefault(require("path")),hvigor_common_1=require("@ohos/hvigor-common"),fs_extra_1=__importDefault(require("fs-extra")),semver_1=require("semver"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),ohos_logger_js_1=require("./log/ohos-logger.js"),sign_util_js_1=require("../tasks/sign/sign-util.js"),oh_package_loader_js_1=require("./loader/file/oh-package-loader.js"),module_task_service_js_1=require("../tasks/service/module-task-service.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("remote-hsp-info"),getRemoteHspObjList=e=>{const t=e.getProject(),s=path_1.default.resolve(e.getNodeDir(),common_const_js_1.CommonConst.OH_MODULES,build_directory_const_js_1.BuildArtifactExtension.DOT_HSP),o=path_1.default.resolve(t.getNodeDir(),common_const_js_1.CommonConst.OH_MODULES,build_directory_const_js_1.BuildArtifactExtension.DOT_HSP),r=(0,exports.getRemoteHspMap)(s),a=(0,exports.getRemoteHspMap)(o,r);return a?[...a.values()]:[]};exports.getRemoteHspObjList=getRemoteHspObjList;const getRemoteHspMap=(e,t)=>{if(!fs_extra_1.default.existsSync(e))return _log.debug("allRemoteHspMap does not exist."),t;t&&_log.debug(`allRemoteHspMap: ${JSON.stringify((0,hvigor_common_1.strMapToObj)(t))}`);const s=null!=t?t:new Map,o=fs_extra_1.default.readdirSync(e);for(const r of o){const o=path_1.default.resolve(e,r),a=(0,exports.getRemoteHspObj)(o,r,_log);a&&checkIfNeedSet(a,_log,t)&&s.set(a.hspFileName,{...a})}return s};exports.getRemoteHspMap=getRemoteHspMap;const checkIfNeedSet=(e,t,s)=>{if(!s)return t.debug(`allRemoteHspMap does not exist, ${e.hspFileName} ${e.hspVersion} should be stored in the allRequiredSignRemoteHspMap`),!0;return s.get(e.hspFileName)?(0,exports.compareIfSetRemoteHsp)(e,s)?(t.debug(`allRemoteHspMap exists, ${e.hspFileName} is in allRemoteHspMap, but ${e.hspFileName} ${e.hspVersion} is higher, ${e.hspFileName} ${e.hspVersion} should be stored in the allRequiredSignRemoteHspMap`),!0):(t.debug(`${e.hspFileName} ${e.hspVersion} should not be stored in the allRequiredSignRemoteHspMap`),!1):(t.debug(`allRemoteHspMap exists, but ${e.hspFileName} is not in allRemoteHspMap, ${e.hspFileName} ${e.hspVersion} should be stored in the allRequiredSignRemoteHspMap`),!0)},getRemoteHspObj=(e,t,s)=>{if(!fs_extra_1.default.existsSync(e))return;const o=fs_extra_1.default.readdirSync(e);let r,a;for(const t of o)if(t.endsWith(build_directory_const_js_1.BuildArtifactExtension.DOT_HSP)&&(r&&s.printErrorExit("ALLOW_ONE_HSP",[e],[[e]]),r=t),t.includes(common_const_js_1.CommonConst.OH_PACKAGE_JSON5)){const t=oh_package_loader_js_1.ohPackageLoader.getNodeOhPackagePath(path_1.default.resolve(e,common_const_js_1.CommonConst.OH_PACKAGE_JSON5));a=(0,exports.getHspBaseData)(t,s)}return a?r?(a.hspFileName=r,a.hspPath=path_1.default.resolve(e,r),a.hspDirName=t,a):void s.printErrorExit("NO_HSP_FOUND",[e],[[e]]):void s.printErrorExit("NO_PACKAGE_FOUND",[r,e],[[e]])};exports.getRemoteHspObj=getRemoteHspObj;const getHspBaseData=(e,t)=>{var s;if(!fs_extra_1.default.existsSync(e))return;const o=fs_extra_1.default.readJsonSync(e);return(0,semver_1.valid)(null==o?void 0:o.version)||t.printErrorExit("VERSION_ILLEGAL",[e]),{hspName:o.name,hspVersion:o.version,hspPath:"",hspDirName:"",hspFileName:"",isIntegratedHsp:!!(null===(s=null==o?void 0:o.metadata)||void 0===s?void 0:s.integratedHsp)}};exports.getHspBaseData=getHspBaseData;const compareIfSetRemoteHsp=(e,t)=>{if(!t.has(e.hspFileName))return!0;const s=t.get(e.hspFileName);if(s){return semverMaxSatisfying([e.hspVersion,s.hspVersion])===e.hspVersion}return!0};function semverMaxSatisfying(e){return(0,semver_1.maxSatisfying)(e,"*")||(0,semver_1.maxSatisfying)(e,"*",{includePrerelease:!0,loose:!0})}function getSignRemoteHspMetadata(e,t){const s=e.getProjectModel(),o=[];if(!(0,sign_util_js_1.isSigned)(s))return;const r=e.getOhpmRemoteHspAllInfo(e,t,!0);return Object.entries(r).forEach(([e,t])=>{var s,r;const a={hspName:t.signedRemoteHspPath?path_1.default.basename(t.signedRemoteHspPath):"",hspVersion:t.version,hspPath:null!==(s=t.signedRemoteHspPath)&&void 0!==s?s:"",soPath:null!==(r=t.soPath)&&void 0!==r?r:""};o.push(a)}),o}function getRemoteHspPathMap(e,t){const s=e.getProjectModel(),o=new Map,r=new Map,a=s.getRemoteHspPath();if(e instanceof module_task_service_js_1.ModuleTaskService){initSignRemoteHspMap(e.getModuleModel().getRemoteHspPath(),r,t)}return initSignRemoteHspMap(a,r,t),r.forEach(e=>{const t=e.hspFileName;o.set(e.hspName,t)}),o}function initSignRemoteHspMap(e,t,s){if(!fs_extra_1.default.existsSync(e))return;const o=fs_extra_1.default.readdirSync(e);for(const r of o){const o=path_1.default.resolve(e,r),a=(0,exports.getRemoteHspObj)(o,r,_log),i=new Set(s.map(e=>e.getPackageName()));a&&(0,exports.compareIfSetRemoteHsp)(a,t)&&i.has(a.hspName)&&t.set(a.hspFileName,{...a})}}exports.compareIfSetRemoteHsp=compareIfSetRemoteHsp,exports.semverMaxSatisfying=semverMaxSatisfying,exports.getSignRemoteHspMetadata=getSignRemoteHspMetadata,exports.getRemoteHspPathMap=getRemoteHspPathMap,exports.initSignRemoteHspMap=initSignRemoteHspMap;