"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolveModuleVersion=exports.resolveJsonObjWithoutAtModule=void 0;const ohos_logger_1=require("../utils/log/ohos-logger"),common_const_1=require("../const/common-const"),hvigor_1=require("@ohos/hvigor"),path_1=__importDefault(require("path")),file_util_1=require("../utils/file-util"),config_file_loader_1=require("../utils/loader/config-file-loader"),dependency_interface_1=require("../project/dependency/core/dependency-interface"),json_util_1=require("../utils/json-util"),log=ohos_logger_1.OhosLogger.getLogger("DependencyModuleVersionValidate");function resolveJsonObjWithoutAtModule(e,o){const t=[dependency_interface_1.DependencyEnum.DEPENDENCIES,dependency_interface_1.DependencyEnum.DYNAMIC_DEPENDENCIES,dependency_interface_1.DependencyEnum.DEV_DEPENDENCIES].map(e=>e.toString());for(const n in e)if(t.includes(n))for(const t in e[n])e[n][t]=resolveModuleVersion(e[n][t],o);log.debug(`jsonObjWithoutAtModule ${JSON.stringify(e)}`)}function resolveModuleVersion(e,o){var t;const n=e.match(common_const_1.ModuleConst.REGEX);if(!n)return e;const r=n[1];let i="";const l=null!==(t=config_file_loader_1.configFileLoader.getConfigFileJson(path_1.default.resolve(o,common_const_1.CommonConst.PROFILE_JSON5)))&&void 0!==t?t:{};if(!l.modules)return e;for(const e of l.modules)r===e.name&&(i=file_util_1.FileUtil.convertToAbsolutePath(e.srcPath,o));if(""!==i){const e=path_1.default.resolve(i,common_const_1.CommonConst.OH_PACKAGE_JSON5),t=config_file_loader_1.configFileLoader.getConfigFileJson(e);if(t)return getParameterVersion(t.version,e,o);{const t=json_util_1.JsonUtil.getJson5Obj(e);return t||log.printErrorExit("MODULE_DEPENDENCY_KEY_ERROR",[r,path_1.default.resolve(o,common_const_1.CommonConst.OH_PACKAGE_JSON5)]),config_file_loader_1.configFileLoader.setConfigFileJson(e,t),getParameterVersion(t.version,e,o)}}return log.printErrorExit("MODULE_DEPENDENCY_KEY_ERROR",[r,path_1.default.resolve(o,common_const_1.CommonConst.OH_PACKAGE_JSON5)]),e}function getParameterVersion(e,o,t){const n=hvigor_1.Json5Reader.getJson5Obj(path_1.default.resolve(t,common_const_1.CommonConst.OH_PACKAGE_JSON5)),r=null==n?void 0:n.parameterFile;if(r){const t={parameterFilePath:r,ohPackageFilePath:o},n=hvigor_1.Json5Reader.getJson5Obj(r);return file_util_1.FileUtil.extracted(e,n,t)}return e}exports.resolveJsonObjWithoutAtModule=resolveJsonObjWithoutAtModule,exports.resolveModuleVersion=resolveModuleVersion;