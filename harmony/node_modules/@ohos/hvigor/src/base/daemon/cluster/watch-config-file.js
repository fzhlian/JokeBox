"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.setRunning=exports.addModuleDependency=exports.addConfigDeps=void 0;const cluster_1=__importDefault(require("cluster")),path_1=__importDefault(require("path")),hvigor_common_1=require("@ohos/hvigor-common"),chokidar_1=require("chokidar"),const_js_1=require("../../../common/const/const.js"),path_const_js_1=require("../../../common/const/path-const.js"),event_id_options_js_1=require("../../internal/lifecycle/event/event-id-options.js"),hvigor_process_js_1=require("../../internal/lifecycle/hvigor-process.js"),hvigor_config_reader_js_1=require("../../util/hvigor-config-reader.js"),hvigor_daemon_log_js_1=require("../log/hvigor-daemon-log.js"),_log=hvigor_daemon_log_js_1.HvigorDaemonLogger.getLogger("daemon");let watcher,isRunning=!1;const hvigorFiles=[];let hvigorConfigWatcher;function disconnectHvigorConfig(){var e,o;const r=process.execArgv,i=r.findIndex(e=>e.startsWith("--max-old-space-size=")),n=(-1!==i?Number(r[i].split("=")[1]):hvigor_config_reader_js_1.defaultOptions.maxOldSpaceSize)!==hvigor_config_reader_js_1.HvigorConfigReader.getMaxOldSpaceSize(!0),s=r.findIndex(e=>e.startsWith("--max-semi-space-size=")),t=(-1!==s?Number(r[s].split("=")[1]):hvigor_config_reader_js_1.defaultOptions.maxSemiSpaceSize)!==hvigor_config_reader_js_1.HvigorConfigReader.getMaxSemiSpaceSize(!0),_=r.findIndex(e=>e.startsWith("--expose-gc")),c=-1!==_?null===(o=null===(e=hvigor_config_reader_js_1.HvigorConfigReader.getHvigorConfig())||void 0===e?void 0:e.nodeOptions)||void 0===o?void 0:o.exposeGC:hvigor_config_reader_js_1.defaultOptions.exposeGC,d=-1===_&&!1!==c||-1!==_&&!1===c,a=process.execArgv.some(e=>e===const_js_1.ENABLE_SOURCE_MAPS),g=hvigor_config_reader_js_1.HvigorConfigReader.getStacktrace(!0);(n||t||d||a!==g)&&(_log.debug(`Worker ${cluster_1.default.worker.id} detected changes in 'hvigor-config.json5' nodeOptions.maxOldSpaceSize or maxSemiSpaceSize\n        or exposeGC or debugging.stacktrace. Path ${path_1.default} changed. Will exit and start another worker process.`),cluster_1.default.worker.isConnected()&&(_log.debug("worker isConnected start disconnect"),cluster_1.default.worker.disconnect(),cluster_1.default.worker.kill()))}function addConfigDeps(){const e=getModuleDependencies(hvigorFiles).filter(e=>{const o=path_1.default.relative(path_const_js_1.HVIGOR_USER_HOME,e);return!(o&&!o.startsWith("..")&&path_1.default.isAbsolute(o)&&!e.includes("hvigorfile.ts")&&!e.includes("hvigorconfig.ts"))});cluster_1.default.isWorker&&(_log.debug("watch files:",e),watcher.add(e))}function addModuleDependency(e){hvigorFiles.includes(e)||hvigorFiles.push(e)}function setRunning(e){isRunning=e}function getModuleDependencies(e){const o=e.map(e=>require.resolve(e));return e.forEach(e=>{const r=require.resolve(e),i=require.cache[r];void 0!==i&&traverseDependencies(i,o)}),o}function traverseDependencies(e,o){e.children.forEach(e=>{o.includes(e.filename)||(o.push(e.filename),traverseDependencies(e,o))})}cluster_1.default.isWorker&&(watcher=(0,chokidar_1.watch)([],{usePolling:(0,hvigor_common_1.isWindows)(),interval:1e3}),watcher.on("change",e=>{const o=()=>{_log.debug(`worker ${cluster_1.default.worker.id} detected hvigorfile's dependency changed. Path ${e} changed. Will exit and start another worker process.`),cluster_1.default.worker.isConnected()&&(_log.debug("worker isConnected start disconnect"),cluster_1.default.worker.disconnect(),cluster_1.default.worker.kill())};isRunning?(hvigor_process_js_1.hvigorProcess.once(event_id_options_js_1.HVIGOR_PROCESS_EVENT_ID.FINISHED,o),hvigor_process_js_1.hvigorProcess.once(event_id_options_js_1.HVIGOR_PROCESS_EVENT_ID.FAILED,o)):o()}),hvigorConfigWatcher=(0,chokidar_1.watch)([path_1.default.resolve(path_const_js_1.HVIGOR_PROJECT_WRAPPER_HOME,const_js_1.DEFAULT_HVIGOR_CONFIG_JSON_FILE_NAME)],{usePolling:(0,hvigor_common_1.isWindows)(),interval:1e3}),hvigorConfigWatcher.on("change",e=>{isRunning?(hvigor_process_js_1.hvigorProcess.once(event_id_options_js_1.HVIGOR_PROCESS_EVENT_ID.FINISHED,disconnectHvigorConfig),hvigor_process_js_1.hvigorProcess.once(event_id_options_js_1.HVIGOR_PROCESS_EVENT_ID.FAILED,disconnectHvigorConfig)):disconnectHvigorConfig()})),exports.addConfigDeps=addConfigDeps,exports.addModuleDependency=addModuleDependency,exports.setRunning=setRunning;