"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DaemonServerSocketListenerRegistry=void 0;const cluster_1=__importDefault(require("cluster")),process_1=__importDefault(require("process")),util_1=__importDefault(require("util")),hvigor_config_loader_js_1=require("../../../common/util/hvigor-config-loader.js"),build_event_js_1=require("../../common/daemon-protocol/build-event.js"),common_enum_js_1=require("../../common/daemon-protocol/common-enum.js"),message_js_1=require("../../common/daemon-protocol/message.js"),global_core_parameters_js_1=require("../../internal/data/global-core-parameters.js"),global_data_js_1=require("../../internal/data/global-data.js"),event_id_options_js_1=require("../../internal/lifecycle/event/event-id-options.js"),hvigor_log_js_1=require("../../log/hvigor-log.js"),check_hvigor_config_before_program_js_1=require("../../util/check-hvigor-config-before-program.js"),time_util_js_1=require("../../util/time-util.js"),worker_process_event_id_js_1=require("../cluster/worker-process-event-id.js"),hvigor_daemon_log_js_1=require("../log/hvigor-daemon-log.js"),daemon_process_lifecycle_js_1=require("../process/daemon-process-lifecycle.js"),daemon_info_js_1=require("../registry/daemon-info.js"),hvigor_daemon_server_js_1=require("../server/hvigor-daemon-server.js"),session_manager_js_1=require("../session/session-manager.js");class DaemonServerSocketListenerRegistry{constructor(e){this._log=hvigor_daemon_log_js_1.HvigorDaemonLogger.getLogger("daemon"),this.socket=e}registryBaseListener(e){this.onStartBuild(e),this.onCancel(),this.onStop(),this.onError(),this.onDisconnected(e)}onStartBuild(e){this.socket.on(build_event_js_1.BuildEvent.COMMON_BUILD,async s=>{var t,o;if(!s){const e="hvigor daemon: Received client exception type information. Empty build arguments.";return void this.socket.emit(build_event_js_1.BuildEvent.BUILD_STATUS,(0,message_js_1.createBuildStatus)(common_enum_js_1.BuildStatus.REJECT,-1,e))}const r=process_1.default.hrtime(),i=s,_=(0,check_hvigor_config_before_program_js_1.checkHvigorConfigBeforeProgram)(i,this._log);_.result||this.socket.emit(build_event_js_1.BuildEvent.BUILD_STATUS,(0,message_js_1.createBuildStatus)(common_enum_js_1.BuildStatus.REJECT,-1,null!==(t=_.stack)&&void 0!==t?t:_.message));try{(0,global_data_js_1.initStartData)(i)}catch(e){return this._log.error(e),void this.socket.emit(build_event_js_1.BuildEvent.BUILD_STATUS,(0,message_js_1.createBuildStatus)(common_enum_js_1.BuildStatus.REJECT,-1,null!==(o=e.stack)&&void 0!==o?o:e.message))}if((0,hvigor_log_js_1.evaluateLogLevel)(global_core_parameters_js_1.coreParameter.startParams.logLevel,["daemon"]),session_manager_js_1.defaultSessionManager.getActiveSocket()&&(0,daemon_process_lifecycle_js_1.getCurrentProcessState)()!==daemon_info_js_1.DaemonState.HALF_BUSY||(0,daemon_process_lifecycle_js_1.getCurrentProcessState)()===daemon_info_js_1.DaemonState.STOP_REQ||(0,daemon_process_lifecycle_js_1.getCurrentProcessState)()===daemon_info_js_1.DaemonState.BUSY){const e="hvigor daemon: Current process status is busy, cannot start a build action. Please wait a moment and retry.";return this._log.error(e),void this.socket.emit(build_event_js_1.BuildEvent.BUILD_STATUS,(0,message_js_1.createBuildStatus)(common_enum_js_1.BuildStatus.REJECT,0,e))}session_manager_js_1.defaultSessionManager.setActiveSocket(this.socket),(0,daemon_process_lifecycle_js_1.getCurrentProcessState)()===daemon_info_js_1.DaemonState.HALF_BUSY&&(0,daemon_process_lifecycle_js_1.setCurrentProcessState)(daemon_info_js_1.DaemonState.STOP_REQ),this._log.debug("hvigor daemon: Receive data from client."),this._log.debug("hvigor daemon: Build start."),(0,daemon_process_lifecycle_js_1.getCurrentProcessState)()===daemon_info_js_1.DaemonState.STOP_REQ&&(0,daemon_process_lifecycle_js_1.setCurrentProcessState)(daemon_info_js_1.DaemonState.BUSY);const{exitCode:n,reason:a}=await this.awaitBuildResult(i);(0,daemon_process_lifecycle_js_1.resetProcessTimeOutTimer)(e),(0,daemon_process_lifecycle_js_1.getCurrentProcessState)()===daemon_info_js_1.DaemonState.BUSY&&(0,daemon_process_lifecycle_js_1.setCurrentProcessState)(daemon_info_js_1.DaemonState.HALF_BUSY),this._log.debug(`hvigor daemon: Build end. endTime=${(0,time_util_js_1.formatTime)(process_1.default.hrtime(r))}`),this.clearCache(),this.socket.emit(build_event_js_1.BuildEvent.BUILD_STATUS,(0,message_js_1.createBuildStatus)(common_enum_js_1.BuildStatus.FINISH,n,a))})}async getWorker(){let e=Object.values(cluster_1.default.workers)[0];return e&&e.isConnected()&&!e.isDead()||(this._log.debug("hvigor daemon: no worker before build. Build after starting a new worker process."),e=cluster_1.default.fork(),e.process.stdout.pipe(process_1.default.stdout),e.process.stderr.pipe(process_1.default.stderr),await new Promise(s=>{null==e||e.once("online",s)})),e}async awaitBuildResult(e){let[s,t]=[0,void 0];if(!cluster_1.default.isPrimary)return{exitCode:s,reason:t};const o=await this.getWorker();return await new Promise(r=>{session_manager_js_1.defaultSessionManager.bindProcess(this.socket.id,o.id);const i=e=>{if(e.type){if(e.type===worker_process_event_id_js_1.WORKER_PROCESS_EVENT_ID.FINISHED)s=0,this._log.debug(`hvigor daemon: worker process ${o.process.pid} finished. Build Finished.`);else{if(e.type!==worker_process_event_id_js_1.WORKER_PROCESS_EVENT_ID.FAILED)return;s=-1,this._log.debug(`hvigor daemon: worker process ${o.process.pid} finished. Build Failed.`),t=e.content}o.off("exit",_),o.off("message",i),r()}},_=(e,t)=>{this._log.debug(`hvigor daemon: worker process ${o.process.pid} exit (${e||t}). Build Failed.`),s=e,o.off("message",i),r()};o.on("message",i),o.once("exit",_),o.send({type:build_event_js_1.BuildEvent.COMMON_BUILD,content:e})}),{exitCode:s,reason:t}}onCancel(){this.socket.on(build_event_js_1.BuildEvent.CANCEL_BUILD,e=>{if(!e)return void this.handleClientMsgError(e);const s=e;this._log.info(util_1.default.format(s)),this.stopTask(),this.clearCache(),this.socket.emit(common_enum_js_1.BuildStatus.CLOSE,(0,message_js_1.createBuildStatus)(common_enum_js_1.BuildStatus.CLOSE,0)),session_manager_js_1.defaultSessionManager.resetActiveSocket()})}onStop(){this.socket.on(build_event_js_1.BuildEvent.STOP_DAEMON,e=>{if(!e)return void this.handleClientMsgError(e);const s=e;this._log.info(util_1.default.format(s)),this.clearCache(),process_1.default.exit()})}onError(){this.socket.on("error",e=>{this._log.error("error",e),this.stopTask(),this.clearCache()})}onDisconnected(e){this.socket.on("disconnect",s=>{this._log.debug("hvigor disconnect: ",s),this.stopTask(),this.clearCache(),e.emit(hvigor_daemon_server_js_1.DaemonServerEventName.CLOSE_CONNECTION,this.socket)})}stopTask(){var e;(null===(e=session_manager_js_1.defaultSessionManager.getActiveSocket())||void 0===e?void 0:e.id)===this.socket.id&&session_manager_js_1.defaultSessionManager.postMessageToThread(this.socket.id,{type:event_id_options_js_1.HVIGOR_PROCESS_EVENT_ID.FAILED,reason:"Manually stop by user."}),session_manager_js_1.defaultSessionManager.postMessageToThread(this.socket.id,{type:build_event_js_1.WatchEvent.CLOSE_WATCH})}clearCache(){hvigor_config_loader_js_1.HvigorConfigLoader.clean(),hvigor_log_js_1.HvigorLogger.clean()}handleClientMsgError(e){this._log.warn("Received client exception type information."),this._log.warn(`receive client message: ${util_1.default.format(e)}`)}}exports.DaemonServerSocketListenerRegistry=DaemonServerSocketListenerRegistry;