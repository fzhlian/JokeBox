"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.buildTaskGraph=void 0;const hvigor_log_js_1=require("../../log/hvigor-log.js"),task_directed_acyclic_graph_js_1=require("../task/core/task-directed-acyclic-graph.js"),task_path_util_js_1=require("../task/util/task-path-util.js"),_log=hvigor_log_js_1.HvigorLogger.getLogger("hvigor-build-task-graph"),taskPathCache=new Map;function buildTaskGraph(a){a.getSubModules().forEach(a=>buildGraph(a,a.getTaskPaths(),a.getTaskGraph())),buildGraph(a,a.getTaskPaths(),a.getTaskGraph());const{hasCircle:t,circlePath:e}=task_directed_acyclic_graph_js_1.projectTaskDag.checkCircle();t&&_log.printErrorExit("CIRCULAR_DEPENDENCY",[e.join(" -> ")])}function buildGraph(a,t,e){const r=a.getProject().getSubModules();t.forEach(t=>{const{moduleName:s,taskName:i}=parseTaskPathWithCache(t);if(void 0!==(""===s?a.getProject():r.get(s)))for(const s of a.getTaskDepends(i)){const{moduleName:i,taskName:o}=parseTaskPathWithCache(s),c=""===i?a.getProject():r.get(i);if(void 0===c)return void _log.printErrorExit("CANNOT_FIND_HVIGOR_DEPEND_NODE",[i,o]);c.hasTask(o)||_log.printErrorExit("CANNOT_FIND_HVIGOR_TASK",[o,i,t]),e.addEdge(t,s),task_directed_acyclic_graph_js_1.projectTaskDag.addEdge(t,s)}else _log.printErrorExit("CANNOT_FIND_HVIGOR_NODE",[s,t])})}exports.buildTaskGraph=buildTaskGraph;const parseTaskPathWithCache=a=>{let t=taskPathCache.get(a);return void 0!==t||(t=(0,task_path_util_js_1.parseTaskPath)(a),taskPathCache.set(a,t)),t};