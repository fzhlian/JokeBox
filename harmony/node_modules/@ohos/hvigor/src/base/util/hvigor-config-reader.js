"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HvigorConfigReader=exports.defaultOptions=void 0;const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),process_1=__importDefault(require("process")),const_js_1=require("../../common/const/const.js"),path_const_js_1=require("../../common/const/path-const.js"),hvigor_config_loader_js_1=require("../../common/util/hvigor-config-loader.js"),json5_reader_js_1=require("./json5-reader.js");exports.defaultOptions={maxOldSpaceSize:8192,maxSemiSpaceSize:16,exposeGC:!0};class HvigorConfigReader extends json5_reader_js_1.Json5Reader{static getHvigorConfig(){const e=path_1.default.resolve(path_const_js_1.HVIGOR_PROJECT_WRAPPER_HOME,const_js_1.DEFAULT_HVIGOR_CONFIG_JSON_FILE_NAME);if(!fs_1.default.existsSync(e))return;const t=this.getJson5Obj(e),i=path_1.default.resolve(path_const_js_1.HVIGOR_USER_HOME,const_js_1.DEFAULT_HVIGOR_CONFIG_JSON_FILE_NAME);let r;return fs_1.default.existsSync(i)&&(r=this.getJson5Obj(i),t.properties={...r.properties,...t.properties}),t}static getBuildParamFilePath(){const e=path_1.default.resolve(path_const_js_1.HVIGOR_PROJECT_WRAPPER_HOME,const_js_1.DEFAULT_HVIGOR_CONFIG_JSON_FILE_NAME);if(!fs_1.default.existsSync(e))return;const t=this.getJson5Obj(e);if(t.parameterFile)return HvigorConfigReader.normalizeParameterFilePath(t.parameterFile,path_const_js_1.HVIGOR_PROJECT_WRAPPER_HOME);const i=path_1.default.resolve(path_const_js_1.HVIGOR_USER_HOME,const_js_1.DEFAULT_HVIGOR_CONFIG_JSON_FILE_NAME);if(!fs_1.default.existsSync(i))return;return this.getJson5Obj(i).parameterFile?HvigorConfigReader.normalizeParameterFilePath(t.parameterFile,path_const_js_1.HVIGOR_USER_HOME):void 0}static normalizeParameterFilePath(e,t){if(!path_1.default.isAbsolute(e))return path_1.default.resolve(t,e)}static getPropertiesConfigValue(e){return hvigor_config_loader_js_1.HvigorConfigLoader.getInstance().getPropertiesConfigValue(e)}static getMaxOldSpaceSize(e=!1){var t,i,r,a;const o=process_1.default.argv.find(e=>e.startsWith(this.maxOldSpaceSizeParamPrefiex)),s=Number(null!==(t=null==o?void 0:o.slice((null==o?void 0:o.indexOf("="))+1))&&void 0!==t?t:""),n=null===(r=null===(i=HvigorConfigReader.getHvigorConfig())||void 0===i?void 0:i.nodeOptions)||void 0===r?void 0:r.maxOldSpaceSize,_=process_1.default.execArgv.find(e=>e.startsWith(this.maxOldSpaceSizeParamPrefiex)),l={argv:s,config:n,execArgv:Number(null!==(a=null==_?void 0:_.slice((null==_?void 0:_.indexOf("="))+1))&&void 0!==a?a:""),default:exports.defaultOptions.maxOldSpaceSize};return this.getPriorVal(l,e)}static getStacktrace(e=!1){var t,i,r;const a=[...process_1.default.argv].reverse().find(e=>e===this.STACK_TRACE||e===this.NO_STACK_TRACE),o=a===this.STACK_TRACE||a!==this.NO_STACK_TRACE&&void 0,s=null===(i=null===(t=HvigorConfigReader.getHvigorConfig())||void 0===t?void 0:t.debugging)||void 0===i?void 0:i.stacktrace,n=!1;return e?null!=s?s:n:null!==(r=null!=o?o:s)&&void 0!==r?r:n}static getMaxSemiSpaceSize(e=!1){var t,i,r,a;const o=process_1.default.argv.find(e=>e.startsWith(this.maxSemiSpaceSizeParamPrefiex)),s=Number(null!==(t=null==o?void 0:o.slice((null==o?void 0:o.indexOf("="))+1))&&void 0!==t?t:""),n=null===(r=null===(i=HvigorConfigReader.getHvigorConfig())||void 0===i?void 0:i.nodeOptions)||void 0===r?void 0:r.maxSemiSpaceSize,_=process_1.default.execArgv.find(e=>e.startsWith(this.maxSemiSpaceSizeParamPrefiex)),l={argv:s,config:n,execArgv:Number(null!==(a=null==_?void 0:_.slice((null==_?void 0:_.indexOf("="))+1))&&void 0!==a?a:""),default:exports.defaultOptions.maxSemiSpaceSize};return this.getPriorVal(l,e)}static getNodeParamFromProcessArgv(){const e=[];for(const t of[this.maxOldSpaceSizeParamPrefiex,this.maxSemiSpaceSizeParamPrefiex]){const i=process_1.default.argv.find(e=>e.startsWith(t));i&&e.push(i)}return e}static getPriorVal(e,t){return t?e.config||e.default:e.argv||e.config||e.execArgv||e.default}}exports.HvigorConfigReader=HvigorConfigReader,HvigorConfigReader.maxOldSpaceSizeParamPrefiex="--max-old-space-size=",HvigorConfigReader.maxSemiSpaceSizeParamPrefiex="--max-semi-space-size=",HvigorConfigReader.STACK_TRACE="--stacktrace",HvigorConfigReader.NO_STACK_TRACE="--no-stacktrace";